<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Group Chat</title>
    <!-- ✅ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        :root {
            --bg-primary: #111b21;
            --bg-secondary: #0b141a;
            --bg-chat: #0b141a;
            --bg-input: #2a3942;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --bubble-sent: #005c4b;
            --bubble-received: #202c33;
            --border-color: #2a3942;
            --accent: #00a884;
            --header-bg: #202c33;
            --header-text: #e9edef;
            --font-size: 14px;
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-chat: #efeae2;
            --bg-input: #ffffff;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --bubble-sent: #d9fdd3;
            --bubble-received: #ffffff;
            --border-color: #d1d7db;
            --accent: #00a884;
            --header-bg: #008069;
            --header-text: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        input,
        textarea,
        button,
        select {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
        }

        /* Loader Animation */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
            /* ✅ Smooth fade */
        }

        .loader-container.hidden {
            display: none;
            opacity: 0;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Desktop/Tablet Block */
        .device-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            text-align: center;
        }

        .device-warning.active {
            display: flex;
        }

        .warning-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .warning-title {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .warning-text {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Fingerprint Scanner */
        .fingerprint-section {
            margin: 20px 0;
            text-align: center;
        }

        .fingerprint-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #00d9a8 100%);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0, 168, 132, 0.3);
        }

        .fingerprint-button:active {
            transform: scale(0.95);
        }

        .fingerprint-button svg {
            width: 60px;
            height: 60px;
            fill: white;
        }

        .fingerprint-status {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            background: var(--bg-primary);
            overflow-y: auto;
            transition: opacity 0.2s ease;
            /* ✅ Smooth fade */
        }

        .auth-container.hidden {
            display: none !important;
            opacity: 0;
        }

        .auth-box {
            background: var(--bg-secondary);
            padding: 100px 30px 70px 30px !important;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            text-align: center;
            margin-top: 180px;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: var(--accent);
            font-size: 24px;
            margin-bottom: 5px;
        }

        .profile-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            border: 3px solid var(--accent);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-btn {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            background: var(--header-bg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .group-info h2,
        .group-info p {
            color: var(--header-text);
        }

        .group-info h2 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .group-info p {
            font-size: 13px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle,
        .profile-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: var(--header-text);
        }

        .profile-icon img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 10px 70px 10px;
            -webkit-overflow-scrolling: touch;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* ✅ Fixed position */
            background-attachment: scroll;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
        }

        [data-theme="light"] .messages-area {
            background-color: #e5ddd5;
        }

        [data-theme="light"] .date-badge {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-date {
            text-align: center;
            position: sticky;
            margin-top: 0px 0px 0px 0px;
            top: -20px;
            z-index: 10;
            padding: 0px 0px;
            background: transparent;
        }

        .date-badge {
            display: inline-block;
            background: rgba(42, 57, 66, 0.95);
            backdrop-filter: blur(10px);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            font-weight: 500;
        }


        .message {
            display: flex;
            margin-bottom: 8px;
            position: relative;
        }

        .message.sent {
            justify-content: flex-end;
            z-index: 2;
        }

        .message.received {
            justify-content: flex-start;
            z-index: 2;
        }

        .message-content {
            display: flex;
            gap: 8px;
            max-width: 75%;
            position: relative;
        }

        .message.sent .message-content {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.sent .message-avatar {
            display: none;
        }

        .message-bubble {
            background: var(--bubble-received);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            user-select: none;
            position: relative;
            max-width: 100%;
        }

        .message.sent .message-bubble {
            background: var(--bubble-sent);
            border-radius: 8px 0 8px 8px;
        }

        .message.received .message-bubble {
            border-radius: 0 8px 8px 8px;
        }

        .message-sender {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 3px;
        }

        .message-text {
            font-size: var(--font-size);
            color: var(--text-primary);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message-text a {
            color: #53bdeb;
            text-decoration: underline;
        }

        .message-text.deleted {
            font-style: italic;
            color: #8696a0;
            font-size: 13px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
        }

        .reply-preview {
            background: rgba(0, 168, 132, 0.15);
            border-left: 3px solid var(--accent);
            padding: 5px 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .reply-name {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 12px;
        }

        .reply-text {
            color: var(--text-secondary);
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-reactions {
            display: flex;
            gap: 3px;
            margin-top: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 5px 0;
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .context-menu-item:hover {
            background: var(--bg-input);
        }

        .context-menu-item.delete {
            color: #dc3545;
        }

        .copy-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            font-size: 14px;
            animation: slideDown 0.3s ease;
        }

        .copy-toast.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .reaction-viewer-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .reaction-viewer-title {
            font-size: 16px;
            font-weight: 600;
        }

        .reaction-viewer-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
        }

        .reaction-viewer-content {
            padding: 10px;
        }

        .reaction-group {
            margin-bottom: 15px;
        }

        .reaction-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .reaction-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
        }

        .reaction-user:hover {
            background: var(--bg-input);
        }

        .reaction-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .reaction-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .members-sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: var(--bg-secondary);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            z-index: 200;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .members-sidebar.active {
            left: 0;
        }

        .members-header {
            background: var(--header-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .members-header h3 {
            color: var(--header-text);
            font-size: 18px;
        }

        .members-close {
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 24px;
            cursor: pointer;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 10px 50px 10px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .member-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .input-area {
            background: var(--bg-secondary);
            padding: 8px 10px;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            flex-shrink: 0;
            flex-direction: column;
            z-index: 3;
        }

        .reply-bar {
            background: var(--bg-input);
            padding: 8px 12px;
            display: none;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid var(--accent);
            width: 100%;
            border-radius: 8px;
        }

        .reply-bar.active {
            display: flex;
        }

        .input-row {
            display: flex;
            gap: 8px;
            width: 100%;
            align-items: center;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            background: var(--bg-input);
            border-radius: 25px;
            padding: 8px 12px;
            align-items: center;
            gap: 8px;
            max-height: 150px;
        }

        .user-avatar-input {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            cursor: pointer;
            overflow: hidden;
        }

        .user-avatar-input img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 2px solid var(--accent);
            border-radius: 50%;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
        }

        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        .profile-page {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-primary);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            z-index: 100;
            overflow-y: auto;
        }

        .profile-page.active {
            display: flex;
        }

        .profile-header {
            background: var(--header-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 24px;
            cursor: pointer;
        }

        .profile-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 40px 20px;
        }

        .profile-section {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .wallpaper-upload {
            margin-bottom: 15px;
        }

        .upload-wallpaper-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .wallpaper-item {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .wallpaper-item.active {
            border-color: var(--accent);
        }

        .wallpaper-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .font-size-btn {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
        }

        .font-size-value {
            font-size: 16px;
            color: var(--text-primary);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 0px 20px;
            color: var(--text-secondary);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .message-content {
                max-width: 85%;
            }

            .messages-area {
                padding-bottom: 120px;
            }

            .emoji-picker {
                max-width: 90%;
            }
        }

        @media (max-width: 580px) {
            .messages-area {
                padding-bottom: 130px;
            }
        }

        @media (max-width: 480px) {
            .messages-area {
                padding-bottom: 130px;
            }
        }

        .password-section {
            display: none;
            margin: 20px 0;
        }

        .password-section.active {
            display: block;
        }

        .password-section .form-group {
            margin-bottom: 15px;
        }

        .password-section label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .password-section input {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* ============ MESSAGE STATUS ICONS ============ */
        .message-status {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            margin-left: 5px;
            font-size: 14px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .status-clock {
            color: #8696a0;
            animation: clockRotate 0.9s ease;
        }

        .status-tick-single {
            color: #8696a0 !important;
            animation: tickFadeIn 0.9s ease;
        }

        .status-tick-double {
            color: #8696a0 !important;
            animation: tickFadeIn 0.9s ease;
        }

        .status-tick-double.read {
            color: #53bdeb !important;
            animation: blueTickPop 0.9s ease;
        }

        @keyframes clockRotate {
            from {
                opacity: 0;
                transform: rotate(-180deg) scale(0.5);
            }

            to {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
        }

        @keyframes tickFadeIn {
            from {
                opacity: 0;
                transform: rotate(-180deg) scale(0.5);
            }

            to {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
        }

        @keyframes blueTickPop {
            0% {
                transform: scale(1);
                color: #8696a0;
            }

            50% {
                transform: scale(1.4);
                color: #53bdeb;
            }

            100% {
                transform: scale(1);
                color: #53bdeb;
            }
        }
    </style>
</head>

<body data-theme="dark">

    <!-- Device Warning -->
    <div id="deviceWarning" class="device-warning">
        <div class="warning-icon">📱</div>
        <div class="warning-title">Mobile Only</div>
        <div class="warning-text">This project is only for mobile devices.</div>
    </div>

    <!-- Loader -->
    <div id="loaderContainer" class="loader-container hidden">
        <div class="loader"></div>
        <div class="loader-text">Verifying account...</div>
    </div>

    <!-- Signup Page -->
    <div id="signupPage" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-header">
                <h1>📚 Class Group Chat</h1>
                <p>Create your account</p>
            </div>
            <form id="signupForm">
                <div class="profile-upload">
                    <div class="profile-preview" id="signupPhotoPreview">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                    </div>
                    <input type="file" id="signupPhotoInput" accept="image/*" style="display: none;">
                    <button type="button" class="upload-btn"
                        onclick="document.getElementById('signupPhotoInput').click()">Upload Photo</button>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signupName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="signupPhone" required>
                </div>
                <div class="form-group">
                    <label>Roll Number</label>
                    <input type="text" id="signupRollNo" required>
                </div>
                <div class="form-group">
                    <label>Security Code</label>
                    <input type="text" id="signupCode" required placeholder="Enter class code">
                </div>
                <!-- Password Section (Fallback for unsupported browsers) -->
                <div class="password-section" id="passwordSection">
                    <div class="form-group">
                        <label>Create Password</label>
                        <input type="password" id="signupPassword" placeholder="Enter your password" minlength="6">
                    </div>
                </div>

                <!-- Fingerprint Section -->
                <div class="fingerprint-section">
                    <button type="button" class="fingerprint-button" id="fingerprintBtn" onclick="scanFingerprint()">
                        <svg viewBox="0 0 24 24">
                            <path fill="white"
                                d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94 1.7 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z" />
                        </svg>
                    </button>
                    <div class="fingerprint-status" id="fingerprintStatus">Tap to scan fingerprint</div>
                </div>

                <button type="submit" class="btn-primary" id="signupBtn" disabled>Sign Up</button>
            </form>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <div class="header-left" onclick="toggleMembersSidebar()">
                <div class="group-avatar">CG</div>
                <div class="group-info">
                    <h2>Class Group</h2>
                    <p id="onlineCount">Loading...</p>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-toggle" onclick="toggleTheme()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </div>
                <div class="profile-icon" onclick="showProfile()">
                    <img id="headerProfilePhoto" src="" alt="Profile">
                </div>
            </div>
        </div>

        <div class="messages-area" id="messagesArea">
            <div class="loading">Loading messages...</div>
        </div>

        <div class="input-area">
            <div class="reply-bar" id="replyBar">
                <div>
                    <div class="reply-name" id="replyName"></div>
                    <div class="reply-text" id="replyText"></div>
                </div>
                <button onclick="cancelReply()"
                    style="background:none;border:none;color:var(--text-primary);cursor:pointer;">✕</button>
            </div>
            <div class="input-row">
                <div class="input-wrapper">
                    <div class="user-avatar-input" onclick="showProfile()">
                        <img id="inputProfilePhoto" src="" alt="You">
                    </div>
                    <textarea id="messageInput" placeholder="Type a message" rows="1"></textarea>
                </div>
                <button class="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Members Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMembersSidebar()"></div>
    <div class="members-sidebar" id="membersSidebar">
        <div class="members-header">
            <h3>Class Members</h3>
            <button class="members-close" onclick="toggleMembersSidebar()">×</button>
        </div>
        <div class="members-list" id="membersList">
            <div class="loading">Loading members...</div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="profile-page">
        <div class="profile-header">
            <button class="back-btn" onclick="hideProfile()">←</button>
            <h2 style="color: var(--header-text);">Profile</h2>
        </div>
        <div class="profile-content">
            <div class="profile-section">
                <div style="text-align:center;padding:20px 0;">
                    <div
                        style="width:150px;height:150px;border-radius:50%;margin:0 auto 20px;overflow:hidden;border:4px solid var(--accent);">
                        <img id="profilePhotoLarge" src="" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <input type="file" id="profilePhotoUpdate" accept="image/*" style="display:none;">
                    <button class="upload-btn" onclick="document.getElementById('profilePhotoUpdate').click()">Change
                        Photo</button>
                </div>
            </div>

            <div class="profile-section">
                <div style="padding:15px 0;border-bottom:1px solid var(--border-color);">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Name</div>
                    <div id="profileName" style="font-size:16px;">-</div>
                </div>
                <div style="padding:15px 0;border-bottom:1px solid var(--border-color);">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Email</div>
                    <div id="profileEmail" style="font-size:16px;">-</div>
                </div>
                <div style="padding:15px 0;">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Phone</div>
                    <div id="profilePhone" style="font-size:16px;">-</div>
                </div>
                <div style="padding:15px 0;">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Roll Number</div>
                    <div id="profileRollNo" style="font-size:16px;">-</div>
                </div>
            </div>

            <div class="profile-section">
                <div class="section-title">Chat Wallpaper</div>
                <div class="wallpaper-upload">
                    <input type="file" id="customWallpaperInput" accept="image/*" style="display:none;">
                    <button class="upload-wallpaper-btn"
                        onclick="document.getElementById('customWallpaperInput').click()">
                        📸 Upload Custom Wallpaper (1 Max)
                    </button>
                </div>
                <div class="wallpaper-grid" id="wallpaperGrid"></div>
            </div>

            <div class="profile-section">
                <div class="section-title">Font Size</div>
                <div class="font-size-control">
                    <button class="font-size-btn" onclick="changeFontSize(-1)">A-</button>
                    <span class="font-size-value" id="fontSizeDisplay">14px</span>
                    <button class="font-size-btn" onclick="changeFontSize(1)">A+</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Security Verification Page -->
    <div id="securityPage" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-header">
                <h1>🔐 Security Verification</h1>
                <p>Verify to continue</p>
            </div>

            <!-- Fingerprint Section (for users without password) -->
            <div id="fingerprintVerifySection" class="hidden">
                <div class="fingerprint-section">
                    <button type="button" class="fingerprint-button" onclick="verifyFingerprint()">
                        <svg viewBox="0 0 24 24">
                            <path fill="white"
                                d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94 1.7 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z" />
                        </svg>
                    </button>
                    <div class="fingerprint-status" id="fingerprintVerifyStatus">Tap to scan fingerprint</div>
                </div>
            </div>

            <!-- Password Section (for users with password) -->
            <div id="passwordVerifySection" class="hidden">
                <div class="form-group">
                    <label>Enter Password</label>
                    <input type="password" id="verifyPassword" placeholder="Enter your password">
                </div>
                <button type="button" class="btn-primary" onclick="verifyPassword()">Verify</button>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        const SECURITY_CODE = "Salik@Weber";
        const SAD_URL = "https://script.google.com/macros/s/AKfycbzDGlPNFhx9kNyf1cg5csL4ba1cYnvg8GN1C7MGFacdou5aMAL5U-5eP-G8fpcufXhT/exec";
        const SMD_URL = "https://script.google.com/macros/s/AKfycbwjW2PwdcFGZULOBHYem8hVQ2YK3dKCiyaKZt2kOdVOwXS8Zl1zp2werZSCtZzWE359/exec";
        const MAX_CUSTOM_WALLPAPERS = 1;

        // ============ WALLPAPERS ============
        const DEFAULT_WALLPAPER = 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
        const WALLPAPERS = [
            { name: 'Wallpeper 2', url: 'https://w0.peakpx.com/wallpaper/457/910/HD-wallpaper-whatsapp-black-patterns-dark.jpg' },
            { name: 'Wallpeper 3', url: 'https://i.pinimg.com/236x/cd/0a/36/cd0a36a8cecd3c7185c35450cc98b66f.jpg' },
            { name: 'Dark Mountains', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80' },
            { name: 'Neon Lights', url: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=800&q=80' },
            { name: 'Ocean Blue', url: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=800&q=80' },
            { name: 'Galaxy Stars', url: 'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=800&q=80' },
            { name: 'Sunset Sky', url: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80' },
            { name: 'Forest Green', url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800&q=80' },
            { name: 'Pink Clouds', url: 'https://images.unsplash.com/photo-1557672172-298e090bd0f1?w=800&q=80' },
            { name: 'Aurora Night', url: 'https://images.unsplash.com/photo-1531366936337-7c912a4589a7?w=800&q=80' },
            { name: 'Desert Sand', url: 'https://images.unsplash.com/photo-1509316785289-025f5b846b35?w=800&q=80' },
            { name: 'Lavender Dream', url: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=800&q=80' },
            { name: 'Starry Night', url: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=800&q=80' },
            { name: 'Cherry Blossom', url: 'https://images.unsplash.com/photo-1522383225653-ed111181a951?w=800&q=80' },
            { name: 'Tropical Beach', url: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=800&q=80' },
            { name: 'Mountain Lake', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80' },
            { name: 'Colorful Smoke', url: 'https://images.unsplash.com/photo-1553356084-58ef4a67b2a7?w=800&q=80' },
            { name: 'Autumn Leaves', url: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800&q=80' },
            { name: 'Deep Ocean', url: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=800&q=80' }
        ];

        function applySettings() {
            const wallpaper = localStorage.getItem('chatWallpaper');

            // ✅ If no wallpaper saved, use default
            if (!wallpaper || wallpaper === 'none') {
                document.getElementById('messagesArea').style.backgroundImage = `url(${DEFAULT_WALLPAPER})`;
                localStorage.setItem('chatWallpaper', DEFAULT_WALLPAPER);
            } else {
                document.getElementById('messagesArea').style.backgroundImage = `url(${wallpaper})`;
            }

            const fontSize = localStorage.getItem('fontSize');
            if (fontSize) {
                document.documentElement.style.setProperty('--font-size', fontSize + 'px');
                document.getElementById('fontSizeDisplay').textContent = fontSize + 'px';
            }

            const theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
        }

        // ============ STATE MANAGEMENT ============
        let currentUser = null;
        let refreshInterval = null;
        let selectedMessage = null;
        let replyToMessage = null;
        let lastMessageCount = 0;
        let isSending = false;
        let allUsers = {};
        let currentMessages = [];
        let fingerprintVerified = false;
        let lastScrollPosition = 0;
        let customWallpaperCount = 0;
        let lastMessageSentTime = 0;
        let isFirstMessage = true;
        let pendingMessageId = null;
        let serverDate = null;
        let dateOffset = 0;
        // ============ SOUND EFFECTS ============
        const sendSound = new Audio('https://cdn.freesound.org/previews/720/720277_7037-lq.mp3');
        const receiveSound = new Audio('https://cdn.freesound.org/previews/720/720280_7037-lq.mp3');
        sendSound.volume = 0.7;
        receiveSound.volume = 0.7;

        let lastReceivedMessageCount = 0; // Track received messages


        // ============ FETCH REAL DATE FROM API ============
        async function fetchRealDate() {
            try {
                // WorldTimeAPI se India time fetch karo
                const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Kolkata');
                const data = await response.json();

                serverDate = new Date(data.datetime);
                const localDate = new Date();

                // Calculate offset between server and local time
                dateOffset = serverDate.getTime() - localDate.getTime();

                console.log('✅ Real Server Date:', serverDate.toLocaleString());
                console.log('📅 Local Date:', localDate.toLocaleString());
                console.log('⏰ Offset:', Math.round(dateOffset / 1000), 'seconds');

                return serverDate;
            } catch (error) {
                console.error('❌ Date API Error:', error);
                // Fallback to local date if API fails
                return new Date();
            }
        }

        // Get current date (with server sync)
        function getCurrentDate() {
            if (dateOffset !== 0) {
                return new Date(Date.now() + dateOffset);
            }
            return new Date();
        }

        // ============ EMOJIS ============
        const REACTION_EMOJIS = ['❤️', '😂', '😮', '😢', '🙏', '👍', '👎', '🔥', '🎉', '😍', '😡', '💯', '✅', '❌'];

        // // ============ DEVICE CHECK ============
        function checkDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const currentHost = window.location.hostname;

            // Allow localhost/127.0.0.1 to bypass device check
            if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                return true;
            }

            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const isTablet = /ipad|android/i.test(userAgent) && !/mobile/i.test(userAgent);
            const screenWidth = window.innerWidth;

            if (!isMobile || isTablet || screenWidth > 768) {
                document.getElementById('deviceWarning').classList.add('active');
                return false;
            }
            return true;
        }

        // ============ UPDATED FINGERPRINT BIOMETRIC AUTHENTICATION ============
        // Simulates verification on localhost (http://127.0.0.1:5500) with an alert, uses real biometric scanner on HTTPS
        // Replace the existing scanFingerprint() with this improved version
        async function scanFingerprint() {
            const btn = document.getElementById('fingerprintBtn');
            const status = document.getElementById('fingerprintStatus');
            const signupBtn = document.getElementById('signupBtn');
            const passwordSection = document.getElementById('passwordSection');
            const currentHost = window.location.hostname;
            const isLocalhost = currentHost === 'localhost' || currentHost === '127.0.0.1';

            btn.disabled = true;
            status.textContent = 'Scanning fingerprint...';
            btn.style.transform = 'scale(0.95)';

            try {
                if (isLocalhost) {
                    // Local simulation (dev)
                    await new Promise(res => setTimeout(res, 800));
                    status.textContent = '✅ Fingerprint verified (simulated)';
                    status.style.color = 'var(--accent)';
                    fingerprintVerified = true;
                    signupBtn.disabled = false;
                    btn.style.background = 'linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%)';
                    return;
                }

                // Ensure WebAuthn available
                if (!window.PublicKeyCredential) {
                    throw new Error('Biometric authentication not supported in this browser.');
                }

                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                if (!available) {
                    throw new Error('No platform biometric authenticator available on this device.');
                }

                // Create random challenge and user id as ArrayBuffer
                const challenge = window.crypto.getRandomValues(new Uint8Array(32));
                const userId = window.crypto.getRandomValues(new Uint8Array(16));

                const publicKeyCreate = {
                    challenge: challenge.buffer,
                    rp: { name: "Class Group Chat" },
                    user: {
                        id: userId.buffer,
                        name: "student@" + window.location.hostname,
                        displayName: "Student"
                    },
                    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        userVerification: "required",
                        requireResidentKey: false
                    },
                    timeout: 60000,
                    attestation: "none"
                };

                try {
                    const credential = await navigator.credentials.create({ publicKey: publicKeyCreate });
                    if (credential) {
                        console.log('WebAuthn create credential:', credential);
                        status.textContent = '✅ Fingerprint verified';
                        status.style.color = 'var(--accent)';
                        fingerprintVerified = true;
                        signupBtn.disabled = false;
                        btn.style.background = 'linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%)';
                        return;
                    }
                } catch (createErr) {
                    console.warn('create() failed, trying get() as fallback:', createErr);
                }

                const publicKeyGet = {
                    challenge: window.crypto.getRandomValues(new Uint8Array(32)).buffer,
                    timeout: 60000,
                    userVerification: "required",
                };

                const assertion = await navigator.credentials.get({ publicKey: publicKeyGet });
                if (assertion) {
                    console.log('WebAuthn assertion:', assertion);
                    status.textContent = '✅ Fingerprint verified';
                    status.style.color = 'var(--accent)';
                    fingerprintVerified = true;
                    signupBtn.disabled = false;
                    btn.style.background = 'linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%)';
                    return;
                } else {
                    throw new Error('No credential returned by authenticator.');
                }

            } catch (err) {
                console.error('Biometric verification error:', err);
                status.textContent = '❌ Fingerprint not supported';
                status.style.color = '#ff4c4c';

                // 🔥 YE HAI TERA PASSWORD FALLBACK - 2 seconds baad show hoga
                setTimeout(() => {
                    passwordSection.classList.add('active');
                    status.textContent = '🔑 Use password instead';
                    fingerprintVerified = true; // Password mode enable
                    signupBtn.disabled = false;
                    btn.style.display = 'none'; // Fingerprint button hide
                }, 2000);

            } finally {
                btn.style.transform = 'scale(1)';
                btn.disabled = false;
            }
        }



        // ============ INITIALIZATION ============
        window.onload = function () {
            if (!checkDevice()) return;
            applySettings();
            setupEventListeners();
            checkAuth();
            loadCustomWallpaperCount();
        };

        // ============ 🔥 CLEAN CHECKAUTH - NO ISSUES ============
        async function checkAuth() {
            try {
                await fetchRealDate();
                const userDataString = localStorage.getItem('chatUser');
                const isBlocked = localStorage.getItem('blockedUser');
                const isVerified = sessionStorage.getItem('verified');

                // No user data - show signup
                if (!userDataString) {
                    hideLoader();
                    setTimeout(() => showSignup(), 30);
                    return;
                }

                const userData = JSON.parse(userDataString);
                if (!userData.name || !userData.email || !userData.phone) {
                    hideLoader();
                    setTimeout(() => showSignup(), 30);
                    return;
                }

                showLoader();

                // API call to check status
                const verifyUrl = `${SAD_URL}?action=verifyUser&name=${encodeURIComponent(userData.name)}&email=${encodeURIComponent(userData.email)}&phone=${encodeURIComponent(userData.phone)}&t=${Date.now()}`;

                try {
                    const res = await fetch(verifyUrl);
                    const data = await res.json();

                    hideLoader();

                    if (data.status === 'blocked') {
                        localStorage.setItem('blockedUser', 'true');
                        showBlockedScreen();
                        return;
                    }

                    if (data.status === 'active') {
                        localStorage.removeItem('blockedUser');
                        currentUser = userData;

                        // ✅ CHECK IF ALREADY VERIFIED IN THIS SESSION
                        if (isVerified === 'true') {
                            // Already verified - directly show chat
                            showChat();
                            loadWallpapers();
                            startStatusMonitoring();
                            startMessageRefresh();
                            loadOnlineCount();
                        } else {
                            // Not verified - show security verification
                            showSecurityVerification();
                        }
                        return;
                    }

                } catch (err) {
                    console.error('API Error:', err);
                    hideLoader();

                    if (isBlocked === 'true') {
                        showBlockedScreen();
                    } else {
                        currentUser = userData;

                        // Check session verification
                        if (isVerified === 'true') {
                            showChat();
                            loadWallpapers();
                            startMessageRefresh();
                            loadOnlineCount();
                            startStatusMonitoring();
                        } else {
                            showSecurityVerification();
                        }
                    }
                }

            } catch (err) {
                console.error("checkAuth Error:", err);
                hideLoader();
                setTimeout(() => showSignup(), 50);
            }
        }

        // 🔥 NEW: Blocked Screen Function
        function showBlockedScreen() {
            document.body.innerHTML = `
        <div style="background:#111; color:#ff4c4c; font-size:20px; display:flex; align-items:center; justify-content:center; height:100vh; text-align:center; flex-direction:column;">
            <div style="font-size:80px;">⛔</div>
            <p><strong>You are Blocked by Admin</strong></p>
        </div>`;
        }

        // ============ 🔥 ULTRA AGGRESSIVE MONITORING ============
        let statusCheckInterval = null;

        function startStatusMonitoring() {
            console.log('🟢 STATUS MONITORING STARTED');

            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }

            // ⚡ IMMEDIATE FIRST CHECK
            checkUserStatus();

            // 🔄 THEN CHECK EVERY 2 SECONDS
            statusCheckInterval = setInterval(checkUserStatus, 2000);
        }

        async function checkUserStatus() {
            if (!currentUser) return;

            try {
                const verifyUrl = `${SAD_URL}?action=verifyUser&name=${encodeURIComponent(currentUser.name)}&email=${encodeURIComponent(currentUser.email)}&phone=${encodeURIComponent(currentUser.phone)}&t=${Date.now()}`;

                const response = await fetch(verifyUrl);
                const data = await response.json();

                const isCurrentlyBlocked = localStorage.getItem('blockedUser') === 'true';

                console.log('🔍', new Date().toLocaleTimeString(), '→', data.status, '| Local:', isCurrentlyBlocked);

                // 🔴 BLOCK: active → blocked
                if (data.status === 'blocked' && !isCurrentlyBlocked) {
                    console.log('🔴 BLOCKING NOW!');
                    localStorage.setItem('blockedUser', 'true');
                    clearInterval(statusCheckInterval);
                    if (refreshInterval) clearInterval(refreshInterval);
                    showBlockedScreen();
                    return;
                }

                // ✅ UNBLOCK: blocked → active
                if (data.status === 'active' && isCurrentlyBlocked) {
                    console.log('✅ UNBLOCKING NOW!');
                    localStorage.removeItem('blockedUser');
                    clearInterval(statusCheckInterval);
                    if (refreshInterval) clearInterval(refreshInterval);

                    // Show alert
                    alert('✅ You have been unblocked by Admin!\n\nReloading chat...');

                    // Reload page
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                    return;
                }

            } catch (error) {
                console.error('❌ Check failed:', error);
            }
        }

        // ============ 🔥 MESSAGE REFRESH + STATUS MONITORING ============
        function startMessageRefresh() {
            console.log('📨 Message refresh started');

            // Initial load
            fetchMessages();
            fetchRealDate(); // ✅ Date bhi sync karo

            // Clear old interval
            if (refreshInterval) clearInterval(refreshInterval);

            // ✅ Refresh every 3 seconds
            refreshInterval = setInterval(() => {
                fetchMessages();
                loadOnlineCount();
            }, 2000);

            // ✅ Date sync every 5 minutes
            setInterval(() => {
                fetchRealDate();
            }, 300000); // 5 minutes

            startStatusMonitoring();
        }

        async function verifyAccountStatus(user) {
            try {
                const response = await fetch(`${SAD_URL}?action=verifyUser&name=${encodeURIComponent(user.name)}&email=${encodeURIComponent(user.email)}&phone=${encodeURIComponent(user.phone)}&rollNo=${encodeURIComponent(user.rollNo)}`);
                const data = await response.json();
                console.log('Verify User Response:', data); // Add this line for debugging
                return data.status === 'active';
            } catch (error) {
                console.error('Verification error:', error);
                return false;
            }
        }

        function showLoader() {
            document.getElementById('loaderContainer').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loaderContainer').classList.add('hidden');
        }

        async function loadOnlineCount() {
            try {
                const response = await fetch(`${SAD_URL}?action=getOnlineCount&t=${Date.now()}`);
                const data = await response.json();
                if (data.success) {
                    const count = data.count || 0;
                    document.getElementById('onlineCount').textContent = `${count} members`;
                }
            } catch (error) {
                document.getElementById('onlineCount').textContent = 'Group';
            }
        }

        function setupEventListeners() {
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('signupPhotoInput').addEventListener('change', previewSignupPhoto);
            document.getElementById('messageInput').addEventListener('input', autoResize);
            document.getElementById('messageInput').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    // Allow Enter key for line breaks
                    return true;
                }
            });
            document.getElementById('profilePhotoUpdate').addEventListener('change', updateProfilePhoto);
            document.getElementById('customWallpaperInput').addEventListener('change', uploadCustomWallpaper);

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.context-menu') && !e.target.closest('.message-bubble')) {
                    hideContextMenu();
                }
            });

            // Scroll event for date badge visibility
            const messagesArea = document.getElementById('messagesArea');
        }

        function autoResize() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }


        // ============ PHOTO PREVIEW ============
        // ============ CROSS-BROWSER PHOTO UPLOAD ============
        function triggerPhotoUpload() {
            const input = document.getElementById('signupPhotoInput');

            // Reset input to allow same file selection
            input.value = '';

            // Try multiple methods for different browsers
            try {
                // Method 1: Standard click (works on most browsers)
                input.click();
            } catch (e) {
                console.error('Click method failed:', e);

                // Method 2: Create temporary event
                try {
                    const event = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });
                    input.dispatchEvent(event);
                } catch (e2) {
                    console.error('Event dispatch failed:', e2);
                    alert('⚠️ Please try again or use a different browser');
                }
            }
        }

        // ============ PREVIEW WITH NO SIZE LIMIT ============
        // ============ HIGH QUALITY PREVIEW ============
        // ============ FULL QUALITY PREVIEW ============
        function previewSignupPhoto(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('signupPhotoPreview');

            if (!file) {
                console.log('No file selected');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('❌ Please select an image file');
                e.target.value = '';
                return;
            }

            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            preview.innerHTML = `<div style="color:var(--accent);font-size:12px;padding:20px;text-align:center;">📸 Loading...<br>${fileSizeMB}MB</div>`;

            const reader = new FileReader();

            reader.onload = function (event) {
                preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                console.log(`✅ Photo loaded: ${fileSizeMB}MB - Original Quality`);
            };

            reader.onerror = function () {
                alert('❌ Error loading photo. Try again!');
                preview.innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        `;
            };

            reader.readAsDataURL(file);
        }

        // ============ COPY PURA YEH ============
        // Tera HTML file me search kar: "async function handleSignup"
        // DELETE SARE 4 VERSIONS - chahe kahin bhi likhe hon!

        // FIR YEH PASTE KAR:

        async function handleSignup(e) {
            e.preventDefault();

            if (!fingerprintVerified) {
                alert('❌ Please scan your fingerprint first!');
                return;
            }

            const code = document.getElementById('signupCode').value.trim();
            if (code !== SECURITY_CODE) {
                alert('❌ Invalid security code!');
                return;
            }

            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const phone = document.getElementById('signupPhone').value.trim();
            const rollNo = document.getElementById('signupRollNo').value.trim();

            // 🔥 PASSWORD CHECK - agar password section visible hai to password mandatory hai
            const passwordSection = document.getElementById('passwordSection');
            let userPassword = null;

            if (passwordSection.classList.contains('active')) {
                userPassword = document.getElementById('signupPassword').value.trim();
                if (!userPassword || userPassword.length < 6) {
                    alert('❌ Password must be at least 6 characters!');
                    return;
                }
            }

            // Validation
            if (!name || name.length < 2) return alert('❌ Please enter a valid name!');
            if (!email.includes('@') || !email.endsWith('gmail.com')) return alert('❌ Please use a valid Gmail!');
            if (!/^\d{10}$/.test(phone)) return alert('❌ Please enter valid 10-digit phone!');
            if (!rollNo) return alert('❌ Please enter Roll Number!');

            const photoFile = document.getElementById('signupPhotoInput').files[0];
            if (!photoFile) return alert('❌ Please upload a profile photo!');

            const btn = document.getElementById('signupBtn');
            btn.textContent = 'Checking account...';
            btn.disabled = true;

            try {
                // Step 1: Check for duplicates
                const checkUrl = `${SAD_URL}?action=checkDuplicate&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}&rollNo=${encodeURIComponent(rollNo)}&t=${Date.now()}`;
                const checkResponse = await fetch(checkUrl);
                const checkData = await checkResponse.json();

                if (checkData.exists === true) {
                    alert(`❌ This ${checkData.field} already exists!`);
                    btn.textContent = 'Sign Up';
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Creating account...';

                // Step 2: Convert photo to base64
                const photoBase64 = await fileToBase64(photoFile);

                // Step 3: Send to Apps Script
                const signupData = {
                    action: 'signup',
                    name,
                    email,
                    phone,
                    rollNo,
                    status: '✅'
                };

                const response = await fetch(SAD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(signupData)
                });

                const result = await response.json();
                console.log('Signup response:', result);

                if (!result.success) {
                    alert('❌ Signup failed: ' + result.message);
                    btn.textContent = 'Sign Up';
                    btn.disabled = false;
                    return;
                }

                // Step 4: Save locally WITH PASSWORD (if used)
                currentUser = {
                    name,
                    email,
                    phone,
                    rollNo,
                    photo: photoBase64,
                    password: userPassword, // 🔥 PASSWORD SAVE HOGA AGAR HAI TO
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('chatUser', JSON.stringify(currentUser));

                alert('✅ Account created successfully!\nWelcome to Class Group Chat!');
                showChat();
                loadWallpapers();
                startMessageRefresh();
                loadOnlineCount();

            } catch (error) {
                console.error('Signup error:', error);
                alert('❌ Error: ' + error.message);
                btn.textContent = 'Sign Up';
                btn.disabled = false;
            }
        }

        async function sendMessage() {
            const msgInput = document.getElementById('messageInput');
            const messageText = msgInput.value.trim();

            if (!messageText || isSending) return;

            isSending = true;
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.disabled = true;

            try {
                const msgTimestamp = getCurrentDate();
                const replyData = replyToMessage ? `${replyToMessage.sender}|||${replyToMessage.text}` : '';

                const messageData = {
                    action: 'saveMessage',
                    studentName: currentUser.name,
                    message: messageText,
                    timestamp: msgTimestamp.toISOString(),
                    replyTo: replyData
                };

                console.log('📤 Sending message:', messageData);

                // ✅ CREATE TEMP MESSAGE
                const tempId = 'temp_' + Date.now();
                const tempMessage = {
                    studentName: currentUser.name,
                    message: messageText,
                    timestamp: msgTimestamp.toISOString(),
                    replyTo: replyData,
                    tempId: tempId,
                    status: 'sending' // ⏱ Clock
                };

                currentMessages.push(tempMessage);

                const messagesArea = document.getElementById('messagesArea');
                const messageDiv = createMessageElement(tempMessage, currentMessages.length - 1);
                messagesArea.appendChild(messageDiv);
                scrollToBottom();

                // Clear input
                msgInput.value = '';
                msgInput.style.height = 'auto';
                cancelReply();

                // 🔊 SEND SOUND - 1 second baad
                setTimeout(() => {
                    try {
                        sendSound.currentTime = 0;
                        sendSound.play().catch(e => console.log('🔇 Blocked'));
                        console.log('🔊 SEND SOUND!');
                    } catch (e) { }
                }, 1000);

                // ✅ PERFECT ANIMATION SEQUENCE
                // Step 1: Clock icon - 0.9 seconds
                setTimeout(() => {
                    tempMessage.status = 'sent';
                    updateMessageStatus(messageDiv, 'sent');
                    console.log('✓ Single tick grey');

                    // Step 2: Single tick - 0.9 seconds
                    setTimeout(() => {
                        tempMessage.status = 'delivered';
                        updateMessageStatus(messageDiv, 'delivered');
                        console.log('✓✓ Double tick grey');

                        // Step 3: Double tick grey - 0.9 seconds
                        setTimeout(() => {
                            tempMessage.status = 'read';
                            updateMessageStatus(messageDiv, 'read');
                            console.log('✓✓ Double tick BLUE - FINAL!');
                        }, 900); // 0.9 sec for double grey

                    }, 900); // 0.9 sec for single tick

                }, 900); // 0.9 sec for clock

                // Block fetch
                const blockDuration = messageText.length > 100 ? 20000 : 15000;
                localStorage.setItem('lastSentTime', Date.now().toString());
                localStorage.setItem('myLastMessage', messageText);
                localStorage.setItem('blockDuration', blockDuration.toString());

                console.log(`🚫 Fetch blocked for ${blockDuration / 1000}s`);

                // Save to sheet
                const response = await fetch(SMD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(messageData)
                });

                const result = await response.json();
                console.log('✅ Message saved to sheet:', result);

                if (result.success) {
                    const tempMsg = currentMessages.find(m => m.tempId === tempId);
                    if (tempMsg) {
                        delete tempMsg.tempId;
                    }
                }

            } catch (err) {
                console.error('Send Error:', err);
                alert('Error sending message: ' + err.message);
                currentMessages.pop();
                displayMessages(currentMessages);
            } finally {
                isSending = false;
                sendBtn.disabled = false;
            }
        }

        function updateMessageStatus(messageDiv, status) {
            if (!messageDiv) return;

            const statusElement = messageDiv.querySelector('.message-status');
            if (!statusElement) return;

            // Remove all classes
            statusElement.className = 'message-status';

            if (status === 'sending') {
                statusElement.classList.add('status-clock');
                statusElement.textContent = '⏱';
            } else if (status === 'sent') {
                statusElement.classList.add('status-tick-single');
                statusElement.textContent = '✓';
            } else if (status === 'delivered') {
                statusElement.classList.add('status-tick-double');
                statusElement.textContent = '✓✓';
            } else if (status === 'read') {
                statusElement.classList.add('status-tick-double', 'read');
                statusElement.textContent = '✓✓';
            }
        }

        // ===============================================
        // ✅ FIXED fetchMessagesWithFilter (No Flicker)
        // ===============================================
        async function fetchMessagesWithFilter() {
            try {
                const response = await fetch(`${SMD_URL}?action=fetchMessages&t=${Date.now()}`, {
                    cache: "no-store"
                });

                if (!data.success) {
                    console.error('Fetch failed:', data.message);
                    return;
                }

                const messagesArea = document.getElementById('messagesArea');

                // 🧠 FIX: Don't clear all messages instantly
                const existingMessages = Array.from(messagesArea.querySelectorAll('.message'));
                const existingTexts = existingMessages.map(m => m.querySelector('.message-text')?.textContent.trim());

                // ✅ Filter messages for this class only (if you use class filter)
                const filteredMessages = data.messages || [];

                let newMessageAdded = false;

                // ✅ Add only new messages (prevent blinking)
                filteredMessages.forEach((msg, i) => {
                    const text = msg.message?.trim();
                    if (!text || existingTexts.includes(text)) return;

                    const messageDiv = createMessageElement(msg, i);
                    messagesArea.appendChild(messageDiv);
                    newMessageAdded = true;
                });

                // ✅ Auto-scroll if new message arrives
                if (newMessageAdded) {
                    scrollToBottom();
                }

            } catch (err) {
                console.error('Error fetching messages:', err);
            }
        }

        if (data.messages.length > existingTexts.length) {
            scrollToBottom();
        }



        async function fetchMessages() {
            // ✅ CHECK BLOCK DURATION
            const lastSent = localStorage.getItem('lastSentTime');
            const blockDuration = parseInt(localStorage.getItem('blockDuration') || '15000');

            if (lastSent) {
                const timeSinceSent = Date.now() - parseInt(lastSent);
                if (timeSinceSent < blockDuration) {
                    console.log(`🚫 SENDER BLOCKED: ${Math.ceil((blockDuration - timeSinceSent) / 1000)}s remaining`);
                    return;
                } else {
                    localStorage.removeItem('lastSentTime');
                    localStorage.removeItem('myLastMessage');
                    localStorage.removeItem('blockDuration');
                }
            }

            try {
                const res = await fetch(`${SMD_URL}?action=fetchMessages&t=${Date.now()}`);
                const result = await res.json();

                const messages = result.messages || result.data || [];
                const messagesArea = document.getElementById("messagesArea");

                if (!messagesArea) return;

                const loadingElement = messagesArea.querySelector('.loading');
                if (loadingElement) {
                    loadingElement.remove();
                }

                if (!Array.isArray(messages) || messages.length === 0) {
                    if (messagesArea.children.length === 0) {
                        messagesArea.innerHTML = '<div class="loading">No messages yet 💬</div>';
                    }
                    return;
                }

                // 🔊 CHECK FOR NEW RECEIVED MESSAGES
                const receivedMessages = messages.filter(m =>
                    m.studentName.trim().toLowerCase() !== currentUser.name.trim().toLowerCase()
                );

                if (receivedMessages.length > lastReceivedMessageCount) {
                    console.log('📩 NEW MESSAGE RECEIVED!');

                    // 🔊 RECEIVE SOUND PLAY
                    try {
                        receiveSound.currentTime = 0;
                        receiveSound.play().catch(e => console.log('🔇 Receive sound blocked'));
                        console.log('🔊 RECEIVE SOUND PLAYED!');
                    } catch (e) { }

                    lastReceivedMessageCount = receivedMessages.length;
                }

                // Blue tick logic
                const sentMessages = document.querySelectorAll('.message.sent .status-tick-double');
                if (receivedMessages.length > 0) {
                    sentMessages.forEach(icon => {
                        icon.classList.add('read');
                    });
                }

                const myLastMsg = localStorage.getItem('myLastMessage');
                if (myLastMsg) {
                    const existingMessages = Array.from(messagesArea.querySelectorAll('.message-text'));
                    const hasMyMessage = existingMessages.some(el => el.textContent.trim() === myLastMsg.trim());

                    if (hasMyMessage) {
                        console.log('✅ Your message already visible');

                        const currentDOMCount = messagesArea.querySelectorAll('.message').length;
                        if (messages.length > currentDOMCount) {
                            const newMessages = messages.slice(currentDOMCount);

                            const hasNewFromOthers = newMessages.some(msg =>
                                msg.studentName.trim().toLowerCase() !== currentUser.name.trim().toLowerCase()
                            );

                            if (hasNewFromOthers) {
                                console.log('💙 New message received! Turning to blue tick...');
                                const sentMessages = messagesArea.querySelectorAll('.message.sent');
                                if (sentMessages.length > 0) {
                                    const lastSentMsg = sentMessages[sentMessages.length - 1];
                                    setTimeout(() => {
                                        updateMessageStatus(lastSentMsg, 'read');
                                    }, 100);
                                }
                            }

                            newMessages.forEach((msg, idx) => {
                                if (msg.message.trim() === myLastMsg.trim()) return;

                                const messageDiv = createMessageElement(msg, currentDOMCount + idx);
                                messagesArea.appendChild(messageDiv);
                            });
                            currentMessages = messages;
                        }
                        return;
                    }
                }

                const currentDOMCount = messagesArea.querySelectorAll('.message').length;
                const newMessageCount = messages.length;

                if (currentDOMCount === newMessageCount) {
                    console.log('✅ No new messages');
                    return;
                }

                console.log(`🔥 Fetching ${newMessageCount - currentDOMCount} new messages`);

                currentMessages = messages;
                displayMessages(messages);
                lastMessageCount = newMessageCount;

            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        // ============ DISPLAY MESSAGES ============
        // ============ DISPLAY MESSAGES ============
        function displayMessages(messages) {
            const container = document.getElementById('messagesArea');
            const wasAtBottom = isScrolledToBottom();

            container.innerHTML = '';
            let currentDate = '';

            messages.forEach((msg, index) => {
                if (!msg.studentName || !msg.message) return;

                const msgDate = new Date(msg.timestamp);
                const dateStr = formatDate(msgDate);

                // ✅ ONLY add date badge when date CHANGES
                if (dateStr !== currentDate) {
                    currentDate = dateStr;
                    const dateBadge = document.createElement('div');
                    dateBadge.className = 'message-date';
                    dateBadge.innerHTML = `<span class="date-badge">${dateStr}</span>`;
                    container.appendChild(dateBadge);
                }

                const messageDiv = createMessageElement(msg, index);
                container.appendChild(messageDiv);
            });

            if (wasAtBottom || lastMessageCount === 0) {
                scrollToBottom();
            }

            lastMessageCount = messages.length;
        }

        function createMessageElement(msg, index) {
            const messageDiv = document.createElement('div');
            const isSent = msg.studentName.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
            const isDeleted = msg.message === '❌';

            messageDiv.className = isSent ? 'message sent' : 'message received';
            messageDiv.setAttribute('data-index', index);
            messageDiv.setAttribute('data-message', msg.message);
            messageDiv.setAttribute('data-sender', msg.studentName);
            messageDiv.setAttribute('data-timestamp', msg.timestamp); // ✅ Add timestamp

            const msgDate = new Date(msg.timestamp);
            const time = msgDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const firstLetter = msg.studentName.charAt(0).toUpperCase();

            // Reply HTML
            let replyHTML = '';
            if (msg.replyTo && msg.replyTo.trim() !== '') {
                if (msg.replyTo.includes('|||')) {
                    const replyParts = msg.replyTo.split('|||');
                    if (replyParts.length >= 2) {
                        const replySender = replyParts[0].trim();
                        const replyText = replyParts[1].trim();
                        const replyTextShort = replyText.length > 30 ? replyText.substring(0, 30) + '...' : replyText;

                        replyHTML = `
                    <div class="reply-preview">
                        <div class="reply-name">${escapeHtml(replySender)}</div>
                        <div class="reply-text">${escapeHtml(replyTextShort)}</div>
                    </div>
                `;
                    }
                }
            }

            // Reaction HTML
            let reactionHTML = '';
            if (msg.reaction && msg.reaction !== '' && !msg.reaction.includes('🕸')) {
                const reactions = parseReactions(msg.reaction);
                if (reactions.length > 0) {
                    reactionHTML = '<div class="message-reactions">';
                    reactions.forEach(r => {
                        reactionHTML += `<div class="reaction-item" onclick="event.stopPropagation(); showReactionDetails(${index}, '${r.emoji}')">
                    ${r.emoji} <span class="reaction-count">${r.count}</span>
                </div>`;
                    });
                    reactionHTML += '</div>';
                }
            }

            let avatarHTML = `<div class="message-avatar">${firstLetter}</div>`;
            const userPhoto = getUserPhoto(msg.studentName);
            if (userPhoto) {
                avatarHTML = `<div class="message-avatar"><img src="${userPhoto}" alt="${msg.studentName}"></div>`;
            }

            let messageTextHTML = '';
            if (isDeleted) {
                messageTextHTML = `<div class="message-text deleted">Deleted</div>`;
            } else {
                const formattedText = msg.message.replace(/\n/g, '<br>');
                const textWithLinks = linkify(formattedText);
                messageTextHTML = `<div class="message-text">${textWithLinks}</div>`;
            }

            // ✅ STATUS ICON (only for sent messages)
            let statusIcon = '';
            if (isSent && !isDeleted) {
                const status = msg.status || 'read'; // 🔥 DEFAULT: Blue double tick

                if (status === 'sending') {
                    statusIcon = '<span class="message-status status-clock">⏱</span>';
                } else if (status === 'sent') {
                    statusIcon = '<span class="message-status status-tick-single">✓</span>';
                } else if (status === 'delivered') {
                    statusIcon = '<span class="message-status status-tick-double">✓✓</span>';
                } else if (status === 'read') {
                    statusIcon = '<span class="message-status status-tick-double read">✓✓</span>';
                }
            }

            messageDiv.innerHTML = `
        <div class="message-content">
            ${avatarHTML}
            <div class="message-bubble" oncontextmenu="showContextMenu(event, ${index}); return false;" 
                 ontouchstart="handleTouchStart(event, ${index})" 
                 ontouchend="handleTouchEnd(event)"
                 ondblclick="replyMessageByIndex(${index})">
                ${!isSent ? `<div class="message-sender">${escapeHtml(msg.studentName)}</div>` : ''}
                ${replyHTML}
                ${messageTextHTML}
                <div class="message-time">${time}${statusIcon}</div>
                ${reactionHTML}
            </div>
        </div>
    `;

            return messageDiv;
        }

        function linkify(text) {
            const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
        }

        function parseReactions(reactionString) {
            if (!reactionString || reactionString === '' || reactionString.includes('🕸')) return [];

            const reactionMap = {};
            const parts = reactionString.split('|');

            parts.forEach(part => {
                if (part.includes(':') && !part.includes('🕸')) {
                    const [user, emoji] = part.split(':');
                    if (emoji && emoji !== '🕸') {
                        reactionMap[emoji] = (reactionMap[emoji] || 0) + 1;
                    }
                }
            });

            return Object.entries(reactionMap).map(([emoji, count]) => ({ emoji, count }));
        }

        function showReactionDetails(messageIndex, emoji = null) {
            const msg = currentMessages[messageIndex];
            if (!msg || !msg.reaction || msg.reaction.includes('🕸')) return;

            const viewer = document.getElementById('reactionViewer');
            const content = document.getElementById('reactionViewerContent');

            const reactionData = {};
            const parts = msg.reaction.split('|');

            parts.forEach(part => {
                if (part.includes(':') && !part.includes('🕸')) {
                    const [user, reactionEmoji] = part.split(':');
                    if (reactionEmoji !== '🕸') {
                        if (!reactionData[reactionEmoji]) {
                            reactionData[reactionEmoji] = [];
                        }
                        reactionData[reactionEmoji].push(user);
                    }
                }
            });

            content.innerHTML = '';

            Object.entries(reactionData).forEach(([reactionEmoji, users]) => {
                if (emoji && emoji !== reactionEmoji) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'reaction-group';

                let html = `<div class="reaction-group-header">${reactionEmoji} ${users.length}</div>`;

                users.forEach(user => {
                    const firstLetter = user.charAt(0).toUpperCase();
                    const isCurrentUser = user.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
                    html += `
                <div class="reaction-user" ${isCurrentUser ? 'onclick="removeReaction(' + messageIndex + ', \'' + reactionEmoji + '\')"' : ''}>
                    <div class="reaction-user-avatar">${firstLetter}</div>
                    <div>${escapeHtml(user)}${isCurrentUser ? ' (Tap to remove)' : ''}</div>
                </div>
            `;
                });

                groupDiv.innerHTML = html;
                content.appendChild(groupDiv);
            });

            viewer.classList.add('active');
        }

        async function removeReaction(messageIndex, emoji) {
            try {
                const reactionData = {
                    action: 'removeReaction',
                    messageIndex: messageIndex,
                    emoji: emoji,
                    userName: currentUser.name
                };

                await fetch(SMD_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(reactionData)
                });

                hideReactionViewer();
                setTimeout(() => fetchMessages(), 200);

            } catch (error) {
                console.error('Remove reaction error:', error);
            }
        }

        function hideReactionViewer() {
            document.getElementById('reactionViewer').classList.remove('active');
        }

        function getUserPhoto(name) {
            if (name.trim().toLowerCase() === currentUser.name.trim().toLowerCase()) {
                return currentUser.photo;
            }
            return null;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = getCurrentDate(); // ✅ Real date use karo

            // Reset time to midnight for accurate comparison
            const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            const diffTime = today.getTime() - msgDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';

            // Format: "Oct 24, Sun"
            const options = { month: 'short', day: 'numeric', weekday: 'short' };
            return msgDate.toLocaleDateString('en-US', options);
        }


        function isScrolledToBottom() {
            const container = document.getElementById('messagesArea');
            return container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesArea');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        }

        // ============ CONTEXT MENU ============
        let touchTimer = null;

        function handleTouchStart(e, index) {
            touchTimer = setTimeout(() => {
                showContextMenu(e, index);
            }, 500);
        }

        function handleTouchEnd(e) {
            clearTimeout(touchTimer);
        }

        function showContextMenu(e, index) {
            e.preventDefault();
            const menu = document.getElementById('contextMenu');
            const deleteOption = document.getElementById('deleteOption');
            selectedMessage = index;

            const msgElement = document.querySelector(`[data-index="${index}"]`);
            if (msgElement) {
                const sender = msgElement.getAttribute('data-sender');
                const message = msgElement.getAttribute('data-message');
                const isOwnMessage = sender.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
                const isDeleted = message === '❌';

                deleteOption.style.display = (isOwnMessage && !isDeleted) ? 'flex' : 'none';
            }

            let x = e.pageX || (e.touches && e.touches[0] ? e.touches[0].pageX : 0);
            let y = e.pageY || (e.touches && e.touches[0] ? e.touches[0].pageY : 0);

            const menuWidth = 150;
            const menuHeight = 220;

            if (x + menuWidth > window.innerWidth) {
                x = window.innerWidth - menuWidth - 10;
            }
            if (x < 10) {
                x = 10;
            }

            if (y + menuHeight > window.innerHeight) {
                y = window.innerHeight - menuHeight - 10;
            }
            if (y < 10) {
                y = 10;
            }

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        // REPLACE WITH:
        function copyMessage() {
            const msgElement = document.querySelector(`[data-index="${selectedMessage}"]`);
            const text = msgElement.getAttribute('data-message');

            if (text === '❌' || text === 'Deleted') {
                alert('Cannot copy deleted messages');
                hideContextMenu();
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                showCopyToast();
            }).catch(err => {
                console.error('Copy failed:', err);
            });
            hideContextMenu();
        }

        function showCopyToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // ===============================
        // ✅ REPLY SYSTEM FIXED VERSION
        // ===============================

        // ✅ When user clicks “Reply” from context menu
        function replyMessage() {
            if (!selectedMessage) return;

            const msgBubble = selectedMessage.querySelector('.message-text');
            const senderName = selectedMessage.querySelector('.message-sender')?.textContent || 'Unknown';
            const msgText = msgBubble?.textContent || '';

            // Save reply target
            replyToMessage = {
                sender: senderName,
                text: msgText
            };

            // Show reply bar
            const replyBar = document.getElementById('replyBar');
            replyBar.classList.add('active');
            document.getElementById('replyName').textContent = senderName;
            document.getElementById('replyText').textContent = msgText.slice(0, 60);
        }

        function replyMessageByIndex(index) {
            const msgElement = document.querySelector(`[data-index="${index}"]`);
            if (!msgElement) return;

            const sender = msgElement.getAttribute('data-sender');
            const text = msgElement.getAttribute('data-message');

            if (text === '❌') return;

            replyToMessage = { sender, text };

            document.getElementById('replyName').textContent = sender;
            const displayText = text.length > 50 ? text.substring(0, 50) + '...' : text;
            document.getElementById('replyText').textContent = displayText;
            document.getElementById('replyBar').classList.add('active');
            document.getElementById('messageInput').focus();
        }

        // ✅ Cancel reply
        function cancelReply() {
            replyToMessage = null;
            document.getElementById('replyBar').classList.remove('active');
            document.getElementById('replyName').textContent = '';
            document.getElementById('replyText').textContent = '';
        }


        async function deleteMessage() {
            if (!selectedMessage) return;

            const msgIndex = selectedMessage.getAttribute('data-index');
            const sender = selectedMessage.getAttribute('data-sender');

            if (!msgIndex) {
                alert("⚠️ Message index not found!");
                return;
            }

            if (sender.trim().toLowerCase() !== currentUser.name.trim().toLowerCase()) {
                alert("❌ You can only delete your own messages!");
                return;
            }

            if (!confirm("🗑️ Delete this message for everyone?")) return;

            try {
                const deleteData = {
                    action: "deleteMessage",
                    studentName: currentUser.name,
                    messageIndex: msgIndex
                };

                const res = await fetch(SMD_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(deleteData)
                });

                const result = await res.json();
                console.log("Delete Response:", result);

                if (result.success) {
                    // ✅ Instantly refresh messages after delete
                    if (result.messages) {
                        currentMessages = result.messages;
                        displayMessages(result.messages);
                    } else {
                        // fallback: re-fetch manually
                        fetchMessagesWithFilter();
                    }
                    alert("✅ Message deleted successfully!");
                } else {
                    alert("❌ " + result.message);
                }
            } catch (err) {
                console.error("Delete error:", err);
                alert("⚠️ Error deleting message: " + err.message);
            } finally {
                hideContextMenu();
            }
        }



        // ============ MEMBERS SIDEBAR ============
        // ============ MEMBERS SIDEBAR ============
        async function toggleMembersSidebar() {
            const sidebar = document.getElementById('membersSidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                await loadMembers();
            }
        }

        async function loadMembers() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '<div class="loading">Loading members...</div>';

            try {
                const response = await fetch(`${SAD_URL}?action=getAllStudents&t=${Date.now()}`);
                const data = await response.json();

                console.log('Members API Response:', data); // Debug log

                if (!data.success || !data.students || data.students.length === 0) {
                    membersList.innerHTML = '<div class="loading">No members found</div>';
                    return;
                }

                document.getElementById('onlineCount').textContent = `${data.students.length} members`;

                membersList.innerHTML = '';

                data.students.forEach(student => {
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'member-item';

                    const firstLetter = student.name.charAt(0).toUpperCase();
                    const rollNo = student.rollNo || 'N/A';

                    memberDiv.innerHTML = `
                <div class="member-avatar">${firstLetter}</div>
                <div class="member-info">
                    <div class="member-name">${escapeHtml(student.name)}</div>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 2px;">Roll No: ${escapeHtml(rollNo)}</div>
                </div>
            `;

                    membersList.appendChild(memberDiv);
                });

            } catch (error) {
                console.error('Error loading members:', error);
                membersList.innerHTML = '<div class="loading">Error loading members</div>';
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // ============ WALLPAPER ============
        function loadWallpapers() {
            const grid = document.getElementById('wallpaperGrid');
            grid.innerHTML = '';

            // ✅ CHANGE: None → Default with your wallpaper
            const defaultItem = document.createElement('div');
            defaultItem.className = 'wallpaper-item';

            // Check if this should be active
            const savedWallpaper = localStorage.getItem('chatWallpaper');
            if (!savedWallpaper || savedWallpaper === 'none' || savedWallpaper === 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg') {
                defaultItem.classList.add('active');
            }

            defaultItem.onclick = () => setWallpaper('https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg', defaultItem);
            defaultItem.innerHTML = `<img src="https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg" alt="Default">`;
            grid.appendChild(defaultItem);

            // Rest wallpapers
            WALLPAPERS.forEach(wallpaper => {
                const item = document.createElement('div');
                item.className = 'wallpaper-item';

                if (savedWallpaper === wallpaper.url) {
                    item.classList.add('active');
                }

                item.onclick = () => setWallpaper(wallpaper.url, item);
                item.innerHTML = `<img src="${wallpaper.url}" alt="${wallpaper.name}">`;
                grid.appendChild(item);
            });

            // Load custom wallpapers from localStorage
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');
            customWallpapers.forEach(wallpaperUrl => {
                const item = document.createElement('div');
                item.className = 'wallpaper-item';

                if (savedWallpaper === wallpaperUrl) {
                    item.classList.add('active');
                }

                item.onclick = () => setWallpaper(wallpaperUrl, item);
                item.innerHTML = `<img src="${wallpaperUrl}" alt="Custom">`;
                grid.appendChild(item);
            });

            // Apply saved wallpaper
            if (savedWallpaper && savedWallpaper !== 'none') {
                document.getElementById('messagesArea').style.backgroundImage = `url(${savedWallpaper})`;
            } else {
                // ✅ Default wallpaper
                document.getElementById('messagesArea').style.backgroundImage = `url(https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg)`;
            }
        }

        // ============ LOAD CUSTOM WALLPAPER COUNT ============
        function loadCustomWallpaperCount() {
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');
            customWallpaperCount = customWallpapers.length;

            // Debug log
            console.log(`📸 Custom Wallpapers Uploaded: ${customWallpaperCount}/1`);
        }

        function setWallpaper(url, element) {
            const messagesArea = document.getElementById('messagesArea');

            // ✅ REMOVE: none check (ab none nahi hai)
            messagesArea.style.backgroundImage = `url(${url})`;
            localStorage.setItem('chatWallpaper', url);

            // Update active state
            document.querySelectorAll('.wallpaper-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
        }

        // ============ SINGLE WALLPAPER UPLOAD ONLY ============
        async function uploadCustomWallpaper(e) {
            const file = e.target.files[0];
            if (!file) return;

            // ✅ Check if user already uploaded a custom wallpaper
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');

            if (customWallpapers.length >= 1) {
                alert('❌ You already uploaded a wallpaper!\n\n⚠️ You can only upload ONE custom wallpaper.');
                e.target.value = ''; // Reset file input
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('❌ Please select an image file');
                e.target.value = '';
                return;
            }

            try {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const customUrl = event.target.result;

                    // Save to localStorage
                    customWallpapers.push(customUrl);
                    localStorage.setItem('customWallpapers', JSON.stringify(customWallpapers));

                    // Add to grid
                    const grid = document.getElementById('wallpaperGrid');
                    const customItem = document.createElement('div');
                    customItem.className = 'wallpaper-item';
                    customItem.onclick = () => setWallpaper(customUrl, customItem);
                    customItem.innerHTML = `<img src="${customUrl}" alt="Custom">`;
                    grid.appendChild(customItem);

                    // Set as active wallpaper
                    setWallpaper(customUrl, customItem);

                    alert('✅ Wallpaper uploaded successfully!\n\n🔒 You cannot upload more wallpapers.');
                };
                reader.readAsDataURL(file);
            } catch (error) {
                alert('❌ Error uploading wallpaper');
            }

            // Reset file input
            e.target.value = '';
        }

        // ============ FONT SIZE ============
        function changeFontSize(delta) {
            const root = document.documentElement;
            const current = parseInt(getComputedStyle(root).getPropertyValue('--font-size'));
            const newSize = Math.max(12, Math.min(20, current + delta));
            root.style.setProperty('--font-size', newSize + 'px');
            document.getElementById('fontSizeDisplay').textContent = newSize + 'px';
            localStorage.setItem('fontSize', newSize);
        }

        function applySettings() {
            const wallpaper = localStorage.getItem('chatWallpaper');

            // ✅ Default wallpaper if nothing saved
            if (!wallpaper || wallpaper === 'none') {
                const defaultWallpaper = 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
                document.getElementById('messagesArea').style.backgroundImage = `url(${defaultWallpaper})`;
                localStorage.setItem('chatWallpaper', defaultWallpaper);
            } else {
                document.getElementById('messagesArea').style.backgroundImage = `url(${wallpaper})`;
            }

            const fontSize = localStorage.getItem('fontSize');
            if (fontSize) {
                document.documentElement.style.setProperty('--font-size', fontSize + 'px');
                document.getElementById('fontSizeDisplay').textContent = fontSize + 'px';
            }

            const theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
        }

        // ============ PROFILE FUNCTIONS ============
        function showProfile() {
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            chatContainer.classList.remove('active');
            chatContainer.style.display = 'none';
            profilePage.classList.add('active');
            profilePage.style.display = 'flex';

            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profilePhone').textContent = currentUser.phone;
            document.getElementById('profileRollNo').textContent = currentUser.rollNo; // Added Roll Number
            document.getElementById('profilePhotoLarge').src = currentUser.photo;
        }

        function hideProfile() {
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            profilePage.classList.remove('active');
            profilePage.style.display = 'none';
            chatContainer.classList.add('active');
            chatContainer.style.display = 'flex';
        }
        async function updateProfilePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('❌ Please upload a valid image');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('❌ Image size should be less than 5MB');
                return;
            }

            try {
                const photoBase64 = await fileToBase64(file);
                currentUser.photo = photoBase64;
                localStorage.setItem('chatUser', JSON.stringify(currentUser));

                document.getElementById('profilePhotoLarge').src = photoBase64;
                document.getElementById('headerProfilePhoto').src = photoBase64;
                document.getElementById('inputProfilePhoto').src = photoBase64;

                alert('✅ Profile photo updated!');
            } catch (error) {
                console.error('Update photo error:', error);
                alert('❌ Error updating photo. Please try again.');
            }
        }

        // ============ LOGOUT ============
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('chatUser');
                currentUser = null;
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                document.getElementById('profilePage').classList.remove('active');
                document.getElementById('chatContainer').classList.remove('active');
                showSignup();
                fingerprintVerified = false;
                document.getElementById('fingerprintBtn').disabled = false;
                document.getElementById('fingerprintBtn').style.background = 'linear-gradient(135deg, var(--accent) 0%, #00d9a8 100%)';
                document.getElementById('fingerprintStatus').textContent = 'Tap to scan fingerprint';
                document.getElementById('fingerprintStatus').style.color = 'var(--text-secondary)';
                document.getElementById('signupBtn').disabled = true;
                document.getElementById('signupForm').reset();
                document.getElementById('signupPhotoPreview').innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        `;
            }
        }

        // ============ THEME TOGGLE ============
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // ============ PAGE NAVIGATION ============
        function showSignup() {
            const signupPage = document.getElementById('signupPage');
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            // Hide everything first
            chatContainer.classList.remove('active');
            chatContainer.style.display = 'none';
            profilePage.classList.remove('active');
            profilePage.style.display = 'none';

            // Show signup
            signupPage.classList.remove('hidden');
            signupPage.style.display = 'flex';
        }

        function showChat() {
            const signupPage = document.getElementById('signupPage');
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            // Hide everything first
            signupPage.classList.add('hidden');
            signupPage.style.display = 'none';
            profilePage.classList.remove('active');
            profilePage.style.display = 'none';

            // Show chat
            chatContainer.classList.add('active');
            chatContainer.style.display = 'flex';

            if (currentUser && currentUser.photo) {
                document.getElementById('headerProfilePhoto').src = currentUser.photo;
                document.getElementById('inputProfilePhoto').src = currentUser.photo;
            }

            // ✅ Set default wallpaper
            const wallpaper = localStorage.getItem('chatWallpaper');
            if (!wallpaper || wallpaper === 'none') {
                const defaultWallpaper = 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
                document.getElementById('messagesArea').style.backgroundImage = `url(${defaultWallpaper})`;
                localStorage.setItem('chatWallpaper', defaultWallpaper);
            }
        }

        // ============ HELPER FUNCTIONS ============
        // ============ IMPROVED FILE TO BASE64 WITH FALLBACK ============
        // ============ AUTO COMPRESS ANY SIZE IMAGE ============
        // ============ HIGH QUALITY COMPRESSION ============
        // ============ ORIGINAL QUALITY - NO COMPRESSION ============
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('No file provided'));
                    return;
                }

                const reader = new FileReader();

                reader.onload = (e) => {
                    // 🔥 DIRECT BASE64 - NO CANVAS, NO COMPRESSION!
                    const base64 = e.target.result;

                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    console.log(`✅ Original Quality Saved: ${fileSizeMB}MB - NO compression applied!`);

                    resolve(base64);
                };

                reader.onerror = () => {
                    console.error('File read failed');
                    reject(new Error('File read failed'));
                };

                reader.readAsDataURL(file);
            });
        }

        document.getElementById("contextMenuDelete").onclick = deleteMessage;


        // ============ SECURITY VERIFICATION SYSTEM ============

        // Check which verification method to show
        function showSecurityVerification() {
            const securityPage = document.getElementById('securityPage');
            const fingerprintSection = document.getElementById('fingerprintVerifySection');
            const passwordSection = document.getElementById('passwordVerifySection');

            const userData = JSON.parse(localStorage.getItem('chatUser'));

            if (!userData) {
                showSignup();
                return;
            }

            // Check if user has password in localStorage
            if (userData.password) {
                // Show password verification
                passwordSection.classList.remove('hidden');
                fingerprintSection.classList.add('hidden');
            } else {
                // Show fingerprint verification
                fingerprintSection.classList.remove('hidden');
                passwordSection.classList.add('hidden');
            }

            securityPage.classList.remove('hidden');
        }

        // Verify Fingerprint (same as signup fingerprint)
        async function verifyFingerprint() {
            const btn = document.querySelector('#fingerprintVerifySection .fingerprint-button');
            const status = document.getElementById('fingerprintVerifyStatus');
            const currentHost = window.location.hostname;
            const isLocalhost = currentHost === 'localhost' || currentHost === '127.0.0.1';

            btn.disabled = true;
            status.textContent = 'Scanning fingerprint...';
            btn.style.transform = 'scale(0.95)';

            try {
                if (isLocalhost) {
                    await new Promise(res => setTimeout(res, 800));
                    onVerificationSuccess();
                    return;
                }

                if (!window.PublicKeyCredential) {
                    throw new Error('Biometric authentication not supported');
                }

                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                if (!available) {
                    throw new Error('No biometric authenticator available');
                }

                const challenge = window.crypto.getRandomValues(new Uint8Array(32));
                const userId = window.crypto.getRandomValues(new Uint8Array(16));

                const publicKeyCreate = {
                    challenge: challenge.buffer,
                    rp: { name: "Class Group Chat" },
                    user: {
                        id: userId.buffer,
                        name: "student@" + window.location.hostname,
                        displayName: "Student"
                    },
                    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        userVerification: "required",
                        requireResidentKey: false
                    },
                    timeout: 60000,
                    attestation: "none"
                };

                try {
                    const credential = await navigator.credentials.create({ publicKey: publicKeyCreate });
                    if (credential) {
                        onVerificationSuccess();
                        return;
                    }
                } catch (createErr) {
                    console.warn('create() failed, trying get():', createErr);
                }

                const publicKeyGet = {
                    challenge: window.crypto.getRandomValues(new Uint8Array(32)).buffer,
                    timeout: 60000,
                    userVerification: "required",
                };

                const assertion = await navigator.credentials.get({ publicKey: publicKeyGet });
                if (assertion) {
                    onVerificationSuccess();
                    return;
                } else {
                    throw new Error('Verification failed');
                }

            } catch (err) {
                console.error('Fingerprint verification error:', err);
                status.textContent = '❌ Verification Failed';
                status.style.color = '#ff4c4c';
                alert('❌ Fingerprint verification failed!\n\nPlease try again.');
                btn.disabled = false;
                btn.style.transform = 'scale(1)';
            }
        }

        // Verify Password
        function verifyPassword() {
            const inputPassword = document.getElementById('verifyPassword').value.trim();
            const userData = JSON.parse(localStorage.getItem('chatUser'));

            if (!inputPassword) {
                alert('❌ Please enter password');
                return;
            }

            if (inputPassword === userData.password) {
                onVerificationSuccess();
            } else {
                alert('❌ Incorrect password!\n\nVerification failed.');
                document.getElementById('verifyPassword').value = '';
            }
        }

        // On successful verification
        function onVerificationSuccess() {
            // Set session flag (cleared on tab close)
            sessionStorage.setItem('verified', 'true');

            // Hide security page and show chat
            document.getElementById('securityPage').classList.add('hidden');
            showChat();
            loadWallpapers();
            startMessageRefresh();
            loadOnlineCount();
            startStatusMonitoring();
        }

    </script>
</body>

</html>
