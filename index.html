<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Group Chat</title>
    <!-- âœ… Web App Manifest -->
    <link rel="manifest" href='data:application/manifest+json,{
  "name": "Smart Class Chat",
  "short_name": "Class Chat",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#8BC34A",
  "theme_color": "#8BC34A",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "https://github.com/salikweber0/Smart-Class-Chat/blob/main/classicon.jpg?raw=true",
      "sizes": "512x512",
      "type": "image/jpg",
      "purpose": "any maskable"
    },
    {
      "src": "https://github.com/salikweber0/Smart-Class-Chat/blob/main/classicon.jpg?raw=true",
      "sizes": "192x192",
      "type": "image/jpg",
      "purpose": "any"
    }
  ]
}'>

    <!-- âœ… Apple Touch Icons -->
    <link rel="apple-touch-icon"
        href="https://github.com/salikweber0/Smart-Class-Chat/blob/main/classicon.jpg?raw=true">
    <link rel="apple-touch-icon" sizes="180x180"
        href="https://github.com/salikweber0/Smart-Class-Chat/blob/main/classicon.jpg?raw=true">
    <link rel="apple-touch-icon" sizes="152x152"
        href="https://github.com/salikweber0/Smart-Class-Chat/blob/main/classicon.jpg?raw=true">

    <!-- âœ… Theme Colors -->
    <meta name="theme-color" content="#8BC34A">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">


    <!-- Theme Color -->
    <meta name="theme-color" content="#00a884">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Edu+NSW+ACT+Hand+Pre:wght@400..700&family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Savate:ital,wght@0,200..900;1,200..900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function (OneSignal) {
            OneSignal.init({
                appId: "244608f6-0c20-452e-bcd3-336c1bd85274",
                safari_web_id: "",
                notifyButton: { enable: true },
            });
        });
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        :root {
            --bg-primary: #111b21;
            --bg-secondary: #0b141a;
            --bg-chat: #0b141a;
            --bg-input: #2a3942;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --bubble-sent: #005c4b;
            --bubble-received: #202c33;
            --border-color: #2a3942;
            --accent: #00a884;
            --header-bg: #202c33;
            --header-text: #e9edef;
            --font-size: 14px;
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-chat: #efeae2;
            --bg-input: #ffffff;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --bubble-sent: #d9fdd3;
            --bubble-received: #ffffff;
            --border-color: #d1d7db;
            --accent: #00a884;
            --header-bg: #008069;
            --header-text: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        input,
        textarea,
        button,
        select {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
        }

        /* Loader Animation */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
            /* âœ… Smooth fade */
        }

        .loader-container.hidden {
            display: none;
            opacity: 0;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Desktop/Tablet Block */
        .device-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            text-align: center;
        }

        .device-warning.active {
            display: flex;
        }

        .warning-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .warning-title {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .warning-text {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Fingerprint Scanner */
        .fingerprint-section {
            margin: 20px 0;
            text-align: center;
        }

        .fingerprint-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #00d9a8 100%);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0, 168, 132, 0.3);
        }

        .fingerprint-button:active {
            transform: scale(0.95);
        }

        .fingerprint-button svg {
            width: 60px;
            height: 60px;
            fill: white;
        }

        .fingerprint-status {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            background: var(--bg-primary);
            overflow-y: auto;
            transition: opacity 0.2s ease;
            /* âœ… Smooth fade */
        }

        .auth-container.hidden {
            display: none !important;
            opacity: 0;
        }

        .auth-box {
            background: var(--bg-secondary);
            padding: 100px 30px 70px 30px !important;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            text-align: center;
            margin-top: 180px;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: var(--accent);
            font-size: 24px;
            margin-bottom: 5px;
        }

        .profile-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            border: 3px solid var(--accent);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-btn {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            background: var(--header-bg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .group-info h2,
        .group-info p {
            color: var(--header-text);
        }

        .group-info h2 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .group-info p {
            font-size: 13px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle,
        .profile-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: var(--header-text);
        }

        .profile-icon img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 10px 70px 10px;
            -webkit-overflow-scrolling: touch;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            /* âœ… Fixed position */
            background-attachment: scroll;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
        }

        [data-theme="light"] .messages-area {
            background-color: #e5ddd5;
        }

        [data-theme="light"] .date-badge {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-date {
            text-align: center;
            position: sticky;
            margin-top: 0px 0px 0px 0px;
            top: -20px;
            z-index: 10;
            padding: 0px 0px;
            background: transparent;
        }

        .date-badge {
            display: inline-block;
            background: rgba(42, 57, 66, 0.95);
            backdrop-filter: blur(10px);
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            font-weight: 500;
        }


        .message {
            display: flex;
            margin-bottom: 8px;
            position: relative;
        }

        .message.sent {
            justify-content: flex-end;
            z-index: 2;
        }

        .message.received {
            justify-content: flex-start;
            z-index: 2;
        }

        .message-content {
            display: flex;
            gap: 8px;
            max-width: 75%;
            position: relative;
        }

        .message.sent .message-content {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.sent .message-avatar {
            display: none;
        }

        .message-bubble {
            background: var(--bubble-received);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            user-select: none;
            position: relative;
            max-width: 100%;
        }

        .message.sent .message-bubble {
            background: var(--bubble-sent);
            border-radius: 8px 0 8px 8px;
        }

        .message.received .message-bubble {
            border-radius: 0 8px 8px 8px;
        }

        .message-sender {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 3px;
        }

        .message-text {
            font-size: var(--font-size);
            color: var(--text-primary);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message-text a {
            color: #53bdeb;
            text-decoration: underline;
        }

        .message-text.deleted {
            font-style: italic;
            color: #8696a0;
            font-size: 13px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
        }

        .reply-preview {
            background: rgba(0, 168, 132, 0.15);
            border-left: 3px solid var(--accent);
            padding: 5px 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .reply-name {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 12px;
        }

        .reply-text {
            color: var(--text-secondary);
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-reactions {
            display: flex;
            gap: 3px;
            margin-top: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 5px 0;
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .context-menu-item:hover {
            background: var(--bg-input);
        }

        .context-menu-item.delete {
            color: #dc3545;
        }

        .copy-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            font-size: 14px;
            animation: slideDown 0.3s ease;
        }

        .copy-toast.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .reaction-viewer-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .reaction-viewer-title {
            font-size: 16px;
            font-weight: 600;
        }

        .reaction-viewer-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
        }

        .reaction-viewer-content {
            padding: 10px;
        }

        .reaction-group {
            margin-bottom: 15px;
        }

        .reaction-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .reaction-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
        }

        .reaction-user:hover {
            background: var(--bg-input);
        }

        .reaction-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .reaction-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .members-sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: var(--bg-secondary);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            z-index: 200;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .members-sidebar.active {
            left: 0;
        }

        .members-header {
            background: var(--header-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .members-header h3 {
            color: var(--header-text);
            font-size: 18px;
        }

        .members-close {
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 24px;
            cursor: pointer;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 10px 50px 10px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .member-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .input-area {
            background: var(--bg-secondary);
            padding: 8px 10px;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            flex-shrink: 0;
            flex-direction: column;
            z-index: 3;
        }

        .reply-bar {
            background: var(--bg-input);
            padding: 8px 12px;
            display: none;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid var(--accent);
            width: 100%;
            border-radius: 8px;
        }

        .reply-bar.active {
            display: flex;
        }

        .input-row {
            display: flex;
            gap: 8px;
            width: 100%;
            align-items: center;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            background: var(--bg-input);
            border-radius: 25px;
            padding: 8px 12px;
            align-items: center;
            gap: 8px;
            max-height: 150px;
        }

        .user-avatar-input {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            cursor: pointer;
            overflow: hidden;
        }

        .user-avatar-input img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 2px solid var(--accent);
            border-radius: 50%;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
        }

        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        .profile-page {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-primary);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            z-index: 100;
            overflow-y: auto;
        }

        .profile-page.active {
            display: flex;
        }

        .profile-header {
            background: var(--header-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 24px;
            cursor: pointer;
        }

        .profile-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 40px 20px;
        }

        .profile-section {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .wallpaper-upload {
            margin-bottom: 15px;
        }

        .upload-wallpaper-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .wallpaper-item {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .wallpaper-item.active {
            border-color: var(--accent);
        }

        .wallpaper-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .font-size-btn {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
        }

        .font-size-value {
            font-size: 16px;
            color: var(--text-primary);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 0px 20px;
            color: var(--text-secondary);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .message-content {
                max-width: 85%;
            }

            .messages-area {
                padding-bottom: 120px;
            }

            .emoji-picker {
                max-width: 90%;
            }
        }

        @media (max-width: 580px) {
            .messages-area {
                padding-bottom: 130px;
            }
        }

        @media (max-width: 480px) {
            .messages-area {
                padding-bottom: 130px;
            }
        }

        .password-section {
            display: none;
            margin: 20px 0;
        }

        .password-section.active {
            display: block;
        }

        .password-section .form-group {
            margin-bottom: 15px;
        }

        .password-section label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .password-section input {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* ============ MESSAGE STATUS ICONS ============ */
        .message-status {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            margin-left: 5px;
            font-size: 14px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }

        .status-clock {
            color: #8696a0;
            animation: clockRotate 2.2s ease;
        }

        .status-tick-single {
            color: #8696a0 !important;
            animation: tickFadeIn 0.8s ease;
        }

        .status-tick-double {
            color: #8696a0 !important;
            animation: tickFadeIn 0.8s ease;
        }

        .status-tick-double.read {
            color: #53bdeb !important;
            animation: blueTickPop 0.8s ease;
        }

        @keyframes clockRotate {
            from {
                opacity: 0;
                transform: rotate(-2000deg) scale(0.5);
            }

            to {
                opacity: 1;
                transform: rotate(2150deg) scale(1);
            }
        }

        @keyframes tickFadeIn {
            from {
                opacity: 0;
                transform: rotate(-180deg) scale(0.5);
            }

            to {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
        }

        @keyframes blueTickPop {
            0% {
                transform: scale(1);
                color: #8696a0;
            }

            50% {
                transform: scale(1.4);
                color: #53bdeb;
            }

            100% {
                transform: scale(1);
                color: #53bdeb;
            }
        }

        /* ============ ADMIN MESSAGE STYLING ============ */
        .message.admin .message-bubble {
            background: #FFE066;
            /* âœ… Lighter Gold */
            border-left: 4px solid #FF8C00;
            box-shadow: none;
            /* âœ… Shadow removed */
            position: relative;
            line-height: 1.8;
            letter-spacing: 0.3px;
        }

        .message.admin .message-bubble::after {
            content: 'ðŸ‘‘';
            position: absolute;
            bottom: -7px;
            left: 5px;
            font-size: 20px;
            text-shadow: 0px 0px 2px black;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .message.admin .message-sender {
            color: #D35400;
            /* âœ… Dark Orange - Better visibility */
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
        }

        .message.admin .message-text {
            color: #2C3E50;
            font-family: "Ubuntu", sans-serif !important;
            font-weight: 600 !important;
            font-size: 13px;
        }

        .message.admin .message-text a {
            color: #FF6B35;
            /* Brighter orange */
            text-decoration: none;
            font-weight: 700;
        }

        .message.admin .message-time {
            color: #7F5539;
            /* âœ… Brown - Clear visibility */
            font-weight: 600;
        }

        /* Admin badge for header/sidebar */
        .admin-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFE066 0%, #FFB84D 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
            margin-left: 5px;
            box-shadow: 0 2px 4px rgba(255, 165, 0, 0.4);
        }

        /* ============ PREMIUM SYSTEM STYLES ============ */

        /* Profile Header Icons */
        .profile-header-icons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .profile-icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-icon-btn:active {
            transform: scale(0.9);
        }

        /* Wallpaper Lock Overlay */
        .wallpaper-item {
            position: relative;
        }

        .wallpaper-lock {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .wallpaper-lock:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        /* Wallpaper Preview Overlay */
        .wallpaper-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wallpaper-preview-overlay.active {
            display: flex;
        }

        .preview-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 32px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }

        .wallpaper-preview-img {
            max-width: 90%;
            max-height: 60vh;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            margin-bottom: 30px;
        }

        .preview-buttons {
            display: flex;
            gap: 15px;
        }

        .trial-btn,
        .premium-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .trial-btn {
            background: linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%);
            color: white;
        }

        .premium-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
        }

        .trial-btn:active,
        .premium-btn:active {
            transform: scale(0.95);
        }

        /* Premium Page */
        .premium-page {
            position: fixed;
            right: -100%;
            top: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            z-index: 999;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .premium-page.active {
            right: 0;
        }

        .premium-header {
            background: var(--header-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .premium-content {
            padding: 20px;
        }

        .premium-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .premium-card h3 {
            color: var(--accent);
            font-size: 22px;
            margin-bottom: 15px;
        }

        .premium-timer {
            font-size: 18px;
            color: var(--text-primary);
            margin: 15px 0;
            font-weight: 600;
        }

        .premium-price {
            font-size: 32px;
            color: #FFD700;
            font-weight: bold;
            margin: 20px 0;
        }

        .get-premium-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        /* Payment Page */
        .payment-page {
            position: fixed;
            right: -100%;
            top: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .payment-page.active {
            right: 0;
        }

        .payment-qr {
            width: 250px;
            height: 290px;
            margin: 30px auto;
            background: white;
            border-radius: 15px;
            border-radius: 20px;
        }

        .payment-qr img {
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }

        .payment-info {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .payment-info h4 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        .payment-info p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* About Page */
        .about-page {
            position: fixed;
            right: -100%;
            top: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            z-index: 999;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .about-page.active {
            right: 0;
        }

        .about-content {
            padding: 20px 20px 80px 20px;
        }

        .about-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 4px solid var(--accent);
        }

        .about-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .about-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .about-info h2 {
            color: var(--accent);
            font-size: 24px;
            margin-bottom: 10px;
        }

        .about-info p {
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1.6;
        }

        .about-qr {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            background: white;
            padding: 10px;
            border-radius: 10px;
        }

        .about-qr img {
            width: 100%;
            height: 100%;
        }

        .contact-info {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .contact-item:last-child {
            border-bottom: none;
        }

        .whatsapp-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Trial Timer Toast */
        .trial-timer-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .trial-timer-toast.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
    </style>
</head>

<body data-theme="dark">

    <!-- Device Warning -->
    <div id="deviceWarning" class="device-warning">
        <div class="warning-icon">ðŸ“±</div>
        <div class="warning-title">Mobile Only</div>
        <div class="warning-text">This project is only for mobile devices.</div>
    </div>

    <!-- Loader -->
    <div id="loaderContainer" class="loader-container hidden">
        <div class="loader"></div>
        <div class="loader-text">Verifying account...</div>
    </div>

    <!-- Signup Page -->
    <div id="signupPage" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-header">
                <h1>ðŸ“š Class Group Chat</h1>
                <p>Create your account</p>
            </div>
            <form id="signupForm">
                <div class="profile-upload">
                    <div class="profile-preview" id="signupPhotoPreview">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                    </div>
                    <input type="file" id="signupPhotoInput" accept="image/*" style="display: none;">
                    <button type="button" class="upload-btn"
                        onclick="document.getElementById('signupPhotoInput').click()">Upload Photo</button>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="signupName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="signupPhone" required>
                </div>
                <div class="form-group">
                    <label>Roll Number</label>
                    <input type="text" id="signupRollNo" required maxlength="4" pattern="\d{4}"
                        placeholder="1001 to 1142 (4 digits)" oninput="validateRollNumber(this)">
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 5px; display: block;">
                        ðŸ“‹ Must be 4 digits (1001 to 1142). Cannot start with 0.
                    </small>
                </div>
                <div class="form-group">
                    <label>Security Code</label>
                    <input type="text" id="signupCode" required placeholder="Enter class code">
                </div>
                <!-- Password Section (Fallback for unsupported browsers) -->
                <div class="password-section" id="passwordSection">
                    <div class="form-group">
                        <label>Create Password</label>
                        <input type="password" id="signupPassword" placeholder="Enter your password" minlength="6">
                    </div>
                </div>

                <!-- Fingerprint Section -->
                <div class="fingerprint-section">
                    <button type="button" class="fingerprint-button" id="fingerprintBtn" onclick="scanFingerprint()">
                        <svg viewBox="0 0 24 24">
                            <path fill="white"
                                d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94 1.7 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z" />
                        </svg>
                    </button>
                    <div class="fingerprint-status" id="fingerprintStatus">Tap to scan fingerprint</div>
                </div>

                <button type="submit" class="btn-primary" id="signupBtn" disabled>Sign Up</button>
            </form>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <div class="header-left" onclick="toggleMembersSidebar()">
                <div class="group-avatar">CG</div>
                <div class="group-info">
                    <h2>Class Group</h2>
                    <p id="onlineCount">Loading...</p>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-toggle" onclick="toggleTheme()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </div>
                <div class="profile-icon" onclick="showProfile()">
                    <img id="headerProfilePhoto" src="" alt="Profile">
                </div>
            </div>
        </div>

        <div class="messages-area" id="messagesArea">
            <div class="loading">Loading messages...</div>
        </div>

        <div class="input-area">
            <div class="reply-bar" id="replyBar">
                <div>
                    <div class="reply-name" id="replyName"></div>
                    <div class="reply-text" id="replyText"></div>
                </div>
                <button onclick="cancelReply()"
                    style="background:none;border:none;color:var(--text-primary);cursor:pointer;">âœ•</button>
            </div>
            <div class="input-row">
                <div class="input-wrapper">
                    <div class="user-avatar-input" onclick="showProfile()">
                        <img id="inputProfilePhoto" src="" alt="You">
                    </div>
                    <textarea id="messageInput" placeholder="Type a message" rows="1"></textarea>
                </div>
                <button class="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Members Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMembersSidebar()"></div>
    <div class="members-sidebar" id="membersSidebar">
        <div class="members-header">
            <h3>Class Members</h3>
            <button class="members-close" onclick="toggleMembersSidebar()">Ã—</button>
        </div>
        <div class="members-list" id="membersList">
            <div class="loading">Loading members...</div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="profile-page">
        <!-- Profile Header with Premium & About Icons -->
        <div class="profile-header">
            <button class="back-btn" onclick="hideProfile()">â†</button>
            <h2 style="color: var(--header-text);">Profile</h2>
            <!-- â­ NEW: Premium & About Icons -->
            <div class="profile-header-icons">
                <button class="profile-icon-btn" onclick="showPremiumPage()" title="Premium">
                    <span style="font-size: 22px;">â­</span>
                </button>
                <button class="profile-icon-btn" onclick="showAboutPage()" title="About">
                    <span style="font-size: 22px;">â„¹ï¸</span>
                </button>
            </div>
        </div>
        <div class="profile-content">
            <div class="profile-section">
                <div style="text-align:center;padding:20px 0;">
                    <div
                        style="width:150px;height:150px;border-radius:50%;margin:0 auto 20px;overflow:hidden;border:4px solid var(--accent);">
                        <img id="profilePhotoLarge" src="" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <input type="file" id="profilePhotoUpdate" accept="image/*" style="display:none;">
                    <button class="upload-btn" onclick="document.getElementById('profilePhotoUpdate').click()">Change
                        Photo</button>
                </div>
            </div>

            <div class="profile-section">
                <div style="padding:15px 0;border-bottom:1px solid var(--border-color);">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Name</div>
                    <div id="profileName" style="font-size:16px;">-</div>
                </div>
                <div style="padding:15px 0;border-bottom:1px solid var(--border-color);">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Email</div>
                    <div id="profileEmail" style="font-size:16px;">-</div>
                </div>
                <div style="padding:15px 0;">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Phone</div>
                    <div id="profilePhone" style="font-size:16px;">-</div>
                </div>
                <div style="padding:15px 0;">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Roll Number</div>
                    <div id="profileRollNo" style="font-size:16px;">-</div>
                </div>
            </div>

            <div class="profile-section">
                <div class="section-title">Chat Wallpaper</div>
                <div class="wallpaper-upload">
                    <input type="file" id="customWallpaperInput" accept="image/*" style="display:none;">
                    <!-- <button class="upload-wallpaper-btn"
                        onclick="document.getElementById('customWallpaperInput').click()">
                        ðŸ“¸ Upload Custom Wallpaper (1 Max)
                    </button> -->
                </div>
                <div class="wallpaper-grid" id="wallpaperGrid"></div>
            </div>

            <div class="profile-section">
                <div class="section-title">Font Size</div>
                <div class="font-size-control">
                    <button class="font-size-btn" onclick="changeFontSize(-1)">A-</button>
                    <span class="font-size-value" id="fontSizeDisplay">14px</span>
                    <button class="font-size-btn" onclick="changeFontSize(1)">A+</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Security Verification Page -->
    <div id="securityPage" class="auth-container hidden">
        <div class="auth-box">
            <div class="auth-header">
                <h1>ðŸ” Security Verification</h1>
                <p>Verify to continue</p>
            </div>

            <!-- Fingerprint Section (for users without password) -->
            <div id="fingerprintVerifySection" class="hidden">
                <div class="fingerprint-section">
                    <button type="button" class="fingerprint-button" onclick="verifyFingerprint()">
                        <svg viewBox="0 0 24 24">
                            <path fill="white"
                                d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94 1.7 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z" />
                        </svg>
                    </button>
                    <div class="fingerprint-status" id="fingerprintVerifyStatus">Tap to scan fingerprint</div>
                </div>
            </div>

            <!-- Password Section (for users with password) -->
            <div id="passwordVerifySection" class="hidden">
                <div class="form-group">
                    <label>Enter Password</label>
                    <input type="password" id="verifyPassword" placeholder="Enter your password">
                </div>
                <button type="button" class="btn-primary" onclick="verifyPassword()">Verify</button>
            </div>
        </div>
    </div>


    <!-- â­ PREMIUM WALLPAPER PREVIEW OVERLAY -->
    <div class="wallpaper-preview-overlay" id="wallpaperPreview">
        <button class="preview-close-btn" onclick="closeWallpaperPreview()">Ã—</button>
        <img class="wallpaper-preview-img" id="previewImage" src="" alt="Preview">
        <div class="preview-buttons">
            <button class="trial-btn" onclick="startFreeTrial()">ðŸŸ¢ Free Trial (30s)</button>
            <button class="premium-btn" onclick="showPaymentPage()">ðŸ’› Get Premium</button>
        </div>
    </div>

    <!-- â­ PREMIUM PAGE -->
    <div class="premium-page" id="premiumPage">
        <div class="premium-header">
            <button class="back-btn" onclick="hidePremiumPage()">â†</button>
            <h2 style="color: var(--header-text);">Premium Access</h2>
        </div>
        <div class="premium-content">
            <div class="premium-card">
                <h3>ðŸŒŸ Unlock All Wallpapers</h3>
                <p style="color: var(--text-secondary); margin: 15px 0;">
                    Get access to all premium wallpapers for one month!
                </p>
                <div class="premium-price">â‚¹20</div>
                <p style="color: var(--text-secondary); font-size: 14px;">
                    Valid for 31 days
                </p>
                <div class="premium-timer" id="premiumTimer">
                    <!-- Timer will be shown here -->
                </div>
                <button class="get-premium-btn" id="getPremiumBtn" onclick="showPaymentPage()">
                    Get Premium Now
                </button>
            </div>

            <div class="premium-card" style="text-align: left;">
                <h4 style="color: var(--accent); margin-bottom: 15px;">âœ¨ Features:</h4>
                <ul style="color: var(--text-secondary); line-height: 2;">
                    <li>ðŸŽ¨ Access to all wallpapers</li>
                    <li>ðŸš« No more locks</li>
                    <li>â° 31 days validity</li>
                    <li>ðŸ”„ Auto-renewal option</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ðŸ’³ PAYMENT PAGE -->
    <div class="payment-page" id="paymentPage">
        <div class="premium-header">
            <button class="back-btn" onclick="hidePaymentPage()">â†</button>
            <h2 style="color: var(--header-text);">Payment</h2>
        </div>
        <div class="premium-content">
            <div class="premium-card">
                <h3>ðŸ’³ Scan QR to Pay</h3>
                <div class="payment-qr">
                    <img src="QR.png" alt="Payment QR">
                </div>
                <div class="payment-info">
                    <h4>Payment Instructions:</h4>
                    <p>
                        1ï¸âƒ£ Scan the QR code above<br>
                        2ï¸âƒ£ Pay exactly <strong>â‚¹20</strong><br>
                        3ï¸âƒ£ Take screenshot of payment<br>
                        4ï¸âƒ£ Send to admin for verification<br>
                        5ï¸âƒ£ Premium will be activated within 24 hours
                    </p>
                </div>
                <p style="color: var(--text-secondary); font-size: 13px; margin-top: 15px;">
                    âš ï¸ Once payment is verified by admin, your premium access will be activated automatically.
                </p>
            </div>
        </div>
    </div>

    <!-- â„¹ï¸ ABOUT PAGE -->
    <div class="about-page" id="aboutPage">
        <div class="premium-header">
            <button class="back-btn" onclick="hideAboutPage()">â†</button>
            <h2 style="color: var(--header-text);">About Developer</h2>
        </div>
        <div class="about-content">
            <div class="about-avatar">
                <img src="https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTCRARf33-x1QbblvditdM8VhyieEU-BcQV-B9bC0C_tz1t3xcC"
                    alt="Salik">
            </div>
            <div class="about-info">
                <h2>Shaikh Salik</h2>
                <p style="font-size: 18px; color: var(--accent); margin-bottom: 10px;">
                    ðŸ’¼ Web Developer
                </p>
                <p style="max-width: 400px; margin: 0 auto;">
                    "I created Smart Class Chat with hard work and dedication to make class communication easier and
                    better for everyone."
                </p>
            </div>

            <button class="whatsapp-btn" onclick="openProject()"
                style="margin-bottom: 20px; background-color: rgba(255, 107, 53, 1)">
                <span style="font-size: 24px;">ðŸŒ</span>
                Open Project
            </button>

            <div class="contact-info">
                <div class="contact-item">
                    <span style="font-size: 24px;">ðŸ“ž</span>
                    <div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Phone</div>
                        <div style="color: var(--text-primary);">7069331761</div>
                    </div>
                </div>
                <div class="contact-item">
                    <span style="font-size: 24px;">ðŸ“§</span>
                    <div>
                        <div style="font-size: 13px; color: var(--text-secondary);">Email</div>
                        <div style="color: var(--text-primary);">salikshaikh278@gmail.com</div>
                    </div>
                </div>
            </div>

            <button class="whatsapp-btn" onclick="openWhatsApp()">
                <span style="font-size: 24px;">ðŸ’¬</span>
                Contact on WhatsApp
            </button>
        </div>
    </div>

    <!-- â° TRIAL TIMER TOAST -->
    <div class="trial-timer-toast" id="trialTimerToast"></div>

    <script>
        // ============ CONFIGURATION ============
        const SECURITY_CODE = "Salik@Weber";
        const SAD_URL = "https://script.google.com/macros/s/AKfycbzC7LQ1baoYJg0Z__OlEyZ6VzZNLFlHBIGd1xsJ8tznKEfsYwIvMiqOxJ_NItKRihdH3w/exec";
        const SMD_URL = "https://script.google.com/macros/s/AKfycbxuhy-dKIiJ6wj9tBDgsOIt004OQfSTJd3SMDC_NBarK7bS3uqHAToeJa7t7fzvP2H6GA/exec";
        const PREMIUM_URL = "https://script.google.com/macros/s/AKfycbwobFlIv8ogquH5KvAui4iIP-hewKleRC83zI3rYW3EbpxScX3jtlLlaPcWyOQZ7B21JA/exec";
        const MAX_CUSTOM_WALLPAPERS = 1;

        // ============ ADMIN CONFIGURATION ============
        const ADMIN_INFO = {
            name: 'Admin',
            email: 'grouphead.co@gmail.com',
            phone: '1000000001',
            rollNo: '2608'
        };

        // Function to check if sender is admin
        function isAdmin(senderName) {
            if (!senderName) return false;
            return senderName.trim().toLowerCase() === ADMIN_INFO.name.toLowerCase();
        }

        // ============ WALLPAPERS ============
        const WALLPAPERS = [
            { name: 'Wallpeper 1', url: 'https://i.pinimg.com/736x/01/f3/9c/01f39c1bbd7d02483d2a1124189c8cc7.jpg' },
            { name: 'Wallpeper 2', url: 'https://i.pinimg.com/1200x/b1/03/99/b10399e030a86cf1e24c7f3c2e6402da.jpg' },
            { name: 'Wallpeper 3', url: 'https://i.pinimg.com/736x/7f/bf/3b/7fbf3b0f277386ae396280040a98506f.jpg' },
            { name: 'Wallpeper 4', url: 'https://i.pinimg.com/1200x/c3/83/89/c383892f6ae9c6d298d13fab013a8ce2.jpg' },
            { name: 'Wallpeper 5', url: 'https://i.pinimg.com/736x/2f/ae/fc/2faefc45deb93187a9174f9ac885252c.jpg' },
            { name: 'Wallpeper 6', url: 'https://i.pinimg.com/1200x/65/ef/63/65ef630abe552a0cae1fb030f573d88f.jpg' },
            { name: 'Wallpeper 7', url: 'https://i.pinimg.com/736x/af/4a/8e/af4a8e0e754737be37236ed93f850e3d.jpg' },
            { name: 'Wallpeper 8', url: 'https://i.pinimg.com/1200x/d7/80/1d/d7801d0ae8c6b5630e1117af08be2bcc.jpg' },
            { name: 'Wallpeper 9', url: 'https://i.pinimg.com/1200x/e5/1a/b7/e51ab72bdf9805698fb6a336f7e457db.jpg' },
            { name: 'Wallpeper 10', url: 'https://i.pinimg.com/1200x/6f/49/b3/6f49b36c69f23da1d48ace5e292a804c.jpg' },
            { name: 'Wallpeper 11', url: 'https://i.pinimg.com/736x/24/48/1a/24481a9ef9d2181a9d46dff99ac08839.jpg' },
            { name: 'Wallpeper 12', url: 'https://i.pinimg.com/736x/21/8b/ab/218bab64ec2d4c794660297cbcf4f413.jpg' },
            { name: 'Wallpeper 13', url: 'https://i.pinimg.com/1200x/68/b6/f0/68b6f0e00ee5bc6a07943e727e0af848.jpg' },
            { name: 'Wallpeper 14', url: 'https://i.pinimg.com/736x/07/19/0f/07190f6c7836e3968773dbdd6024e239.jpg' },
            { name: 'Wallpeper 15', url: 'https://i.pinimg.com/736x/e4/d1/59/e4d15982a0bd0ff10ead0850465617da.jpg' },
            { name: 'Wallpeper 16', url: 'https://i.pinimg.com/736x/0f/6b/ee/0f6beeb227684f0f17751516aa39e781.jpg' },
            { name: 'Wallpeper 17', url: 'https://i.pinimg.com/1200x/30/b8/32/30b83284a24a4323230621ee471dec9e.jpg' },
            { name: 'Wallpeper 18', url: 'https://i.pinimg.com/1200x/62/fc/a8/62fca8c7fee19f06e32452d1bbc32e7f.jpg' },
            { name: 'Wallpeper 19', url: 'https://i.pinimg.com/736x/21/53/d2/2153d25d5df5b49676dc433cff8a486a.jpg' },
            { name: 'Wallpeper 20', url: 'https://i.pinimg.com/736x/b0/8b/09/b08b092814e2844d25b5ace406a93a07.jpg' },
            { name: 'Wallpeper 21', url: 'https://i.pinimg.com/736x/37/d3/47/37d347b1cddeaf03c32934a5fbce53f8.jpg' },
            { name: 'Wallpeper 22', url: 'https://i.pinimg.com/1200x/d1/4b/e3/d14be361bead6931812c20f541113c2f.jpg' },
            { name: 'Wallpeper 23', url: 'https://i.pinimg.com/736x/7b/50/99/7b5099d17f44fd77d95158eb9bf6a349.jpg' },
            { name: 'Wallpeper 24', url: 'https://i.pinimg.com/736x/cb/96/7b/cb967bfb718cddcf25305d6bff8a1f59.jpg' }
        ];

        function applySettings() {
            const wallpaper = localStorage.getItem('chatWallpaper');

            // âœ… If no wallpaper saved, use default
            if (!wallpaper || wallpaper === 'none') {
                document.getElementById('messagesArea').style.backgroundImage = `url(${DEFAULT_WALLPAPER})`;
                localStorage.setItem('chatWallpaper', DEFAULT_WALLPAPER);
            } else {
                document.getElementById('messagesArea').style.backgroundImage = `url(${wallpaper})`;
            }

            const fontSize = localStorage.getItem('fontSize');
            if (fontSize) {
                document.documentElement.style.setProperty('--font-size', fontSize + 'px');
                document.getElementById('fontSizeDisplay').textContent = fontSize + 'px';
            }

            const theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
        }

        // ============ STATE MANAGEMENT ============
        let currentUser = null;
        let refreshInterval = null;
        let selectedMessage = null;
        let replyToMessage = null;
        let lastMessageCount = 0;
        let isSending = false;
        let allUsers = {};
        let currentMessages = [];
        let fingerprintVerified = false;
        let lastScrollPosition = 0;
        let customWallpaperCount = 0;
        let lastMessageSentTime = 0;
        let isFirstMessage = true;
        let pendingMessageId = null;
        let serverDate = null;
        let dateOffset = 0;
        // ============ SOUND EFFECTS ============
        const sendSound = new Audio('https://cdn.freesound.org/previews/720/720277_7037-lq.mp3');
        const receiveSound = new Audio('https://cdn.freesound.org/previews/720/720280_7037-lq.mp3');
        sendSound.volume = 0.7;
        receiveSound.volume = 0.7;

        let lastReceivedMessageCount = 0; // Track received messages


        // ============ FETCH REAL DATE FROM API ============
        async function fetchRealDate() {
            try {
                // WorldTimeAPI se India time fetch karo
                const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Kolkata');
                const data = await response.json();

                serverDate = new Date(data.datetime);
                const localDate = new Date();

                // Calculate offset between server and local time
                dateOffset = serverDate.getTime() - localDate.getTime();

                console.log('âœ… Real Server Date:', serverDate.toLocaleString());
                console.log('ðŸ“… Local Date:', localDate.toLocaleString());
                console.log('â° Offset:', Math.round(dateOffset / 1000), 'seconds');

                return serverDate;
            } catch (error) {
                console.error('âŒ Date API Error:', error);
                // Fallback to local date if API fails
                return new Date();
            }
        }

        // Get current date (with server sync)
        function getCurrentDate() {
            if (dateOffset !== 0) {
                return new Date(Date.now() + dateOffset);
            }
            return new Date();
        }

        // ============ EMOJIS ============
        const REACTION_EMOJIS = ['â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™', 'ðŸ‘', 'ðŸ‘Ž', 'ðŸ”¥', 'ðŸŽ‰', 'ðŸ˜', 'ðŸ˜¡', 'ðŸ’¯', 'âœ…', 'âŒ'];

        // // ============ DEVICE CHECK ============
        function checkDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const currentHost = window.location.hostname;

            // Allow localhost/127.0.0.1 to bypass device check
            if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                return true;
            }

            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const isTablet = /ipad|android/i.test(userAgent) && !/mobile/i.test(userAgent);
            const screenWidth = window.innerWidth;

            if (!isMobile || isTablet || screenWidth > 768) {
                document.getElementById('deviceWarning').classList.add('active');
                return false;
            }
            return true;
        }

        // ============ UPDATED FINGERPRINT BIOMETRIC AUTHENTICATION ============
        // Simulates verification on localhost (http://127.0.0.1:5500) with an alert, uses real biometric scanner on HTTPS
        // Replace the existing scanFingerprint() with this improved version
        async function scanFingerprint() {
            const btn = document.getElementById('fingerprintBtn');
            const status = document.getElementById('fingerprintStatus');
            const signupBtn = document.getElementById('signupBtn');
            const passwordSection = document.getElementById('passwordSection');
            const currentHost = window.location.hostname;
            const isLocalhost = currentHost === 'localhost' || currentHost === '127.0.0.1';

            btn.disabled = true;
            status.textContent = 'Scanning fingerprint...';
            btn.style.transform = 'scale(0.95)';

            try {
                if (isLocalhost) {
                    // Local simulation (dev)
                    await new Promise(res => setTimeout(res, 800));
                    status.textContent = 'âœ… Fingerprint verified (simulated)';
                    status.style.color = 'var(--accent)';
                    fingerprintVerified = true;
                    signupBtn.disabled = false;
                    btn.style.background = 'linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%)';
                    return;
                }

                // Ensure WebAuthn available
                if (!window.PublicKeyCredential) {
                    throw new Error('Biometric authentication not supported in this browser.');
                }

                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                if (!available) {
                    throw new Error('No platform biometric authenticator available on this device.');
                }

                // Create random challenge and user id as ArrayBuffer
                const challenge = window.crypto.getRandomValues(new Uint8Array(32));
                const userId = window.crypto.getRandomValues(new Uint8Array(16));

                const publicKeyCreate = {
                    challenge: challenge.buffer,
                    rp: { name: "Class Group Chat" },
                    user: {
                        id: userId.buffer,
                        name: "student@" + window.location.hostname,
                        displayName: "Student"
                    },
                    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        userVerification: "required",
                        requireResidentKey: false
                    },
                    timeout: 60000,
                    attestation: "none"
                };

                try {
                    const credential = await navigator.credentials.create({ publicKey: publicKeyCreate });
                    if (credential) {
                        console.log('WebAuthn create credential:', credential);
                        status.textContent = 'âœ… Fingerprint verified';
                        status.style.color = 'var(--accent)';
                        fingerprintVerified = true;
                        signupBtn.disabled = false;
                        btn.style.background = 'linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%)';
                        return;
                    }
                } catch (createErr) {
                    console.warn('create() failed, trying get() as fallback:', createErr);
                }

                const publicKeyGet = {
                    challenge: window.crypto.getRandomValues(new Uint8Array(32)).buffer,
                    timeout: 60000,
                    userVerification: "required",
                };

                const assertion = await navigator.credentials.get({ publicKey: publicKeyGet });
                if (assertion) {
                    console.log('WebAuthn assertion:', assertion);
                    status.textContent = 'âœ… Fingerprint verified';
                    status.style.color = 'var(--accent)';
                    fingerprintVerified = true;
                    signupBtn.disabled = false;
                    btn.style.background = 'linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%)';
                    return;
                } else {
                    throw new Error('No credential returned by authenticator.');
                }

            } catch (err) {
                console.error('Biometric verification error:', err);
                status.textContent = 'âŒ Fingerprint not supported';
                status.style.color = '#ff4c4c';

                // ðŸ”¥ YE HAI TERA PASSWORD FALLBACK - 2 seconds baad show hoga
                setTimeout(() => {
                    passwordSection.classList.add('active');
                    status.textContent = 'ðŸ”‘ Use password instead';
                    fingerprintVerified = true; // Password mode enable
                    signupBtn.disabled = false;
                    btn.style.display = 'none'; // Fingerprint button hide
                }, 2000);

            } finally {
                btn.style.transform = 'scale(1)';
                btn.disabled = false;
            }
        }



        // ============ INITIALIZATION ============
        window.onload = function () {
            if (!checkDevice()) return;
            applySettings();
            setupEventListeners();
            checkAuth();
            loadCustomWallpaperCount();

            // ============ PWA INSTALL PROMPT ============
            let deferredPrompt;

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;

                // Check agar user ne pehle se accept kar diya
                const installAccepted = localStorage.getItem('pwaInstallAccepted');

                if (!installAccepted) {
                    // Show popup after 2 seconds
                    setTimeout(() => {
                        showInstallPrompt();
                    }, 2000);
                }
            });

            function showInstallPrompt() {
                if (!deferredPrompt) return;

                const userConfirm = confirm(
                    'ðŸ“± Add Class Group Chat to your home screen?\n\n' +
                    'This will give you quick access to the app!'
                );

                if (userConfirm) {
                    // âœ… Flag set karo localStorage me
                    localStorage.setItem('pwaInstallAccepted', 'true');

                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('âœ… App installed!');
                            alert('âœ… App added to home screen!\n\nYou can now open it directly from there.');
                        } else {
                            console.log('âŒ Installation cancelled');
                        }
                        deferredPrompt = null;
                    });
                } else {
                    console.log('âŒ User declined installation');
                    // Flag nahi set hoga - next time phir se popup aayega
                }
            }

            // Optional: Clear install flag (logout ke time)
            function clearInstallFlag() {
                localStorage.removeItem('pwaInstallAccepted');
                console.log('ðŸ”„ Install flag cleared - popup again show hoga');
            }
        };

        // ============ ðŸ”¥ CLEAN CHECKAUTH - NO ISSUES ============
        async function checkAuth() {
            try {
                await fetchRealDate();
                const userDataString = localStorage.getItem('chatUser');
                const isBlocked = localStorage.getItem('blockedUser');
                const isVerified = sessionStorage.getItem('verified');

                // No user data - show signup
                if (!userDataString) {
                    hideLoader();
                    setTimeout(() => showSignup(), 30);
                    return;
                }

                const userData = JSON.parse(userDataString);
                if (!userData.name || !userData.email || !userData.phone) {
                    hideLoader();
                    setTimeout(() => showSignup(), 30);
                    return;
                }

                showLoader();

                // API call to check status
                const verifyUrl = `${SAD_URL}?action=verifyUser&name=${encodeURIComponent(userData.name)}&email=${encodeURIComponent(userData.email)}&phone=${encodeURIComponent(userData.phone)}&t=${Date.now()}`;

                try {
                    const res = await fetch(verifyUrl);
                    const data = await res.json();

                    hideLoader();

                    if (data.status === 'blocked') {
                        localStorage.setItem('blockedUser', 'true');
                        showBlockedScreen();
                        return;
                    }

                    if (data.status === 'active') {
                        localStorage.removeItem('blockedUser');
                        currentUser = userData;

                        // âœ… CHECK IF ALREADY VERIFIED IN THIS SESSION
                        if (isVerified === 'true') {
                            // Already verified - directly show chat
                            showChat();
                            loadWallpapers();
                            startStatusMonitoring();
                            startMessageRefresh();
                            loadOnlineCount();
                        } else {
                            // Not verified - show security verification
                            showSecurityVerification();
                        }
                        return;
                    }

                } catch (err) {
                    console.error('API Error:', err);
                    hideLoader();

                    if (isBlocked === 'true') {
                        showBlockedScreen();
                    } else {
                        currentUser = userData;

                        // Check session verification
                        if (isVerified === 'true') {
                            showChat();
                            loadWallpapers();
                            startMessageRefresh();
                            loadOnlineCount();
                            startStatusMonitoring();
                        } else {
                            showSecurityVerification();
                        }
                    }
                }

            } catch (err) {
                console.error("checkAuth Error:", err);
                hideLoader();
                setTimeout(() => showSignup(), 50);
            }
        }

        // ðŸ”¥ NEW: Blocked Screen Function
        function showBlockedScreen() {
            document.body.innerHTML = `
        <div style="background:#111; color:#ff4c4c; font-size:20px; display:flex; align-items:center; justify-content:center; height:100vh; text-align:center; flex-direction:column;">
            <div style="font-size:80px;">â›”</div>
            <p><strong>You are Blocked by Admin</strong></p>
        </div>`;
        }

        // ============ ðŸ”¥ ULTRA AGGRESSIVE MONITORING ============
        let statusCheckInterval = null;

        function startStatusMonitoring() {
            console.log('ðŸŸ¢ STATUS MONITORING STARTED');

            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }

            // âš¡ IMMEDIATE FIRST CHECK
            checkUserStatus();

            // ðŸ”„ THEN CHECK EVERY 2 SECONDS
            statusCheckInterval = setInterval(checkUserStatus, 2000);
        }

        async function checkUserStatus() {
            if (!currentUser) return;

            try {
                const verifyUrl = `${SAD_URL}?action=verifyUser&name=${encodeURIComponent(currentUser.name)}&email=${encodeURIComponent(currentUser.email)}&phone=${encodeURIComponent(currentUser.phone)}&t=${Date.now()}`;

                const response = await fetch(verifyUrl);
                const data = await response.json();

                const isCurrentlyBlocked = localStorage.getItem('blockedUser') === 'true';

                console.log('ðŸ”', new Date().toLocaleTimeString(), 'â†’', data.status, '| Local:', isCurrentlyBlocked);

                // ðŸ”´ BLOCK: active â†’ blocked
                if (data.status === 'blocked' && !isCurrentlyBlocked) {
                    console.log('ðŸ”´ BLOCKING NOW!');
                    localStorage.setItem('blockedUser', 'true');
                    clearInterval(statusCheckInterval);
                    if (refreshInterval) clearInterval(refreshInterval);
                    showBlockedScreen();
                    return;
                }

                // âœ… UNBLOCK: blocked â†’ active
                if (data.status === 'active' && isCurrentlyBlocked) {
                    console.log('âœ… UNBLOCKING NOW!');
                    localStorage.removeItem('blockedUser');
                    clearInterval(statusCheckInterval);
                    if (refreshInterval) clearInterval(refreshInterval);

                    // Show alert
                    alert('âœ… You have been unblocked by Admin!\n\nReloading chat...');

                    // Reload page
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                    return;
                }

            } catch (error) {
                console.error('âŒ Check failed:', error);
            }
        }

        // ============ ðŸ”¥ MESSAGE REFRESH + STATUS MONITORING ============
        function startMessageRefresh() {
            console.log('ðŸ“¨ Message refresh started');

            // Initial load
            fetchMessages();
            fetchRealDate(); // âœ… Date bhi sync karo

            // Clear old interval
            if (refreshInterval) clearInterval(refreshInterval);

            // âœ… Refresh every 1.5 seconds
            refreshInterval = setInterval(() => {
                fetchMessages();
                loadOnlineCount();
            }, 1500);

            // âœ… Date sync every 5 minutes
            setInterval(() => {
                fetchRealDate();
            }, 300000); // 5 minutes

            startStatusMonitoring();
        }

        async function verifyAccountStatus(user) {
            try {
                const response = await fetch(`${SAD_URL}?action=verifyUser&name=${encodeURIComponent(user.name)}&email=${encodeURIComponent(user.email)}&phone=${encodeURIComponent(user.phone)}&rollNo=${encodeURIComponent(user.rollNo)}`);
                const data = await response.json();
                console.log('Verify User Response:', data); // Add this line for debugging
                return data.status === 'active';
            } catch (error) {
                console.error('Verification error:', error);
                return false;
            }
        }

        function showLoader() {
            document.getElementById('loaderContainer').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loaderContainer').classList.add('hidden');
        }

        async function loadOnlineCount() {
            try {
                const response = await fetch(`${SAD_URL}?action=getOnlineCount&t=${Date.now()}`);
                const data = await response.json();
                if (data.success) {
                    const count = data.count || 0;
                    document.getElementById('onlineCount').textContent = `${count} members`;
                }
            } catch (error) {
                document.getElementById('onlineCount').textContent = 'Group';
            }
        }

        function setupEventListeners() {
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('signupPhotoInput').addEventListener('change', previewSignupPhoto);
            document.getElementById('messageInput').addEventListener('input', autoResize);
            document.getElementById('messageInput').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    // Allow Enter key for line breaks
                    return true;
                }
            });
            document.getElementById('profilePhotoUpdate').addEventListener('change', updateProfilePhoto);
            document.getElementById('customWallpaperInput').addEventListener('change', uploadCustomWallpaper);

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.context-menu') && !e.target.closest('.message-bubble')) {
                    hideContextMenu();
                }
            });

            // Scroll event for date badge visibility
            const messagesArea = document.getElementById('messagesArea');
        }

        function autoResize() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }


        // ============ PHOTO PREVIEW ============
        // ============ CROSS-BROWSER PHOTO UPLOAD ============
        function triggerPhotoUpload() {
            const input = document.getElementById('signupPhotoInput');

            // Reset input to allow same file selection
            input.value = '';

            // Try multiple methods for different browsers
            try {
                // Method 1: Standard click (works on most browsers)
                input.click();
            } catch (e) {
                console.error('Click method failed:', e);

                // Method 2: Create temporary event
                try {
                    const event = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });
                    input.dispatchEvent(event);
                } catch (e2) {
                    console.error('Event dispatch failed:', e2);
                    alert('âš ï¸ Please try again or use a different browser');
                }
            }
        }

        // ============ PREVIEW WITH NO SIZE LIMIT ============
        // ============ HIGH QUALITY PREVIEW ============
        // ============ FULL QUALITY PREVIEW ============
        function previewSignupPhoto(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('signupPhotoPreview');

            if (!file) {
                console.log('No file selected');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('âŒ Please select an image file');
                e.target.value = '';
                return;
            }

            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            preview.innerHTML = `<div style="color:var(--accent);font-size:12px;padding:20px;text-align:center;">ðŸ“¸ Loading...<br>${fileSizeMB}MB</div>`;

            const reader = new FileReader();

            reader.onload = function (event) {
                preview.innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                console.log(`âœ… Photo loaded: ${fileSizeMB}MB - Original Quality`);
            };

            reader.onerror = function () {
                alert('âŒ Error loading photo. Try again!');
                preview.innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        `;
            };

            reader.readAsDataURL(file);
        }

        // ============ COPY PURA YEH ============
        // Tera HTML file me search kar: "async function handleSignup"
        // DELETE SARE 4 VERSIONS - chahe kahin bhi likhe hon!

        // FIR YEH PASTE KAR:

        async function handleSignup(e) {
            e.preventDefault();

            if (!fingerprintVerified) {
                alert('âŒ Please scan your fingerprint first!');
                return;
            }

            const code = document.getElementById('signupCode').value.trim();
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const phone = document.getElementById('signupPhone').value.trim();
            const rollNo = document.getElementById('signupRollNo').value.trim();
            const photoFile = document.getElementById('signupPhotoInput').files[0];

            // Photo validation
            if (photoFile) {
                if (code !== SECURITY_CODE) {
                    alert('âŒ Invalid security code');
                    return;
                }
            } else {
                if (code !== '#Error') {
                    alert('âŒ Please upload your profile photo first!');
                    return;
                }
            }

            // Basic validations
            if (!name || name.length < 2) return alert('âŒ Please enter a valid name!');
            if (!email.includes('@') || !email.endsWith('gmail.com')) return alert('âŒ Please use a valid Gmail!');
            if (!/^\d{10}$/.test(phone)) return alert('âŒ Please enter valid 10-digit phone!');

            // âœ… ROLL NUMBER VALIDATION
            if (!rollNo) return alert('âŒ Please enter Roll Number!');

            // Check: Must be exactly 4 digits
            if (!/^\d{4}$/.test(rollNo)) {
                alert('âŒ Roll Number must be exactly 4 digits!\n\nExample: 1234, 5678, 9999');
                return;
            }

            // Check: Cannot start with 0
            if (rollNo.startsWith('0')) {
                alert('âŒ Roll Number cannot start with 0!\n\nExample:\nâœ… Valid: 1234, 5001, 9999\nâŒ Invalid: 0123, 0001');
                return;
            }

            // Check: Must be a valid number between 1000-9999
            const rollNumber = parseInt(rollNo);
            if (rollNumber < 1000 || rollNumber > 9999) {
                alert('âŒ Roll Number must be between 1000 and 9999!');
                return;
            }

            const btn = document.getElementById('signupBtn');
            btn.textContent = 'Checking account...';
            btn.disabled = true;

            try {
                // Step 1: Check for duplicates
                const checkUrl = `${SAD_URL}?action=checkDuplicate&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}&rollNo=${encodeURIComponent(rollNo)}&t=${Date.now()}`;
                const checkResponse = await fetch(checkUrl);
                const checkData = await checkResponse.json();

                if (checkData.exists === true) {
                    alert(`âŒ This ${checkData.field} already exists!`);
                    btn.textContent = 'Sign Up';
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Creating account...';

                // Step 2: Convert photo to base64 (if exists)
                let photoBase64 = null;
                if (photoFile) {
                    photoBase64 = await fileToBase64(photoFile);
                }

                // Step 3: Send to Apps Script
                const signupData = {
                    action: 'signup',
                    name,
                    email,
                    phone,
                    rollNo,
                    status: 'âœ…'
                };

                const response = await fetch(SAD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(signupData)
                });

                const result = await response.json();
                console.log('Signup response:', result);

                if (!result.success) {
                    alert('âŒ Signup failed: ' + result.message);
                    btn.textContent = 'Sign Up';
                    btn.disabled = false;
                    return;
                }

                // Step 4: Save locally
                currentUser = {
                    name,
                    email,
                    phone,
                    rollNo,
                    photo: photoBase64 || 'https://via.placeholder.com/120?text=' + name.charAt(0),
                    password: document.getElementById('signupPassword').value.trim() || null,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('chatUser', JSON.stringify(currentUser));

                // ðŸŽ‰ Success message
                let successMsg = 'âœ… Account created successfully!\n\nWelcome to Class Group Chat!';
                if (!photoFile) {
                    successMsg += '\n\nðŸ“¸ Note: No profile photo added.\nYou can add one later in settings.';
                }
                alert(successMsg);

                showChat();
                loadWallpapers();
                startMessageRefresh();
                loadOnlineCount();
                saveOneSignalToken(currentUser.name);

            } catch (error) {
                console.error('Signup error:', error);
                alert('âŒ Error: ' + error.message);
                btn.textContent = 'Sign Up';
                btn.disabled = false;
            }
        }

        async function sendMessage() {
            const msgInput = document.getElementById('messageInput');
            const messageText = msgInput.value.trim();

            if (!messageText || isSending) return;

            isSending = true;
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.disabled = true;

            try {
                const msgTimestamp = getCurrentDate();
                const replyData = replyToMessage ? `${replyToMessage.sender}|||${replyToMessage.text}` : '';

                const messageData = {
                    action: 'saveMessage',
                    studentName: currentUser.name,
                    message: messageText,
                    timestamp: msgTimestamp.toISOString(),
                    replyTo: replyData
                };

                console.log('ðŸ“¤ Sending message:', messageData);

                // âœ… CREATE TEMP MESSAGE
                const tempId = 'temp_' + Date.now();
                const tempMessage = {
                    studentName: currentUser.name,
                    message: messageText,
                    timestamp: msgTimestamp.toISOString(),
                    replyTo: replyData,
                    tempId: tempId,
                    status: 'sending' // â± Clock
                };

                currentMessages.push(tempMessage);

                const messagesArea = document.getElementById('messagesArea');
                const messageDiv = createMessageElement(tempMessage, currentMessages.length - 1);
                messagesArea.appendChild(messageDiv);
                scrollToBottom();

                // Clear input
                msgInput.value = '';
                msgInput.style.height = 'auto';
                cancelReply();

                // ðŸ”Š SEND SOUND - 1 second baad
                setTimeout(() => {
                    try {
                        sendSound.currentTime = 0;
                        sendSound.play().catch(e => console.log('ðŸ”‡ Blocked'));
                        console.log('ðŸ”Š SEND SOUND!');
                    } catch (e) { }
                }, 1000);

                // âœ… PERFECT ANIMATION SEQUENCE
                // Step 1: Clock icon - 2.2 seconds
                setTimeout(() => {
                    tempMessage.status = 'sent';
                    updateMessageStatus(messageDiv, 'sent');
                    console.log('âœ“ Single tick grey');

                    // Step 2: Single tick - 0.8 seconds
                    setTimeout(() => {
                        tempMessage.status = 'delivered';
                        updateMessageStatus(messageDiv, 'delivered');
                        console.log('âœ“âœ“ Double tick grey');

                        // Step 3: Double tick grey - 0.8 seconds
                        setTimeout(() => {
                            tempMessage.status = 'read';
                            updateMessageStatus(messageDiv, 'read');
                            console.log('âœ“âœ“ Double tick BLUE - FINAL!');
                        }, 800); // 0.8 sec for double grey

                    }, 800); // 0.8 sec for single tick

                }, 2200); // 2.2 sec for clock

                // Block fetch
                const blockDuration = messageText.length > 100 ? 20000 : 15000;
                localStorage.setItem('lastSentTime', Date.now().toString());
                localStorage.setItem('myLastMessage', messageText);
                localStorage.setItem('blockDuration', blockDuration.toString());

                console.log(`ðŸš« Fetch blocked for ${blockDuration / 1000}s`);

                // Save to sheet
                const response = await fetch(SMD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(messageData)
                });

                const result = await response.json();
                console.log('âœ… Message saved to sheet:', result);

                if (result.success) {
                    const tempMsg = currentMessages.find(m => m.tempId === tempId);
                    if (tempMsg) {
                        delete tempMsg.tempId;
                    }
                }

            } catch (err) {
                console.error('Send Error:', err);
                alert('Error sending message: ' + err.message);
                currentMessages.pop();
                displayMessages(currentMessages);
            } finally {
                isSending = false;
                sendBtn.disabled = false;
            }
        }

        function updateMessageStatus(messageDiv, status) {
            if (!messageDiv) return;

            const statusElement = messageDiv.querySelector('.message-status');
            if (!statusElement) return;

            // Remove all classes
            statusElement.className = 'message-status';

            if (status === 'sending') {
                statusElement.classList.add('status-clock');
                statusElement.textContent = 'â±';
            } else if (status === 'sent') {
                statusElement.classList.add('status-tick-single');
                statusElement.textContent = 'âœ“';
            } else if (status === 'delivered') {
                statusElement.classList.add('status-tick-double');
                statusElement.textContent = 'âœ“âœ“';
            } else if (status === 'read') {
                statusElement.classList.add('status-tick-double', 'read');
                statusElement.textContent = 'âœ“âœ“';
            }
        }

        // ===============================================
        // âœ… FIXED fetchMessagesWithFilter (No Flicker)
        // ===============================================
        async function fetchMessagesWithFilter() {
            try {
                const response = await fetch(`${SMD_URL}?action=fetchMessages&t=${Date.now()}`, {
                    cache: "no-store"
                });

                if (!data.success) {
                    console.error('Fetch failed:', data.message);
                    return;
                }

                const messagesArea = document.getElementById('messagesArea');

                // ðŸ§  FIX: Don't clear all messages instantly
                const existingMessages = Array.from(messagesArea.querySelectorAll('.message'));
                const existingTexts = existingMessages.map(m => m.querySelector('.message-text')?.textContent.trim());

                // âœ… Filter messages for this class only (if you use class filter)
                const filteredMessages = data.messages || [];

                let newMessageAdded = false;

                // âœ… Add only new messages (prevent blinking)
                filteredMessages.forEach((msg, i) => {
                    const text = msg.message?.trim();
                    if (!text || existingTexts.includes(text)) return;

                    const messageDiv = createMessageElement(msg, i);
                    messagesArea.appendChild(messageDiv);
                    newMessageAdded = true;
                });

                // âœ… Auto-scroll if new message arrives
                if (newMessageAdded) {
                    scrollToBottom();
                }

            } catch (err) {
                console.error('Error fetching messages:', err);
            }
        }

        if (data.messages.length > existingTexts.length) {
            scrollToBottom();
        }



        async function fetchMessages() {
            // âœ… CHECK BLOCK DURATION
            const lastSent = localStorage.getItem('lastSentTime');
            const blockDuration = parseInt(localStorage.getItem('blockDuration') || '15000');

            if (lastSent) {
                const timeSinceSent = Date.now() - parseInt(lastSent);
                if (timeSinceSent < blockDuration) {
                    console.log(`ðŸš« SENDER BLOCKED: ${Math.ceil((blockDuration - timeSinceSent) / 1000)}s remaining`);
                    return;
                } else {
                    localStorage.removeItem('lastSentTime');
                    localStorage.removeItem('myLastMessage');
                    localStorage.removeItem('blockDuration');
                }
            }

            try {
                const res = await fetch(`${SMD_URL}?action=fetchMessages&t=${Date.now()}`);
                const result = await res.json();

                const messages = result.messages || result.data || [];
                const messagesArea = document.getElementById("messagesArea");

                if (!messagesArea) return;

                const loadingElement = messagesArea.querySelector('.loading');
                if (loadingElement) {
                    loadingElement.remove();
                }

                if (!Array.isArray(messages) || messages.length === 0) {
                    if (messagesArea.children.length === 0) {
                        messagesArea.innerHTML = '<div class="loading">No messages yet ðŸ’¬</div>';
                    }
                    return;
                }

                // ðŸ”Š CHECK FOR NEW RECEIVED MESSAGES
                const receivedMessages = messages.filter(m =>
                    m.studentName.trim().toLowerCase() !== currentUser.name.trim().toLowerCase()
                );

                if (receivedMessages.length > lastReceivedMessageCount) {
                    console.log('ðŸ“© NEW MESSAGE RECEIVED!');

                    // ðŸ”Š RECEIVE SOUND PLAY
                    try {
                        receiveSound.currentTime = 0;
                        receiveSound.play().catch(e => console.log('ðŸ”‡ Receive sound blocked'));
                        console.log('ðŸ”Š RECEIVE SOUND PLAYED!');
                    } catch (e) { }

                    lastReceivedMessageCount = receivedMessages.length;
                }

                // Blue tick logic
                const sentMessages = document.querySelectorAll('.message.sent .status-tick-double');
                if (receivedMessages.length > 0) {
                    sentMessages.forEach(icon => {
                        icon.classList.add('read');
                    });
                }

                const myLastMsg = localStorage.getItem('myLastMessage');
                if (myLastMsg) {
                    const existingMessages = Array.from(messagesArea.querySelectorAll('.message-text'));
                    const hasMyMessage = existingMessages.some(el => el.textContent.trim() === myLastMsg.trim());

                    if (hasMyMessage) {
                        console.log('âœ… Your message already visible');

                        const currentDOMCount = messagesArea.querySelectorAll('.message').length;
                        if (messages.length > currentDOMCount) {
                            const newMessages = messages.slice(currentDOMCount);

                            const hasNewFromOthers = newMessages.some(msg =>
                                msg.studentName.trim().toLowerCase() !== currentUser.name.trim().toLowerCase()
                            );

                            if (hasNewFromOthers) {
                                console.log('ðŸ’™ New message received! Turning to blue tick...');
                                const sentMessages = messagesArea.querySelectorAll('.message.sent');
                                if (sentMessages.length > 0) {
                                    const lastSentMsg = sentMessages[sentMessages.length - 1];
                                    setTimeout(() => {
                                        updateMessageStatus(lastSentMsg, 'read');
                                    }, 100);
                                }
                            }

                            newMessages.forEach((msg, idx) => {
                                if (msg.message.trim() === myLastMsg.trim()) return;

                                const messageDiv = createMessageElement(msg, currentDOMCount + idx);
                                messagesArea.appendChild(messageDiv);
                            });
                            currentMessages = messages;
                        }
                        return;
                    }
                }

                const currentDOMCount = messagesArea.querySelectorAll('.message').length;
                const newMessageCount = messages.length;

                if (currentDOMCount === newMessageCount) {
                    console.log('âœ… No new messages');
                    return;
                }

                console.log(`ðŸ”¥ Fetching ${newMessageCount - currentDOMCount} new messages`);

                currentMessages = messages;
                displayMessages(messages);
                lastMessageCount = newMessageCount;

            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        // ============ DISPLAY MESSAGES ============
        // ============ DISPLAY MESSAGES ============
        function displayMessages(messages) {
            const container = document.getElementById('messagesArea');
            const wasAtBottom = isScrolledToBottom();

            container.innerHTML = '';
            let currentDate = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            messages.forEach((msg, index) => {
                if (!msg.studentName || !msg.message) return;

                const msgDate = new Date(msg.timestamp);
                msgDate.setHours(0, 0, 0, 0);

                const dateStr = formatDate(new Date(msg.timestamp));
                const isTodayMessage = msgDate.getTime() === today.getTime();

                if (dateStr !== currentDate) {
                    currentDate = dateStr;

                    const dateBadge = document.createElement('div');
                    dateBadge.className = 'message-date';
                    dateBadge.setAttribute('data-date', dateStr);
                    dateBadge.setAttribute('data-is-today', isTodayMessage ? 'true' : 'false');
                    dateBadge.innerHTML = `<span class="date-badge">${dateStr}</span>`;
                    container.appendChild(dateBadge);
                }

                const messageDiv = createMessageElement(msg, index);
                container.appendChild(messageDiv);
            });

            if (wasAtBottom || lastMessageCount === 0) {
                scrollToBottom();
            }

            lastMessageCount = messages.length;
        }

        // ðŸ”¥ FIXED: Scroll event pe dynamically hide/show
        function setupScrollListener() {
            const messagesArea = document.getElementById('messagesArea');
            if (!messagesArea) return;

            messagesArea.addEventListener('scroll', () => {
                const badges = messagesArea.querySelectorAll('.message-date');
                if (badges.length === 0) return;

                let todayBadge = null;
                let todayIndex = -1;

                // "Today" badge find karo
                badges.forEach((badge, idx) => {
                    if (badge.getAttribute('data-is-today') === 'true') {
                        todayBadge = badge;
                        todayIndex = idx;
                    }
                });

                if (!todayBadge) return;

                // Today badge ka viewport position check karo
                const todayRect = todayBadge.getBoundingClientRect();
                const viewportTop = 0;

                // Agar Today badge viewport ke top se ABOVE hai
                if (todayRect.top < viewportTop) {
                    // "Today" hide karo aur purane badges visible karo
                    badges.forEach((badge, idx) => {
                        badge.style.opacity = '1';
                        badge.style.pointerEvents = 'auto';
                    });
                } else {
                    // "Today" visible hai top pe â†’ purane badges hide karo
                    badges.forEach((badge, idx) => {
                        if (idx < todayIndex) {
                            badge.style.opacity = '0';  // ðŸ”¥ Invisible but in DOM
                            badge.style.pointerEvents = 'none';
                        } else {
                            badge.style.opacity = '1';
                            badge.style.pointerEvents = 'auto';
                        }
                    });
                }
            });
        }

        // ðŸ”¥ Initialize scroll listener
        window.addEventListener('DOMContentLoaded', setupScrollListener);

        function createMessageElement(msg, index) {
            const messageDiv = document.createElement('div');
            const isSent = msg.studentName.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
            const isDeleted = msg.message === 'Ã¢Å’';
            const isAdminMsg = isAdmin(msg.studentName);

            // âœ… FIX: Admin ko apne msg right side dikhne chahiye
            if (isSent) {
                messageDiv.className = isAdminMsg ? 'message sent admin' : 'message sent';
            } else {
                messageDiv.className = isAdminMsg ? 'message received admin' : 'message received';
            }

            messageDiv.setAttribute('data-index', index);
            messageDiv.setAttribute('data-message', msg.message);
            messageDiv.setAttribute('data-sender', msg.studentName);
            messageDiv.setAttribute('data-timestamp', msg.timestamp);

            const msgDate = new Date(msg.timestamp);
            const time = msgDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const firstLetter = msg.studentName.charAt(0).toUpperCase();

            // Reply HTML
            let replyHTML = '';
            if (msg.replyTo && msg.replyTo.trim() !== '') {
                if (msg.replyTo.includes('|||')) {
                    const replyParts = msg.replyTo.split('|||');
                    if (replyParts.length >= 2) {
                        const replySender = replyParts[0].trim();
                        const replyText = replyParts[1].trim();
                        const replyTextShort = replyText.length > 30 ? replyText.substring(0, 30) + '...' : replyText;

                        replyHTML = `
                    <div class="reply-preview">
                        <div class="reply-name">${escapeHtml(replySender)}</div>
                        <div class="reply-text">${escapeHtml(replyTextShort)}</div>
                    </div>
                `;
                    }
                }
            }

            // Reaction HTML
            let reactionHTML = '';
            if (msg.reaction && msg.reaction !== '' && !msg.reaction.includes('ðŸ•¸')) {
                const reactions = parseReactions(msg.reaction);
                if (reactions.length > 0) {
                    reactionHTML = '<div class="message-reactions">';
                    reactions.forEach(r => {
                        reactionHTML += `<div class="reaction-item" onclick="event.stopPropagation(); showReactionDetails(${index}, '${r.emoji}')">
                    ${r.emoji} <span class="reaction-count">${r.count}</span>
                </div>`;
                    });
                    reactionHTML += '</div>';
                }
            }

            // Avatar HTML
            let avatarHTML = '';
            if (isAdminMsg) {
                avatarHTML = `<div class="message-avatar" style="background: linear-gradient(135deg, #FFE066 0%, #FFB84D 100%); color: white; font-weight: 700; border: 2px solid #FF8C00; text-shadow: 0px 0px 2px black;">ðŸ‘‘</div>`;
            } else {
                const userPhoto = getUserPhoto(msg.studentName);
                if (userPhoto) {
                    avatarHTML = `<div class="message-avatar"><img src="${userPhoto}" alt="${msg.studentName}"></div>`;
                } else {
                    avatarHTML = `<div class="message-avatar">${firstLetter}</div>`;
                }
            }

            // Message text HTML
            let messageTextHTML = '';
            if (isDeleted) {
                messageTextHTML = `<div class="message-text deleted">Deleted</div>`;
            } else {
                const formattedText = msg.message.replace(/\n/g, '<br>');
                const textWithLinks = linkify(formattedText);

                if (isAdminMsg) {
                    messageTextHTML = `<div class="message-text" style="color: #2C3E50; font-weight: 500;">${textWithLinks}</div>`;
                } else {
                    messageTextHTML = `<div class="message-text">${textWithLinks}</div>`;
                }
            }

            // Status icon
            let statusIcon = '';
            if (isSent && !isDeleted && !isAdminMsg) {
                const status = msg.status || 'read';

                if (status === 'sending') {
                    statusIcon = '<span class="message-status status-clock">â±</span>';
                } else if (status === 'sent') {
                    statusIcon = '<span class="message-status status-tick-single">âœ“</span>';
                } else if (status === 'delivered') {
                    statusIcon = '<span class="message-status status-tick-double">âœ“âœ“</span>';
                } else if (status === 'read') {
                    statusIcon = '<span class="message-status status-tick-double read">âœ“âœ“</span>';
                }
            }

            messageDiv.innerHTML = `
        <div class="message-content">
            ${avatarHTML}
            <div class="message-bubble" oncontextmenu="showContextMenu(event, ${index}); return false;" 
                 ontouchstart="handleTouchStart(event, ${index})" 
                 ontouchend="handleTouchEnd(event)"
                 ondblclick="replyMessageByIndex(${index})">
                ${!isSent && !isAdminMsg ? `<div class="message-sender">${escapeHtml(msg.studentName)}</div>` : ''}
                ${isAdminMsg ? `<div class="message-sender">ðŸ“¢ ADMIN</div>` : ''}
                ${replyHTML}
                ${messageTextHTML}
                <div class="message-time">${time}${statusIcon}</div>
                ${reactionHTML}
            </div>
        </div>
    `;

            return messageDiv;
        }

        function linkify(text) {
            const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
        }

        function parseReactions(reactionString) {
            if (!reactionString || reactionString === '' || reactionString.includes('ðŸ•¸')) return [];

            const reactionMap = {};
            const parts = reactionString.split('|');

            parts.forEach(part => {
                if (part.includes(':') && !part.includes('ðŸ•¸')) {
                    const [user, emoji] = part.split(':');
                    if (emoji && emoji !== 'ðŸ•¸') {
                        reactionMap[emoji] = (reactionMap[emoji] || 0) + 1;
                    }
                }
            });

            return Object.entries(reactionMap).map(([emoji, count]) => ({ emoji, count }));
        }

        function showReactionDetails(messageIndex, emoji = null) {
            const msg = currentMessages[messageIndex];
            if (!msg || !msg.reaction || msg.reaction.includes('ðŸ•¸')) return;

            const viewer = document.getElementById('reactionViewer');
            const content = document.getElementById('reactionViewerContent');

            const reactionData = {};
            const parts = msg.reaction.split('|');

            parts.forEach(part => {
                if (part.includes(':') && !part.includes('ðŸ•¸')) {
                    const [user, reactionEmoji] = part.split(':');
                    if (reactionEmoji !== 'ðŸ•¸') {
                        if (!reactionData[reactionEmoji]) {
                            reactionData[reactionEmoji] = [];
                        }
                        reactionData[reactionEmoji].push(user);
                    }
                }
            });

            content.innerHTML = '';

            Object.entries(reactionData).forEach(([reactionEmoji, users]) => {
                if (emoji && emoji !== reactionEmoji) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'reaction-group';

                let html = `<div class="reaction-group-header">${reactionEmoji} ${users.length}</div>`;

                users.forEach(user => {
                    const firstLetter = user.charAt(0).toUpperCase();
                    const isCurrentUser = user.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
                    html += `
                <div class="reaction-user" ${isCurrentUser ? 'onclick="removeReaction(' + messageIndex + ', \'' + reactionEmoji + '\')"' : ''}>
                    <div class="reaction-user-avatar">${firstLetter}</div>
                    <div>${escapeHtml(user)}${isCurrentUser ? ' (Tap to remove)' : ''}</div>
                </div>
            `;
                });

                groupDiv.innerHTML = html;
                content.appendChild(groupDiv);
            });

            viewer.classList.add('active');
        }

        async function removeReaction(messageIndex, emoji) {
            try {
                const reactionData = {
                    action: 'removeReaction',
                    messageIndex: messageIndex,
                    emoji: emoji,
                    userName: currentUser.name
                };

                await fetch(SMD_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(reactionData)
                });

                hideReactionViewer();
                setTimeout(() => fetchMessages(), 200);

            } catch (error) {
                console.error('Remove reaction error:', error);
            }
        }

        function hideReactionViewer() {
            document.getElementById('reactionViewer').classList.remove('active');
        }

        function getUserPhoto(name) {
            if (name.trim().toLowerCase() === currentUser.name.trim().toLowerCase()) {
                return currentUser.photo;
            }
            return null;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = getCurrentDate(); // âœ… Real date use karo

            // Reset time to midnight for accurate comparison
            const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            const diffTime = today.getTime() - msgDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';

            // Format: "Oct 24, Sun"
            const options = { month: 'short', day: 'numeric', weekday: 'short' };
            return msgDate.toLocaleDateString('en-US', options);
        }


        function isScrolledToBottom() {
            const container = document.getElementById('messagesArea');
            return container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesArea');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        }

        // ============ CONTEXT MENU ============
        // ============ CONTEXT MENU ============
        let touchTimer = null;
        let touchStartTime = 0;

        function handleTouchStart(e, index) {
            touchStartTime = Date.now();

            // Copy message after 1 second hold
            touchTimer = setTimeout(() => {
                const msgElement = document.querySelector(`[data-index="${index}"]`);
                const text = msgElement.getAttribute('data-message');

                if (text === 'âŒ' || text === 'Deleted') {
                    return;
                }

                // Copy to clipboard
                navigator.clipboard.writeText(text).then(() => {
                    // Vibrate if supported
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    showCopyToast();
                }).catch(err => {
                    console.error('Copy failed:', err);
                });

            }, 1000); // 1 second hold
        }

        function handleTouchEnd(e) {
            clearTimeout(touchTimer);

            // If released before 1 second, show context menu
            const holdDuration = Date.now() - touchStartTime;
            if (holdDuration < 1000) {
                // Short tap - do nothing or show context menu if needed
            }
        }

        function showContextMenu(e, index) {
            e.preventDefault();
            const menu = document.getElementById('contextMenu');
            const deleteOption = document.getElementById('deleteOption');
            selectedMessage = index;

            const msgElement = document.querySelector(`[data-index="${index}"]`);
            if (msgElement) {
                const sender = msgElement.getAttribute('data-sender');
                const message = msgElement.getAttribute('data-message');
                const isOwnMessage = sender.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
                const isDeleted = message === 'âŒ';

                deleteOption.style.display = (isOwnMessage && !isDeleted) ? 'flex' : 'none';
            }

            let x = e.pageX || (e.touches && e.touches[0] ? e.touches[0].pageX : 0);
            let y = e.pageY || (e.touches && e.touches[0] ? e.touches[0].pageY : 0);

            const menuWidth = 150;
            const menuHeight = 220;

            if (x + menuWidth > window.innerWidth) {
                x = window.innerWidth - menuWidth - 10;
            }
            if (x < 10) {
                x = 10;
            }

            if (y + menuHeight > window.innerHeight) {
                y = window.innerHeight - menuHeight - 10;
            }
            if (y < 10) {
                y = 10;
            }

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        // REPLACE WITH:
        function copyMessage() {
            const msgElement = document.querySelector(`[data-index="${selectedMessage}"]`);
            const text = msgElement.getAttribute('data-message');

            if (text === 'âŒ' || text === 'Deleted') {
                alert('Cannot copy deleted messages');
                hideContextMenu();
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                showCopyToast();
            }).catch(err => {
                console.error('Copy failed:', err);
            });
            hideContextMenu();
        }

        function showCopyToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // ===============================
        // âœ… REPLY SYSTEM FIXED VERSION
        // ===============================

        // âœ… When user clicks â€œReplyâ€ from context menu
        function replyMessage() {
            if (!selectedMessage) return;

            const msgBubble = selectedMessage.querySelector('.message-text');
            const senderName = selectedMessage.querySelector('.message-sender')?.textContent || 'Unknown';
            const msgText = msgBubble?.textContent || '';

            // Save reply target
            replyToMessage = {
                sender: senderName,
                text: msgText
            };

            // Show reply bar
            const replyBar = document.getElementById('replyBar');
            replyBar.classList.add('active');
            document.getElementById('replyName').textContent = senderName;
            document.getElementById('replyText').textContent = msgText.slice(0, 60);
        }

        function replyMessageByIndex(index) {
            const msgElement = document.querySelector(`[data-index="${index}"]`);
            if (!msgElement) return;

            const sender = msgElement.getAttribute('data-sender');
            const text = msgElement.getAttribute('data-message');

            if (text === 'âŒ') return;

            replyToMessage = { sender, text };

            document.getElementById('replyName').textContent = sender;
            const displayText = text.length > 50 ? text.substring(0, 50) + '...' : text;
            document.getElementById('replyText').textContent = displayText;
            document.getElementById('replyBar').classList.add('active');
            document.getElementById('messageInput').focus();
        }

        // âœ… Cancel reply
        function cancelReply() {
            replyToMessage = null;
            document.getElementById('replyBar').classList.remove('active');
            document.getElementById('replyName').textContent = '';
            document.getElementById('replyText').textContent = '';
        }


        async function deleteMessage() {
            if (!selectedMessage) return;

            const msgIndex = selectedMessage.getAttribute('data-index');
            const sender = selectedMessage.getAttribute('data-sender');

            if (!msgIndex) {
                alert("âš ï¸ Message index not found!");
                return;
            }

            if (sender.trim().toLowerCase() !== currentUser.name.trim().toLowerCase()) {
                alert("âŒ You can only delete your own messages!");
                return;
            }

            if (!confirm("ðŸ—‘ï¸ Delete this message for everyone?")) return;

            try {
                const deleteData = {
                    action: "deleteMessage",
                    studentName: currentUser.name,
                    messageIndex: msgIndex
                };

                const res = await fetch(SMD_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(deleteData)
                });

                const result = await res.json();
                console.log("Delete Response:", result);

                if (result.success) {
                    // âœ… Instantly refresh messages after delete
                    if (result.messages) {
                        currentMessages = result.messages;
                        displayMessages(result.messages);
                    } else {
                        // fallback: re-fetch manually
                        fetchMessagesWithFilter();
                    }
                    alert("âœ… Message deleted successfully!");
                } else {
                    alert("âŒ " + result.message);
                }
            } catch (err) {
                console.error("Delete error:", err);
                alert("âš ï¸ Error deleting message: " + err.message);
            } finally {
                hideContextMenu();
            }
        }



        // ============ MEMBERS SIDEBAR ============
        // ============ MEMBERS SIDEBAR ============
        async function toggleMembersSidebar() {
            const sidebar = document.getElementById('membersSidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                await loadMembers();
            }
        }

        async function loadMembers() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '<div class="loading">Loading members...</div>';

            try {
                const response = await fetch(`${SAD_URL}?action=getAllStudents&t=${Date.now()}`);
                const data = await response.json();

                console.log('Members API Response:', data); // Debug log

                if (!data.success || !data.students || data.students.length === 0) {
                    membersList.innerHTML = '<div class="loading">No members found</div>';
                    return;
                }

                document.getElementById('onlineCount').textContent = `${data.students.length} members`;

                membersList.innerHTML = '';

                data.students.forEach(student => {
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'member-item';

                    const firstLetter = student.name.charAt(0).toUpperCase();
                    const rollNo = student.rollNo || 'N/A';

                    memberDiv.innerHTML = `
                <div class="member-avatar">${firstLetter}</div>
                <div class="member-info">
                    <div class="member-name">${escapeHtml(student.name)}</div>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 2px;">Roll No: ${escapeHtml(rollNo)}</div>
                </div>
            `;

                    membersList.appendChild(memberDiv);
                });

            } catch (error) {
                console.error('Error loading members:', error);
                membersList.innerHTML = '<div class="loading">Error loading members</div>';
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // ============ WALLPAPER ============
        function loadWallpapers() {
            const grid = document.getElementById('wallpaperGrid');
            grid.innerHTML = '';

            const savedWallpaper = localStorage.getItem('chatWallpaper');

            // Rest wallpapers (Wallpaper 2, 3, 4... direct start)
            WALLPAPERS.forEach(wallpaper => {
                const item = document.createElement('div');
                item.className = 'wallpaper-item';

                if (savedWallpaper === wallpaper.url) {
                    item.classList.add('active');
                }

                item.onclick = () => setWallpaper(wallpaper.url, item);
                item.innerHTML = `<img src="${wallpaper.url}" alt="${wallpaper.name}">`;
                grid.appendChild(item);
            });

            // Load custom wallpapers from localStorage
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');
            customWallpapers.forEach(wallpaperUrl => {
                const item = document.createElement('div');
                item.className = 'wallpaper-item';

                if (savedWallpaper === wallpaperUrl) {
                    item.classList.add('active');
                }

                item.onclick = () => setWallpaper(wallpaperUrl, item);
                item.innerHTML = `<img src="${wallpaperUrl}" alt="Custom">`;
                grid.appendChild(item);
            });

            // Apply saved wallpaper
            if (savedWallpaper && savedWallpaper !== 'none') {
                document.getElementById('messagesArea').style.backgroundImage = `url(${savedWallpaper})`;
            } else {
                // âœ… Default wallpaper (theme ke hisaab se)
                const theme = localStorage.getItem('theme') || 'dark';
                const defaultWallpaper = theme === 'light'
                    ? 'https://i.pinimg.com/1200x/65/43/08/6543080537d11e105e6039f1a17a939e.jpg'
                    : 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
                document.getElementById('messagesArea').style.backgroundImage = `url(${defaultWallpaper})`;
            }
        }

        // ============ LOAD CUSTOM WALLPAPER COUNT ============
        function loadCustomWallpaperCount() {
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');
            customWallpaperCount = customWallpapers.length;

            // Debug log
            console.log(`ðŸ“¸ Custom Wallpapers Uploaded: ${customWallpaperCount}/1`);
        }

        function setWallpaper(url, element) {
            const messagesArea = document.getElementById('messagesArea');

            // âœ… REMOVE: none check (ab none nahi hai)
            messagesArea.style.backgroundImage = `url(${url})`;
            localStorage.setItem('chatWallpaper', url);

            // Update active state
            document.querySelectorAll('.wallpaper-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
        }

        // ============ SINGLE WALLPAPER UPLOAD ONLY ============
        async function uploadCustomWallpaper(e) {
            const file = e.target.files[0];
            if (!file) return;

            // âœ… Check if user already uploaded a custom wallpaper
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');

            if (customWallpapers.length >= 1) {
                alert('âŒ You already uploaded a wallpaper!\n\nâš ï¸ You can only upload ONE custom wallpaper.');
                e.target.value = ''; // Reset file input
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('âŒ Please select an image file');
                e.target.value = '';
                return;
            }

            try {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const customUrl = event.target.result;

                    // Save to localStorage
                    customWallpapers.push(customUrl);
                    localStorage.setItem('customWallpapers', JSON.stringify(customWallpapers));

                    // Add to grid
                    const grid = document.getElementById('wallpaperGrid');
                    const customItem = document.createElement('div');
                    customItem.className = 'wallpaper-item';
                    customItem.onclick = () => setWallpaper(customUrl, customItem);
                    customItem.innerHTML = `<img src="${customUrl}" alt="Custom">`;
                    grid.appendChild(customItem);

                    // Set as active wallpaper
                    setWallpaper(customUrl, customItem);

                    alert('âœ… Wallpaper uploaded successfully!\n\nðŸ”’ You cannot upload more wallpapers.');
                };
                reader.readAsDataURL(file);
            } catch (error) {
                alert('âŒ Error uploading wallpaper');
            }

            // Reset file input
            e.target.value = '';
        }

        // ============ FONT SIZE ============
        function changeFontSize(delta) {
            const root = document.documentElement;
            const current = parseInt(getComputedStyle(root).getPropertyValue('--font-size'));
            const newSize = Math.max(12, Math.min(20, current + delta));
            root.style.setProperty('--font-size', newSize + 'px');
            document.getElementById('fontSizeDisplay').textContent = newSize + 'px';
            localStorage.setItem('fontSize', newSize);
        }

        function applySettings() {
            const wallpaper = localStorage.getItem('chatWallpaper');

            // âœ… Default wallpaper if nothing saved
            if (!wallpaper || wallpaper === 'none') {
                const defaultWallpaper = 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
                document.getElementById('messagesArea').style.backgroundImage = `url(${defaultWallpaper})`;
                localStorage.setItem('chatWallpaper', defaultWallpaper);
            } else {
                document.getElementById('messagesArea').style.backgroundImage = `url(${wallpaper})`;
            }

            const fontSize = localStorage.getItem('fontSize');
            if (fontSize) {
                document.documentElement.style.setProperty('--font-size', fontSize + 'px');
                document.getElementById('fontSizeDisplay').textContent = fontSize + 'px';
            }

            const theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
        }

        // ============ PROFILE FUNCTIONS ============
        function showProfile() {
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            chatContainer.classList.remove('active');
            chatContainer.style.display = 'none';
            profilePage.classList.add('active');
            profilePage.style.display = 'flex';

            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profilePhone').textContent = currentUser.phone;
            document.getElementById('profileRollNo').textContent = currentUser.rollNo; // Added Roll Number
            document.getElementById('profilePhotoLarge').src = currentUser.photo;
        }

        function hideProfile() {
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            profilePage.classList.remove('active');
            profilePage.style.display = 'none';
            chatContainer.classList.add('active');
            chatContainer.style.display = 'flex';
        }
        async function updateProfilePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('âŒ Please upload a valid image');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('âŒ Image size should be less than 5MB');
                return;
            }

            try {
                const photoBase64 = await fileToBase64(file);
                currentUser.photo = photoBase64;
                localStorage.setItem('chatUser', JSON.stringify(currentUser));

                document.getElementById('profilePhotoLarge').src = photoBase64;
                document.getElementById('headerProfilePhoto').src = photoBase64;
                document.getElementById('inputProfilePhoto').src = photoBase64;

                alert('âœ… Profile photo updated!');
            } catch (error) {
                console.error('Update photo error:', error);
                alert('âŒ Error updating photo. Please try again.');
            }
        }

        // ============ LOGOUT ============
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('chatUser');
                localStorage.removeItem('pwaInstallAccepted');  // ðŸ‘ˆ YEH ADD KAR
                currentUser = null;

                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('chatUser');
                    currentUser = null;
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                    document.getElementById('profilePage').classList.remove('active');
                    document.getElementById('chatContainer').classList.remove('active');
                    showSignup();
                    fingerprintVerified = false;
                    document.getElementById('fingerprintBtn').disabled = false;
                    document.getElementById('fingerprintBtn').style.background = 'linear-gradient(135deg, var(--accent) 0%, #00d9a8 100%)';
                    document.getElementById('fingerprintStatus').textContent = 'Tap to scan fingerprint';
                    document.getElementById('fingerprintStatus').style.color = 'var(--text-secondary)';
                    document.getElementById('signupBtn').disabled = true;
                    document.getElementById('signupForm').reset();
                    document.getElementById('signupPhotoPreview').innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        `;
                }
            }
        }

        // ============ THEME TOGGLE ============
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // ðŸ”¥ WALLPAPER AUTO-SWITCH ON THEME CHANGE
            const messagesArea = document.getElementById('messagesArea');

            if (newTheme === 'light') {
                // Light theme = Light wallpaper
                const lightWallpaper = 'https://i.pinimg.com/1200x/65/43/08/6543080537d11e105e6039f1a17a939e.jpg';
                messagesArea.style.backgroundImage = `url(${lightWallpaper})`;
                localStorage.setItem('chatWallpaper', lightWallpaper);
            } else {
                // Dark theme = Default dark wallpaper
                const darkWallpaper = 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
                messagesArea.style.backgroundImage = `url(${darkWallpaper})`;
                localStorage.setItem('chatWallpaper', darkWallpaper);
            }
        }

        // ============ PAGE NAVIGATION ============
        function showSignup() {
            const signupPage = document.getElementById('signupPage');
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            // Hide everything first
            chatContainer.classList.remove('active');
            chatContainer.style.display = 'none';
            profilePage.classList.remove('active');
            profilePage.style.display = 'none';

            // Show signup
            signupPage.classList.remove('hidden');
            signupPage.style.display = 'flex';
        }

        function showChat() {
            const signupPage = document.getElementById('signupPage');
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            // Hide everything first
            signupPage.classList.add('hidden');
            signupPage.style.display = 'none';
            profilePage.classList.remove('active');
            profilePage.style.display = 'none';

            // Show chat
            chatContainer.classList.add('active');
            chatContainer.style.display = 'flex';

            if (currentUser && currentUser.photo) {
                document.getElementById('headerProfilePhoto').src = currentUser.photo;
                document.getElementById('inputProfilePhoto').src = currentUser.photo;
            }

            // âœ… Set default wallpaper
            const wallpaper = localStorage.getItem('chatWallpaper');
            if (!wallpaper || wallpaper === 'none') {
                const defaultWallpaper = 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
                document.getElementById('messagesArea').style.backgroundImage = `url(${defaultWallpaper})`;
                localStorage.setItem('chatWallpaper', defaultWallpaper);
            }
        }

        // ============ HELPER FUNCTIONS ============
        // ============ IMPROVED FILE TO BASE64 WITH FALLBACK ============
        // ============ AUTO COMPRESS ANY SIZE IMAGE ============
        // ============ HIGH QUALITY COMPRESSION ============
        // ============ ORIGINAL QUALITY - NO COMPRESSION ============
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('No file provided'));
                    return;
                }

                const reader = new FileReader();

                reader.onload = (e) => {
                    // ðŸ”¥ DIRECT BASE64 - NO CANVAS, NO COMPRESSION!
                    const base64 = e.target.result;

                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    console.log(`âœ… Original Quality Saved: ${fileSizeMB}MB - NO compression applied!`);

                    resolve(base64);
                };

                reader.onerror = () => {
                    console.error('File read failed');
                    reject(new Error('File read failed'));
                };

                reader.readAsDataURL(file);
            });
        }

        document.getElementById("contextMenuDelete").onclick = deleteMessage;


        // ============ SECURITY VERIFICATION SYSTEM ============

        // Check which verification method to show
        function showSecurityVerification() {
            const securityPage = document.getElementById('securityPage');
            const fingerprintSection = document.getElementById('fingerprintVerifySection');
            const passwordSection = document.getElementById('passwordVerifySection');

            const userData = JSON.parse(localStorage.getItem('chatUser'));

            if (!userData) {
                showSignup();
                return;
            }

            // Check if user has password in localStorage
            if (userData.password) {
                // Show password verification
                passwordSection.classList.remove('hidden');
                fingerprintSection.classList.add('hidden');
            } else {
                // Show fingerprint verification
                fingerprintSection.classList.remove('hidden');
                passwordSection.classList.add('hidden');
            }

            securityPage.classList.remove('hidden');
        }

        // Verify Fingerprint (same as signup fingerprint)
        async function verifyFingerprint() {
            const btn = document.querySelector('#fingerprintVerifySection .fingerprint-button');
            const status = document.getElementById('fingerprintVerifyStatus');
            const currentHost = window.location.hostname;
            const isLocalhost = currentHost === 'localhost' || currentHost === '127.0.0.1';

            btn.disabled = true;
            status.textContent = 'Scanning fingerprint...';
            btn.style.transform = 'scale(0.95)';

            try {
                if (isLocalhost) {
                    await new Promise(res => setTimeout(res, 800));
                    onVerificationSuccess();
                    return;
                }

                if (!window.PublicKeyCredential) {
                    throw new Error('Biometric authentication not supported');
                }

                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                if (!available) {
                    throw new Error('No biometric authenticator available');
                }

                const challenge = window.crypto.getRandomValues(new Uint8Array(32));
                const userId = window.crypto.getRandomValues(new Uint8Array(16));

                const publicKeyCreate = {
                    challenge: challenge.buffer,
                    rp: { name: "Class Group Chat" },
                    user: {
                        id: userId.buffer,
                        name: "student@" + window.location.hostname,
                        displayName: "Student"
                    },
                    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        userVerification: "required",
                        requireResidentKey: false
                    },
                    timeout: 60000,
                    attestation: "none"
                };

                try {
                    const credential = await navigator.credentials.create({ publicKey: publicKeyCreate });
                    if (credential) {
                        onVerificationSuccess();
                        return;
                    }
                } catch (createErr) {
                    console.warn('create() failed, trying get():', createErr);
                }

                const publicKeyGet = {
                    challenge: window.crypto.getRandomValues(new Uint8Array(32)).buffer,
                    timeout: 60000,
                    userVerification: "required",
                };

                const assertion = await navigator.credentials.get({ publicKey: publicKeyGet });
                if (assertion) {
                    onVerificationSuccess();
                    return;
                } else {
                    throw new Error('Verification failed');
                }

            } catch (err) {
                console.error('Fingerprint verification error:', err);
                status.textContent = 'âŒ Verification Failed';
                status.style.color = '#ff4c4c';
                alert('âŒ Fingerprint verification failed!\n\nPlease try again.');
                btn.disabled = false;
                btn.style.transform = 'scale(1)';
            }
        }

        // Verify Password
        function verifyPassword() {
            const inputPassword = document.getElementById('verifyPassword').value.trim();
            const userData = JSON.parse(localStorage.getItem('chatUser'));

            if (!inputPassword) {
                alert('âŒ Please enter password');
                return;
            }

            if (inputPassword === userData.password) {
                onVerificationSuccess();
            } else {
                alert('âŒ Incorrect password!\n\nVerification failed.');
                document.getElementById('verifyPassword').value = '';
            }
        }

        // On successful verification
        function onVerificationSuccess() {
            // Set session flag (cleared on tab close)
            sessionStorage.setItem('verified', 'true');

            // Hide security page and show chat
            document.getElementById('securityPage').classList.add('hidden');
            showChat();
            loadWallpapers();
            startMessageRefresh();
            loadOnlineCount();
            startStatusMonitoring();
        }

        function openProject() {
            window.open('https://salikweber0.github.io/Professional-Protfolio/', '_blank');
        }
    </script>

    <script>
        async function saveOneSignalToken(studentName) {
            try {
                const playerId = await OneSignal.getUserId();
                if (!playerId) {
                    console.log("âŒ No OneSignal playerId found");
                    return;
                }

                await fetch(SAD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'saveToken',
                        studentName: studentName,
                        token: playerId
                    })
                });
                console.log("âœ… OneSignal Token saved:", playerId);
            } catch (err) {
                console.error("Token save error:", err);
            }
        }
    </script>
    <!-- End OneSignal -->

    <script>
        // ============ ROLL NUMBER LIVE VALIDATION ============
        function validateRollNumber(input) {
            // Remove non-digit characters
            input.value = input.value.replace(/[^\d]/g, '');

            // Limit to 4 digits
            if (input.value.length > 4) {
                input.value = input.value.slice(0, 4);
            }

            // Visual feedback
            const rollNo = input.value;

            if (rollNo.length === 0) {
                input.style.borderColor = 'var(--border-color)';
                return;
            }

            // Check if starts with 0
            if (rollNo.startsWith('0')) {
                input.style.borderColor = '#ff4c4c';
                input.style.boxShadow = '0 0 5px rgba(255, 76, 76, 0.3)';
                return;
            }

            // Check if valid 4 digits
            if (rollNo.length === 4) {
                const num = parseInt(rollNo);
                if (num >= 1000 && num <= 9999) {
                    input.style.borderColor = '#00a884';
                    input.style.boxShadow = '0 0 5px rgba(0, 168, 132, 0.3)';
                } else {
                    input.style.borderColor = '#ff4c4c';
                    input.style.boxShadow = '0 0 5px rgba(255, 76, 76, 0.3)';
                }
            } else {
                input.style.borderColor = 'var(--border-color)';
                input.style.boxShadow = 'none';
            }
        }
    </script>

    <script>
        // ============ PREMIUM SYSTEM VARIABLES ============
        let selectedWallpaperUrl = null;
        let trialTimer = null;
        let premiumCheckInterval = null;

        // ============ PREMIUM STATUS CHECK ============
        function checkPremiumStatus() {
            const premiumData = JSON.parse(localStorage.getItem('premiumData') || '{}');

            if (!premiumData.status || premiumData.status !== 'active') {
                return false;
            }

            // Check expiry
            const expiryDate = new Date(premiumData.expiryDate);
            const now = new Date();

            if (now > expiryDate) {
                // Premium expired
                localStorage.removeItem('premiumData');
                resetToDefaultWallpaper();
                return false;
            }

            return true;
        }

        // ============ LOAD WALLPAPERS WITH LOCK ============
        function loadWallpapers() {
            const grid = document.getElementById('wallpaperGrid');
            grid.innerHTML = '';

            const savedWallpaper = localStorage.getItem('chatWallpaper');
            const isPremium = checkPremiumStatus();
            const trialUsed = JSON.parse(localStorage.getItem('wallpaperTrials') || '{}');

            WALLPAPERS.forEach((wallpaper, index) => {
                const item = document.createElement('div');
                item.className = 'wallpaper-item';

                if (savedWallpaper === wallpaper.url) {
                    item.classList.add('active');
                }

                // Wallpaper image
                item.innerHTML = `<img src="${wallpaper.url}" alt="${wallpaper.name}">`;

                // Add lock overlay if not premium
                if (!isPremium) {
                    const lockDiv = document.createElement('div');
                    lockDiv.className = 'wallpaper-lock';
                    lockDiv.innerHTML = 'ðŸ”’';
                    lockDiv.onclick = () => showWallpaperPreview(wallpaper.url);
                    item.appendChild(lockDiv);
                } else {
                    // Premium user - direct click to set
                    item.onclick = () => setWallpaper(wallpaper.url, item);
                }

                grid.appendChild(item);
            });

            // Load custom wallpapers
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');
            customWallpapers.forEach(wallpaperUrl => {
                const item = document.createElement('div');
                item.className = 'wallpaper-item';

                if (savedWallpaper === wallpaperUrl) {
                    item.classList.add('active');
                }

                item.innerHTML = `<img src="${wallpaperUrl}" alt="Custom">`;

                if (!isPremium) {
                    const lockDiv = document.createElement('div');
                    lockDiv.className = 'wallpaper-lock';
                    lockDiv.innerHTML = 'ðŸ”’';
                    lockDiv.onclick = () => showWallpaperPreview(wallpaperUrl);
                    item.appendChild(lockDiv);
                } else {
                    item.onclick = () => setWallpaper(wallpaperUrl, item);
                }

                grid.appendChild(item);
            });

            // Apply saved wallpaper
            if (savedWallpaper && savedWallpaper !== 'none') {
                document.getElementById('messagesArea').style.backgroundImage = `url(${savedWallpaper})`;
            } else {
                const theme = localStorage.getItem('theme') || 'dark';
                const defaultWallpaper = theme === 'light'
                    ? 'https://i.pinimg.com/1200x/65/43/08/6543080537d11e105e6039f1a17a939e.jpg'
                    : 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
                document.getElementById('messagesArea').style.backgroundImage = `url(${defaultWallpaper})`;
            }
        }

        // ============ WALLPAPER PREVIEW ============
        function showWallpaperPreview(wallpaperUrl) {
            selectedWallpaperUrl = wallpaperUrl;
            const preview = document.getElementById('wallpaperPreview');
            const img = document.getElementById('previewImage');

            img.src = wallpaperUrl;
            preview.classList.add('active');

            // Check if trial already used for this wallpaper
            const trialUsed = JSON.parse(localStorage.getItem('wallpaperTrials') || '{}');
            const trialBtn = document.querySelector('.trial-btn');

            if (trialUsed[wallpaperUrl]) {
                trialBtn.textContent = 'âŒ Trial Used';
                trialBtn.style.background = '#888';
                trialBtn.style.cursor = 'not-allowed';
                trialBtn.onclick = () => {
                    alert('âš ï¸ Free trial already used for this wallpaper!\n\nGet Premium to unlock unlimited access.');
                };
            } else {
                trialBtn.textContent = 'ðŸŸ¢ Free Trial (30s)';
                trialBtn.style.background = 'linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%)';
                trialBtn.style.cursor = 'pointer';
                trialBtn.onclick = startFreeTrial;
            }
        }

        function closeWallpaperPreview() {
            document.getElementById('wallpaperPreview').classList.remove('active');
            selectedWallpaperUrl = null;
        }

        // ============ FREE TRIAL SYSTEM (30 SECONDS) ============
        function startFreeTrial() {
            if (!selectedWallpaperUrl) return;

            // Check if already used
            const trialUsed = JSON.parse(localStorage.getItem('wallpaperTrials') || '{}');
            if (trialUsed[selectedWallpaperUrl]) {
                alert('âš ï¸ Free trial already used for this wallpaper!');
                return;
            }

            // Apply wallpaper
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.style.backgroundImage = `url(${selectedWallpaperUrl})`;

            // Close preview
            closeWallpaperPreview();

            // Show timer toast
            const toast = document.getElementById('trialTimerToast');
            let timeLeft = 30;

            toast.textContent = `â° Trial: ${timeLeft}s remaining`;
            toast.classList.add('show');

            trialTimer = setInterval(() => {
                timeLeft--;
                toast.textContent = `â° Trial: ${timeLeft}s remaining`;

                if (timeLeft <= 0) {
                    clearInterval(trialTimer);
                    toast.classList.remove('show');

                    // Reset to default wallpaper
                    resetToDefaultWallpaper();

                    // Mark trial as used
                    trialUsed[selectedWallpaperUrl] = true;
                    localStorage.setItem('wallpaperTrials', JSON.stringify(trialUsed));

                    // Show premium popup
                    setTimeout(() => {
                        alert('â° Trial ended!\n\nðŸ’› Get Premium for unlimited access to all wallpapers.');
                    }, 500);
                }
            }, 1000);
        }

        // ============ RESET TO DEFAULT WALLPAPER ============
        function resetToDefaultWallpaper() {
            const theme = localStorage.getItem('theme') || 'dark';
            const defaultWallpaper = theme === 'light'
                ? 'https://i.pinimg.com/1200x/65/43/08/6543080537d11e105e6039f1a17a939e.jpg'
                : 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';

            document.getElementById('messagesArea').style.backgroundImage = `url(${defaultWallpaper})`;
            localStorage.setItem('chatWallpaper', defaultWallpaper);
        }

        // ============ PREMIUM PAGE ============
        function showPremiumPage() {
            document.getElementById('premiumPage').classList.add('active');
            updatePremiumTimer();
        }

        function hidePremiumPage() {
            document.getElementById('premiumPage').classList.remove('active');
        }

        function updatePremiumTimer() {
            const timerDiv = document.getElementById('premiumTimer');
            const getPremiumBtn = document.getElementById('getPremiumBtn');
            const premiumData = JSON.parse(localStorage.getItem('premiumData') || '{}');

            if (premiumData.status === 'active') {
                const expiryDate = new Date(premiumData.expiryDate);
                const now = new Date();
                const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

                if (daysLeft > 0) {
                    timerDiv.innerHTML = `âœ… Premium Active<br><span style="font-size: 16px; color: var(--accent);">${daysLeft} days remaining</span>`;
                    // âœ… HIDE BUTTON
                    if (getPremiumBtn) getPremiumBtn.style.display = 'none';
                } else {
                    timerDiv.textContent = 'âŒ Premium Expired';
                    localStorage.removeItem('premiumData');
                    // âœ… SHOW BUTTON
                    if (getPremiumBtn) getPremiumBtn.style.display = 'block';
                }
            } else {
                timerDiv.textContent = 'ðŸ”’ Premium Not Active';
                // âœ… SHOW BUTTON
                if (getPremiumBtn) getPremiumBtn.style.display = 'block';
            }
        }

        // ============ PAYMENT PAGE ============
        function showPaymentPage() {
            // Close other pages
            closeWallpaperPreview();
            hidePremiumPage();

            document.getElementById('paymentPage').classList.add('active');
        }

        function hidePaymentPage() {
            document.getElementById('paymentPage').classList.remove('active');
        }

        // ============ ABOUT PAGE ============
        function showAboutPage() {
            document.getElementById('aboutPage').classList.add('active');
        }

        function hideAboutPage() {
            document.getElementById('aboutPage').classList.remove('active');
        }

        function openWhatsApp() {
            if (!currentUser) {
                alert('âš ï¸ User data not found!');
                return;
            }

            const message = `Hi Salik, I am ${currentUser.name}, Roll No: ${currentUser.rollNo}`;
            const whatsappUrl = `https://wa.me/917069331761?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // ============ CHECK PREMIUM FROM ADMIN SHEET ============
        async function checkPremiumFromSheet() {
            if (!currentUser || !currentUser.rollNo) return;

            try {
                const response = await fetch(`${PREMIUM_URL}?action=checkPremium&rollNo=${encodeURIComponent(currentUser.rollNo)}&t=${Date.now()}`);
                const data = await response.json();

                console.log('âœ… Premium API Response:', data);

                if (data.success && data.isPremium === 'yes') {
                    // Activate premium
                    const premiumData = {
                        status: 'active',
                        activatedDate: new Date().toISOString(),
                        expiryDate: new Date(Date.now() + 31 * 24 * 60 * 60 * 1000).toISOString()
                    };

                    localStorage.setItem('premiumData', JSON.stringify(premiumData));
                    console.log('ðŸ’Ž Premium activated for Roll No:', currentUser.rollNo);

                    // Reload wallpapers to remove locks
                    loadWallpapers();

                    alert('ðŸŽ‰ Premium Activated!\n\nAll wallpapers unlocked for 31 days.');
                } else {
                    console.log('ðŸ”’ Premium not active for Roll No:', currentUser.rollNo);
                }
            } catch (error) {
                console.error('âŒ Premium check error:', error);
            }
        }

        // ============ START PREMIUM MONITORING ============
        function startPremiumMonitoring() {
            // Initial check
            checkPremiumFromSheet();

            // Check every 30 seconds
            if (premiumCheckInterval) {
                clearInterval(premiumCheckInterval);
            }

            premiumCheckInterval = setInterval(() => {
                checkPremiumFromSheet();
            }, 30000); // 30 seconds
        }

        // ============ MODIFIED showChat() - ADD PREMIUM CHECK ============
        // REPLACE YOUR EXISTING showChat() FUNCTION WITH THIS:
        function showChat() {
            const signupPage = document.getElementById('signupPage');
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            signupPage.classList.add('hidden');
            signupPage.style.display = 'none';
            profilePage.classList.remove('active');
            profilePage.style.display = 'none';

            chatContainer.classList.add('active');
            chatContainer.style.display = 'flex';

            if (currentUser && currentUser.photo) {
                document.getElementById('headerProfilePhoto').src = currentUser.photo;
                document.getElementById('inputProfilePhoto').src = currentUser.photo;
            }

            const wallpaper = localStorage.getItem('chatWallpaper');
            if (!wallpaper || wallpaper === 'none') {
                const defaultWallpaper = 'https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg';
                document.getElementById('messagesArea').style.backgroundImage = `url(${defaultWallpaper})`;
                localStorage.setItem('chatWallpaper', defaultWallpaper);
            }

            // âœ… START PREMIUM MONITORING
            startPremiumMonitoring();
        }
    </script>

</body>

</html>
