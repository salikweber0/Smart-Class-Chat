<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Class Group Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        :root {
            --bg-primary: #111b21;
            --bg-secondary: #0b141a;
            --bg-chat: #0b141a;
            --bg-input: #2a3942;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --bubble-sent: #005c4b;
            --bubble-received: #202c33;
            --border-color: #2a3942;
            --accent: #00a884;
            --header-bg: #202c33;
            --header-text: #e9edef;
            --font-size: 14px;
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-chat: #efeae2;
            --bg-input: #ffffff;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --bubble-sent: #d9fdd3;
            --bubble-received: #ffffff;
            --border-color: #d1d7db;
            --accent: #00a884;
            --header-bg: #008069;
            --header-text: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        /* Loader Animation */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-container.hidden {
            display: none;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Desktop/Tablet Block */
        .device-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            text-align: center;
        }

        .device-warning.active {
            display: flex;
        }

        .warning-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .warning-title {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .warning-text {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Fingerprint Scanner */
        .fingerprint-section {
            margin: 20px 0;
            text-align: center;
        }

        .fingerprint-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #00d9a8 100%);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0, 168, 132, 0.3);
        }

        .fingerprint-button:active {
            transform: scale(0.95);
        }

        .fingerprint-button svg {
            width: 60px;
            height: 60px;
            fill: white;
        }

        .fingerprint-status {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            background: var(--bg-primary);
            overflow-y: auto;
        }

        .auth-box {
            background: var(--bg-secondary);
            padding: 100px 30px 70px 30px !important;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            text-align: center;
            margin-top: 150px;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: var(--accent);
            font-size: 24px;
            margin-bottom: 5px;
        }

        .profile-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            border: 3px solid var(--accent);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-btn {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            background: var(--header-bg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .group-info h2,
        .group-info p {
            color: var(--header-text);
        }

        .group-info h2 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .group-info p {
            font-size: 13px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle,
        .profile-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            color: var(--header-text);
        }

        .profile-icon img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 10px 70px 10px;
            -webkit-overflow-scrolling: touch;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: scroll;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
        }

        [data-theme="light"] .messages-area {
            background-color: #e5ddd5;
        }

        .message-date {
            text-align: center;
            margin: 20px 0 10px 0;
            position: sticky;
            top: 10px;
            z-index: 10;
        }

        .date-badge {
            width: 130px;
            text-align: center;
            display: inline-block;
            background: var(--bg-input);
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            margin: 10px auto;
            /* display: inline-block;
            background: var(--bg-input);
            padding: 5px 12px;
            border-radius: 7px;
            font-size: 12px;
            color: var(--text-secondary);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            width: 150px; */
            /* ‚úÖ Fixed width */
            /* text-align: center; */
            /* Center text inside */
        }


        .message {
            display: flex;
            margin-bottom: 8px;
            position: relative;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-content {
            display: flex;
            gap: 8px;
            max-width: 75%;
            position: relative;
        }

        .message.sent .message-content {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.sent .message-avatar {
            display: none;
        }

        .message-bubble {
            background: var(--bubble-received);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            user-select: none;
            position: relative;
            max-width: 100%;
        }

        .message.sent .message-bubble {
            background: var(--bubble-sent);
            border-radius: 8px 0 8px 8px;
        }

        .message.received .message-bubble {
            border-radius: 0 8px 8px 8px;
        }

        .message-sender {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 3px;
        }

        .message-text {
            font-size: var(--font-size);
            color: var(--text-primary);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message-text a {
            color: #53bdeb;
            text-decoration: underline;
        }

        .message-text.deleted {
            font-style: italic;
            color: #8696a0;
            font-size: 13px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
        }

        .reply-preview {
            background: rgba(0, 168, 132, 0.15);
            border-left: 3px solid var(--accent);
            padding: 5px 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .reply-name {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 12px;
        }

        .reply-text {
            color: var(--text-secondary);
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-reactions {
            display: flex;
            gap: 3px;
            margin-top: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 5px 0;
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .context-menu-item:hover {
            background: var(--bg-input);
        }

        .context-menu-item.delete {
            color: #dc3545;
        }

        .copy-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            font-size: 14px;
            animation: slideDown 0.3s ease;
        }

        .copy-toast.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .reaction-viewer-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .reaction-viewer-title {
            font-size: 16px;
            font-weight: 600;
        }

        .reaction-viewer-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
        }

        .reaction-viewer-content {
            padding: 10px;
        }

        .reaction-group {
            margin-bottom: 15px;
        }

        .reaction-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .reaction-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
        }

        .reaction-user:hover {
            background: var(--bg-input);
        }

        .reaction-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .reaction-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .members-sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: var(--bg-secondary);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            z-index: 200;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .members-sidebar.active {
            left: 0;
        }

        .members-header {
            background: var(--header-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .members-header h3 {
            color: var(--header-text);
            font-size: 18px;
        }

        .members-close {
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 24px;
            cursor: pointer;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 10px 50px 10px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .member-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .input-area {
            background: var(--bg-secondary);
            padding: 8px 10px;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            flex-shrink: 0;
            flex-direction: column;
        }

        .reply-bar {
            background: var(--bg-input);
            padding: 8px 12px;
            display: none;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid var(--accent);
            width: 100%;
            border-radius: 8px;
        }

        .reply-bar.active {
            display: flex;
        }

        .input-row {
            display: flex;
            gap: 8px;
            width: 100%;
            align-items: center;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            background: var(--bg-input);
            border-radius: 25px;
            padding: 8px 12px;
            align-items: center;
            gap: 8px;
            max-height: 150px;
        }

        .user-avatar-input {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            cursor: pointer;
            overflow: hidden;
        }

        .user-avatar-input img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 2px solid var(--accent);
            border-radius: 50%;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
        }

        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        .profile-page {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-primary);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            z-index: 100;
            overflow-y: auto;
        }

        .profile-page.active {
            display: flex;
        }

        .profile-header {
            background: var(--header-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--header-text);
            font-size: 24px;
            cursor: pointer;
        }

        .profile-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 40px 20px;
        }

        .profile-section {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .wallpaper-upload {
            margin-bottom: 15px;
        }

        .upload-wallpaper-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .wallpaper-item {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .wallpaper-item.active {
            border-color: var(--accent);
        }

        .wallpaper-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .font-size-btn {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
        }

        .font-size-value {
            font-size: 16px;
            color: var(--text-primary);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .message-content {
                max-width: 85%;
            }

            .messages-area {
                padding-bottom: 120px;
            }

            .emoji-picker {
                max-width: 90%;
            }
        }

        @media (max-width: 580px) {
            .messages-area {
                padding-bottom: 130px;
            }
        }

        @media (max-width: 480px) {
            .messages-area {
                padding-bottom: 120px;
            }
        }
    </style>
</head>

<body data-theme="dark">

    <!-- Device Warning -->
    <div id="deviceWarning" class="device-warning">
        <div class="warning-icon">üì±</div>
        <div class="warning-title">Mobile Only</div>
        <div class="warning-text">This project is only for mobile devices.</div>
    </div>

    <!-- Loader -->
    <div id="loaderContainer" class="loader-container hidden">
        <div class="loader"></div>
        <div class="loader-text">Verifying account...</div>
    </div>

    <!-- Signup Page -->
    <div id="signupPage" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <h1>üìö Class Group Chat</h1>
                <p>Create your account</p>
            </div>
            <form id="signupForm">
                <div class="profile-upload">
                    <div class="profile-preview" id="signupPhotoPreview">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                    </div>
                    <input type="file" id="signupPhotoInput" accept="image/*" style="display: none;">
                    <button type="button" class="upload-btn"
                        onclick="document.getElementById('signupPhotoInput').click()">Upload Photo</button>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signupName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="signupPhone" required>
                </div>
                <div class="form-group">
                    <label>Security Code</label>
                    <input type="text" id="signupCode" required placeholder="Enter class code">
                </div>

                <!-- Fingerprint Section -->
                <div class="fingerprint-section">
                    <button type="button" class="fingerprint-button" id="fingerprintBtn" onclick="scanFingerprint()">
                        <svg viewBox="0 0 24 24">
                            <path fill="white"
                                d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94 1.7 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z" />
                        </svg>
                    </button>
                    <div class="fingerprint-status" id="fingerprintStatus">Tap to scan fingerprint</div>
                </div>

                <button type="submit" class="btn-primary" id="signupBtn" disabled>Sign Up</button>
            </form>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <div class="header-left" onclick="toggleMembersSidebar()">
                <div class="group-avatar">CG</div>
                <div class="group-info">
                    <h2>Class Group</h2>
                    <p id="onlineCount">Loading...</p>
                </div>
            </div>
            <div class="header-right">
                <div class="theme-toggle" onclick="toggleTheme()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </div>
                <div class="profile-icon" onclick="showProfile()">
                    <img id="headerProfilePhoto" src="" alt="Profile">
                </div>
            </div>
        </div>

        <div class="messages-area" id="messagesArea">
            <div class="loading">Loading messages...</div>
        </div>

        <div class="input-area">
            <div class="reply-bar" id="replyBar">
                <div>
                    <div class="reply-name" id="replyName"></div>
                    <div class="reply-text" id="replyText"></div>
                </div>
                <button onclick="cancelReply()"
                    style="background:none;border:none;color:var(--text-primary);cursor:pointer;">‚úï</button>
            </div>
            <div class="input-row">
                <div class="input-wrapper">
                    <div class="user-avatar-input" onclick="showProfile()">
                        <img id="inputProfilePhoto" src="" alt="You">
                    </div>
                    <textarea id="messageInput" placeholder="Type a message" rows="1"></textarea>
                </div>
                <button class="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Members Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMembersSidebar()"></div>
    <div class="members-sidebar" id="membersSidebar">
        <div class="members-header">
            <h3>Class Members</h3>
            <button class="members-close" onclick="toggleMembersSidebar()">√ó</button>
        </div>
        <div class="members-list" id="membersList">
            <div class="loading">Loading members...</div>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="profile-page">
        <div class="profile-header">
            <button class="back-btn" onclick="hideProfile()">‚Üê</button>
            <h2 style="color: var(--header-text);">Profile</h2>
        </div>
        <div class="profile-content">
            <div class="profile-section">
                <div style="text-align:center;padding:20px 0;">
                    <div
                        style="width:150px;height:150px;border-radius:50%;margin:0 auto 20px;overflow:hidden;border:4px solid var(--accent);">
                        <img id="profilePhotoLarge" src="" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <input type="file" id="profilePhotoUpdate" accept="image/*" style="display:none;">
                    <button class="upload-btn" onclick="document.getElementById('profilePhotoUpdate').click()">Change
                        Photo</button>
                </div>
            </div>

            <div class="profile-section">
                <div style="padding:15px 0;border-bottom:1px solid var(--border-color);">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Name</div>
                    <div id="profileName" style="font-size:16px;">-</div>
                </div>
                <div style="padding:15px 0;border-bottom:1px solid var(--border-color);">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Email</div>
                    <div id="profileEmail" style="font-size:16px;">-</div>
                </div>
                <div style="padding:15px 0;">
                    <div style="font-size:13px;color:var(--text-secondary);margin-bottom:5px;">Phone</div>
                    <div id="profilePhone" style="font-size:16px;">-</div>
                </div>
            </div>

            <div class="profile-section">
                <div class="section-title">Chat Wallpaper</div>
                <div class="wallpaper-upload">
                    <input type="file" id="customWallpaperInput" accept="image/*" style="display:none;">
                    <button class="upload-wallpaper-btn"
                        onclick="document.getElementById('customWallpaperInput').click()">Upload Custom
                        Wallpaper</button>
                </div>
                <div class="wallpaper-grid" id="wallpaperGrid"></div>
            </div>

            <div class="profile-section">
                <div class="section-title">Font Size</div>
                <div class="font-size-control">
                    <button class="font-size-btn" onclick="changeFontSize(-1)">A-</button>
                    <span class="font-size-value" id="fontSizeDisplay">14px</span>
                    <button class="font-size-btn" onclick="changeFontSize(1)">A+</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="copyMessage()">
            <span>üìã</span> Copy
        </div>
        <div class="context-menu-item" onclick="replyMessage()">
            <span>‚Ü©Ô∏è</span> Reply
        </div>
        <div class="context-menu-item delete" onclick="deleteMessage()" id="deleteOption" style="display: none; opacity: 0; visibility: hidden;">
            <span>üóëÔ∏è</span> Delete
        </div>
    </div>

    <!-- Copy Toast -->
    <div id="copyToast" class="copy-toast">
        ‚úÖ Message copied
    </div>

    <script>
        // ============ CONFIGURATION ============
        const SECURITY_CODE = "Salik@Weber";
        const SAD_URL = "https://script.google.com/macros/s/AKfycbz9a50o7sLDbxLLAJSlh5T13zQ5YenRU5uTJpItKypaDPQdxY9oZcjFjlF9vIPk9uON/exec";
        const SMD_URL = "https://script.google.com/macros/s/AKfycbyoDtFkQztJn6RY0KhMeL7S_mRjwtq9MTrh3nywYRFB4n5Oa5ft4JsVcpg_5gluHCtp/exec";
        const MAX_CUSTOM_WALLPAPERS = 5;

        // ============ WALLPAPERS ============
        const WALLPAPERS = [
            { name: 'Dark Abstract', url: 'https://images.unsplash.com/photo-1557683311-eac922347aa1?w=800&q=80' },
            { name: 'Blue Wave', url: 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=800&q=80' },
            { name: 'Purple Space', url: 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=800&q=80' },
            { name: 'Dark Mountains', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80' },
            { name: 'Neon Lights', url: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=800&q=80' },
            { name: 'Ocean Blue', url: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=800&q=80' },
            { name: 'Galaxy Stars', url: 'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=800&q=80' },
            { name: 'Sunset Sky', url: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80' },
            { name: 'Forest Green', url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=800&q=80' },
            { name: 'Pink Clouds', url: 'https://images.unsplash.com/photo-1557672172-298e090bd0f1?w=800&q=80' },
            { name: 'Aurora Night', url: 'https://images.unsplash.com/photo-1531366936337-7c912a4589a7?w=800&q=80' },
            { name: 'Desert Sand', url: 'https://images.unsplash.com/photo-1509316785289-025f5b846b35?w=800&q=80' },
            { name: 'Lavender Dream', url: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=800&q=80' },
            { name: 'Starry Night', url: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=800&q=80' },
            { name: 'Cherry Blossom', url: 'https://images.unsplash.com/photo-1522383225653-ed111181a951?w=800&q=80' },
            { name: 'Tropical Beach', url: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=800&q=80' },
            { name: 'Mountain Lake', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80' },
            { name: 'Colorful Smoke', url: 'https://images.unsplash.com/photo-1553356084-58ef4a67b2a7?w=800&q=80' },
            { name: 'Autumn Leaves', url: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800&q=80' },
            { name: 'Deep Ocean', url: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=800&q=80' }
        ];

        // ============ STATE MANAGEMENT ============
        let currentUser = null;
        let refreshInterval = null;
        let selectedMessage = null;
        let replyToMessage = null;
        let lastMessageCount = 0;
        let isSending = false;
        let allUsers = {};
        let currentMessages = [];
        let fingerprintVerified = false;
        let lastScrollPosition = 0;
        let customWallpaperCount = 0;

        // ============ EMOJIS ============
        const REACTION_EMOJIS = ['‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üôè', 'üëç', 'üëé', 'üî•', 'üéâ', 'üòç', 'üò°', 'üíØ', '‚úÖ', '‚ùå'];

        // ============ DEVICE CHECK ============
        function checkDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const currentHost = window.location.hostname;

            // Allow localhost/127.0.0.1 to bypass device check
            if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                return true;
            }

            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const isTablet = /ipad|android/i.test(userAgent) && !/mobile/i.test(userAgent);
            const screenWidth = window.innerWidth;

            if (!isMobile || isTablet || screenWidth > 768) {
                document.getElementById('deviceWarning').classList.add('active');
                return false;
            }
            return true;
        }

        // ============ FINGERPRINT BIOMETRIC AUTHENTICATION ============
        async function scanFingerprint() {
            const btn = document.getElementById('fingerprintBtn');
            const status = document.getElementById('fingerprintStatus');
            const signupBtn = document.getElementById('signupBtn');

            btn.disabled = true;
            status.textContent = 'Scanning fingerprint...';
            btn.style.transform = 'scale(0.95)';

            try {
                if (window.PublicKeyCredential) {
                    const challenge = new Uint8Array(32);
                    crypto.getRandomValues(challenge);

                    await navigator.credentials.create({
                        publicKey: {
                            challenge,
                            rp: { name: "Class Group Chat" },
                            user: {
                                id: new Uint8Array(16),
                                name: "student@classgroup.com",
                                displayName: "Student"
                            },
                            pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                            authenticatorSelection: {
                                authenticatorAttachment: "platform",
                                userVerification: "required"
                            },
                            timeout: 60000,
                            attestation: "none"
                        }
                    });
                }

                // ‚úÖ Success
                status.textContent = '‚úÖ Fingerprint verified';
                status.style.color = 'var(--accent)';
                fingerprintVerified = true;
                signupBtn.disabled = false;
                btn.style.background = 'linear-gradient(135deg, #00d9a8 0%, var(--accent) 100%)';
            } catch (err) {
                console.warn('Biometric not available, fallback simulation');
                await new Promise(res => setTimeout(res, 1000));
                status.textContent = '‚úÖ Fingerprint verified (simulated)';
                status.style.color = 'var(--accent)';
                fingerprintVerified = true;
                signupBtn.disabled = false;
            } finally {
                btn.style.transform = 'scale(1)';
                btn.disabled = false;
            }
        }


        // ============ INITIALIZATION ============
        window.onload = function () {
            if (!checkDevice()) return;
            applySettings();
            setupEventListeners();
            checkAuth();
            setInterval(recheckUserStatus, 5000); // har 5 sec me verify karega
            fetchMessages(); // üü¢ first load
            setInterval(fetchMessages, 2000);
            loadCustomWallpaperCount();
        };

        // üîÅ Every 3 seconds recheck active/block status live
        setInterval(async () => {
            const userDataString = localStorage.getItem('chatUser');
            const isBlocked = localStorage.getItem('blockedUser');
            if (!userDataString) return;

            const userData = JSON.parse(userDataString);

            try {
                const verifyUrl = `${SAD_URL}?action=verifyUser&name=${encodeURIComponent(userData.name)}&email=${encodeURIComponent(userData.email)}&phone=${encodeURIComponent(userData.phone)}&t=${Date.now()}`;
                const res = await fetch(verifyUrl);
                const data = await res.json();

                // ‚úÖ Active ‚Üí continue chat normally
                if (data.status === 'active') {
                    if (isBlocked === 'true') {
                        // Unblocked recently ‚Äî refresh chat instantly
                        localStorage.removeItem('blockedUser');
                        location.reload();
                    }
                    return;
                }

                // ‚ùå Blocked ‚Üí show immediately
                if (data.status === 'blocked' && isBlocked !== 'true') {
                    localStorage.setItem('blockedUser', 'true');
                    document.body.innerHTML = `
        <div style="
          background:#111;
          color:#ff4c4c;
          font-size:20px;
          display:flex;
          align-items:center;
          justify-content:center;
          height:100vh;
          text-align:center;
          flex-direction:column;
        ">
          <div style="font-size:80px;">‚õî</div>
          <p><strong>You are Blocked by Admin</strong></p>
        </div>`;
                }
            } catch (err) {
                console.error('Live check error:', err);
            }
        }, 3000);


        async function checkAuth() {
            try {
                const userDataString = localStorage.getItem('chatUser');

                // üîπ Agar localStorage hi nahi hai ‚Üí show signup
                if (!userDataString) {
                    console.log("No local data found ‚Üí show signup");
                    showSignup();
                    return;
                }

                const userData = JSON.parse(userDataString);
                if (!userData.name || !userData.email || !userData.phone) {
                    console.log("Incomplete local data ‚Üí show signup");
                    showSignup();
                    return;
                }

                showLoader();

                // üîπ Verify from Sheet
                const verifyUrl = `${SAD_URL}?action=verifyUser&name=${encodeURIComponent(userData.name)}&email=${encodeURIComponent(userData.email.toLowerCase())}&phone=${encodeURIComponent(userData.phone)}&t=${Date.now()}`;
                const res = await fetch(verifyUrl);
                const data = await res.json();

                console.log("Verification response:", data);
                hideLoader();

                // üî¥ If student blocked ‚Üí don‚Äôt delete localStorage, just mark blocked
                if (data.status === 'blocked') {
                    localStorage.setItem('blockedUser', 'true'); // save flag
                    document.body.innerHTML = `
        <div style="
          background:#111;
          color:#ff4c4c;
          font-size:20px;
          display:flex;
          align-items:center;
          justify-content:center;
          height:100vh;
          text-align:center;
          flex-direction:column;
        ">
          <div style="font-size:80px;">‚õî</div>
          <p><strong>You are Blocked by Admin</strong></p>
        </div>`;
                    return;
                }

                // ‚úÖ If active ‚Üí remove block flag & open chat
                localStorage.removeItem('blockedUser');
                currentUser = userData;
                showChat();
                loadWallpapers();
                startMessageRefresh();
                loadOnlineCount();

            } catch (err) {
                console.error("checkAuth Error:", err);
                hideLoader();
                showSignup();
            }
        }


        // üîÅ Every 5 seconds check if user unblocked by admin
        setInterval(async () => {
            const isBlocked = localStorage.getItem('blockedUser');
            if (isBlocked === 'true') {
                const userDataString = localStorage.getItem('chatUser');
                if (!userDataString) return;
                const userData = JSON.parse(userDataString);
                const verifyUrl = `${SAD_URL}?action=verifyUser&name=${encodeURIComponent(userData.name)}&email=${encodeURIComponent(userData.email)}&phone=${encodeURIComponent(userData.phone)}&t=${Date.now()}`;
                const res = await fetch(verifyUrl);
                const data = await res.json();
                if (data.status === 'active') {
                    // ‚úÖ Unblocked ‚Üí reopen chat
                    localStorage.removeItem('blockedUser');
                    location.reload(); // refresh & open chat
                }
            }
        }, 5000);


        async function verifyAccountStatus(userData) {
            try {
                const response = await fetch(`${SAD_URL}?action=checkStatus&email=${encodeURIComponent(userData.email)}&t=${Date.now()}`);
                const data = await response.json();

                if (data.success && data.status) {
                    // Check if status is active (‚úÖ) or blocked (‚ùå)
                    return data.status === '‚úÖ' || data.status === 'active' || data.status === '‚úîÔ∏è';
                }

                return true;
            } catch (error) {
                console.error('Status check error:', error);
                return true;
            }
        }

        function showLoader() {
            document.getElementById('loaderContainer').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loaderContainer').classList.add('hidden');
        }

        async function loadOnlineCount() {
            try {
                const response = await fetch(`${SAD_URL}?action=getOnlineCount&t=${Date.now()}`);
                const data = await response.json();
                if (data.success) {
                    const count = data.count || 0;
                    document.getElementById('onlineCount').textContent = `${count} members`;
                }
            } catch (error) {
                document.getElementById('onlineCount').textContent = 'Group';
            }
        }

        function setupEventListeners() {
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('signupPhotoInput').addEventListener('change', previewSignupPhoto);
            document.getElementById('messageInput').addEventListener('input', autoResize);
            document.getElementById('messageInput').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    // Allow Enter key for line breaks
                    return true;
                }
            });
            document.getElementById('profilePhotoUpdate').addEventListener('change', updateProfilePhoto);
            document.getElementById('customWallpaperInput').addEventListener('change', uploadCustomWallpaper);

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.context-menu') && !e.target.closest('.message-bubble')) {
                    hideContextMenu();
                }
            });

            // Scroll event for date badge visibility
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.addEventListener('scroll', handleScroll);

        }

        function handleScroll() {
            const messagesArea = document.getElementById('messagesArea');
            const currentScroll = messagesArea.scrollTop;
            const dateBadges = document.querySelectorAll('.message-date');

            dateBadges.forEach((badge, index) => {
                const rect = badge.getBoundingClientRect();
                const messagesRect = messagesArea.getBoundingClientRect();

                // Hide "Today" badge if not at top
                if (badge.querySelector('.date-badge').textContent === 'Today') {
                    if (currentScroll > 100) {
                        badge.style.display = 'none';
                    } else {
                        badge.style.display = 'block';
                    }
                }

                // Show/hide other date badges based on scroll position
                if (rect.top >= messagesRect.top && rect.top <= messagesRect.top + 100) {
                    badge.style.display = 'block';
                }
            });

            lastScrollPosition = currentScroll;
        }

        function autoResize() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }


        // ============ PHOTO PREVIEW ============
        function previewSignupPhoto(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    document.getElementById('signupPhotoPreview').innerHTML = `<img src="${event.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // ============ SIGNUP WITH FINGERPRINT + ACTIVE STATUS ============
        async function handleSignup(e) {
            e.preventDefault();

            if (!fingerprintVerified) {
                alert('‚ùå Please scan your fingerprint first!');
                return;
            }

            const code = document.getElementById('signupCode').value.trim();
            if (code !== SECURITY_CODE) {
                alert('‚ùå Invalid security code!');
                return;
            }

            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const phone = document.getElementById('signupPhone').value.trim();

            if (!name || name.length < 2) return alert('‚ùå Please enter a valid name!');
            if (!email.includes('@') || !email.endsWith('gmail.com')) return alert('‚ùå Please use a valid Gmail!');
            if (!/^\d{10}$/.test(phone)) return alert('‚ùå Please enter valid 10-digit phone!');

            const photoFile = document.getElementById('signupPhotoInput').files[0];
            if (!photoFile) return alert('‚ùå Please upload a profile photo!');

            const btn = document.getElementById('signupBtn');
            btn.textContent = 'Checking account...';
            btn.disabled = true;

            try {
                // Check for duplicates first
                const checkResponse = await fetch(`${SAD_URL}?action=checkDuplicate&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}&t=${Date.now()}`);
                const checkData = await checkResponse.json();

                if (checkData.exists === true) {
                    alert(`‚ùå This ${checkData.field} already exists!`);
                    btn.textContent = 'Sign Up';
                    btn.disabled = false;
                    return;
                }

                btn.textContent = 'Creating account...';
                const photoBase64 = await fileToBase64(photoFile);

                const signupData = {
                    action: 'signup',
                    name,
                    email,
                    phone,
                    status: '‚úÖ' // ‚úÖ force add this line
                };

                await fetch(SAD_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(signupData)
                });

                await new Promise(res => setTimeout(res, 1000));

                // ‚úÖ Save with status locally
                currentUser = { name, email, phone, status: '‚úÖ', photo: photoBase64, timestamp: new Date().toISOString() };
                localStorage.setItem('chatUser', JSON.stringify(currentUser));

                alert('‚úÖ Account created successfully!\nWelcome to Class Group Chat!');
                showChat();
                loadWallpapers();
                startMessageRefresh();
                loadOnlineCount();
            } catch (error) {
                console.error('Signup error:', error);
                alert('‚ùå Error creating account: ' + error.message);
            } finally {
                btn.textContent = 'Sign Up';
                btn.disabled = false;
            }
        }


        // ============ SEND MESSAGE (INSTANT DISPLAY) ============
        async function sendMessage() {
            const msgInput = document.getElementById('messageInput');
            const messageText = msgInput.value.trim();

            if (!messageText) return;
            if (isSending) return;

            isSending = true;
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.disabled = true;

            try {
                // ‚úÖ STEP 1: Instantly show in chatbox (optimistic update)
                const msgTimestamp = new Date();
                const tempMessage = {
                    studentName: currentUser.name,
                    message: messageText,
                    timestamp: msgTimestamp.toISOString(),
                    replyTo: replyToMessage ? `${replyToMessage.sender}|||${replyToMessage.text}` : ''
                };

                // Add to display immediately
                const messagesArea = document.getElementById('messagesArea');
                const messageDiv = createMessageElement(tempMessage, currentMessages.length);
                messagesArea.appendChild(messageDiv);

                // Clear input aur reply bar
                msgInput.value = '';
                msgInput.style.height = 'auto';
                if (replyToMessage) {
                    cancelReply();
                }

                // Scroll to bottom
                scrollToBottom();

                // ‚úÖ STEP 2: Save to Google Sheets (background me)
                const messageData = {
                    action: 'saveMessage',
                    studentName: currentUser.name,
                    message: messageText,
                    timestamp: msgTimestamp.toISOString(),
                    replyTo: replyToMessage ? `${replyToMessage.sender}|||${replyToMessage.text}` : ''
                };

                // Fire and forget - don't wait
                fetch(SMD_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(messageData)
                }).then(res => res.json())
                    .then(data => {
                        console.log('Message saved to sheet:', data);
                    })
                    .catch(err => console.error('Save error:', err));

                // ‚úÖ STEP 3: After 1 second, fetch all messages to sync
                // (This will show other students' messages aur filter out duplicates)
                setTimeout(() => {
                    fetchMessagesWithFilter();
                }, 1000);

            } catch (err) {
                console.error('Send error:', err);
                alert('Error: ' + err.message);
            } finally {
                isSending = false;
                sendBtn.disabled = false;
            }
        }

        // ============ FETCH MESSAGES WITH FILTER ============
        async function fetchMessagesWithFilter() {
            try {
                const res = await fetch(`${SMD_URL}?action=fetchMessages&t=${Date.now()}`);
                const result = await res.json();
                const messages = result.messages || result.data || [];

                if (!Array.isArray(messages)) return;

                currentMessages = messages;

                const messagesArea = document.getElementById('messagesArea');
                const myName = currentUser.name.toLowerCase().trim();

                // Clear existing messages
                messagesArea.innerHTML = '';
                let currentDate = '';

                messages.forEach((msg, index) => {
                    if (!msg.studentName || !msg.message) return;

                    // Add date badge if needed
                    const msgDate = new Date(msg.timestamp);
                    const dateStr = formatDate(msgDate);

                    if (dateStr !== currentDate) {
                        currentDate = dateStr;
                        const dateBadge = document.createElement('div');
                        dateBadge.className = 'message-date';
                        dateBadge.innerHTML = `<span class="date-badge">${dateStr}</span>`;
                        messagesArea.appendChild(dateBadge);
                    }

                    const messageDiv = createMessageElement(msg, index);
                    messagesArea.appendChild(messageDiv);
                });

                scrollToBottom();

            } catch (err) {
                console.error('Fetch error:', err);
            }
        }

        // ============ MESSAGE REFRESH (BACKGROUND) ============
        function startMessageRefresh() {
            fetchMessagesWithFilter(); // Initial load

            if (refreshInterval) clearInterval(refreshInterval);

            refreshInterval = setInterval(async () => {
                if (currentUser) {
                    const isActive = await verifyAccountStatus(currentUser);
                    if (!isActive) {
                        alert('Your account has been blocked by Admin');
                        localStorage.removeItem('chatUser');
                        clearInterval(refreshInterval);
                        window.location.reload();
                        return;
                    }
                }
                fetchMessagesWithFilter(); // Refresh messages
                loadOnlineCount();
            }, 3000); // 3 seconds
        }
        // ============ SMART FETCH MESSAGES (NO BLINKING) ============
        let lastMessageIds = []; // Track which messages we've already shown

        async function fetchMessages() {
            try {
                const res = await fetch(`${SMD_URL}?action=fetchMessages&t=${Date.now()}`);
                const result = await res.json();

                const messages = result.messages || result.data || [];
                const messagesArea = document.getElementById("messagesArea");

                if (!messagesArea) return;

                if (!Array.isArray(messages) || messages.length === 0) {
                    if (messagesArea.innerHTML === '<div class="loading">No messages yet üí¨</div>') {
                        return; // Already showing, don't refresh
                    }
                    messagesArea.innerHTML = '<div class="loading">No messages yet üí¨</div>';
                    return;
                }

                // Store messages globally
                currentMessages = messages;

                // ‚úÖ SMART LOGIC: Sirf naye messages add karo, scroll mat karo
                const currentMessageCount = document.querySelectorAll('[data-index]').length;
                const newMessageCount = messages.length;

                // Agar same number of messages hain to mat reload karo
                if (currentMessageCount === newMessageCount) {
                    // Check if any message was modified (deleted/reacted)
                    const allBubbles = document.querySelectorAll('.message-bubble[data-index]');
                    let hasChanges = false;

                    allBubbles.forEach((bubble, i) => {
                        if (i < messages.length) {
                            const oldText = bubble.getAttribute('data-message');
                            const newText = messages[i].message;
                            if (oldText !== newText) {
                                hasChanges = true;
                            }
                        }
                    });

                    if (!hasChanges) {
                        return; // No new messages, no changes - don't refresh!
                    }
                }

                // ‚ö†Ô∏è If new messages exist, rebuild only once
                if (newMessageCount > currentMessageCount) {
                    const wasAtBottom = isScrolledToBottom();

                    // Remove old date badges first
                    document.querySelectorAll('.message-date').forEach(el => el.remove());

                    // Remove old messages
                    document.querySelectorAll('[data-index]').forEach(el => el.remove());

                    let currentDate = '';

                    messages.forEach((msg, index) => {
                        if (!msg.studentName || !msg.message) return;

                        // Add date badge if needed
                        const msgDate = new Date(msg.timestamp);
                        const dateStr = formatDate(msgDate);

                        if (dateStr !== currentDate) {
                            currentDate = dateStr;
                            const dateBadge = document.createElement('div');
                            dateBadge.className = 'message-date';
                            dateBadge.innerHTML = `<span class="date-badge">${dateStr}</span>`;
                            messagesArea.appendChild(dateBadge);
                        }

                        const messageDiv = createMessageElement(msg, index);
                        messagesArea.appendChild(messageDiv);
                    });

                    // Only scroll if was at bottom
                    if (wasAtBottom) {
                        scrollToBottom();
                    }

                    lastMessageCount = newMessageCount;
                }

            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        // ============ MESSAGE REFRESH ============
        function startMessageRefresh() {
            fetchMessages(); // Initial load

            if (refreshInterval) clearInterval(refreshInterval);

            // ‚úÖ Change to 3 seconds aur smarter logic
            refreshInterval = setInterval(async () => {
                if (currentUser) {
                    const isActive = await verifyAccountStatus(currentUser);
                    if (!isActive) {
                        alert('Your account has been blocked by Admin');
                        localStorage.removeItem('chatUser');
                        clearInterval(refreshInterval);
                        window.location.reload();
                        return;
                    }
                }
                fetchMessages(); // Smart fetch - sirf changes refresh hote hain
                loadOnlineCount();
            }, 3000); // 3 seconds - zyada smooth
        }




        // ============ DISPLAY MESSAGES ============
        function displayMessages(messages) {
            const container = document.getElementById('messagesArea');
            const wasAtBottom = isScrolledToBottom();
            const currentScroll = container.scrollTop;

            container.innerHTML = '';
            let currentDate = '';
            let todayBadgeShown = false;

            messages.forEach((msg, index) => {
                const msgDate = new Date(msg.timestamp);
                const dateStr = formatDate(msgDate);

                if (dateStr !== currentDate) {
                    currentDate = dateStr;
                    const dateBadge = document.createElement('div');
                    dateBadge.className = 'message-date';

                    // Hide "Today" badge if scrolled down
                    if (dateStr === 'Today' && currentScroll > 100) {
                        dateBadge.style.display = 'none';
                    }

                    dateBadge.innerHTML = `<span class="date-badge">${dateStr}</span>`;
                    container.appendChild(dateBadge);

                    if (dateStr === 'Today') todayBadgeShown = true;
                }

                const messageDiv = createMessageElement(msg, index);
                container.appendChild(messageDiv);
            });

            if (wasAtBottom || lastMessageCount === 0) {
                scrollToBottom();
            }

            lastMessageCount = messages.length;
        }

        function createMessageElement(msg, index) {
            const messageDiv = document.createElement('div');
            const isSent = msg.studentName.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
            const isDeleted = msg.message === '‚ùå';

            messageDiv.className = isSent ? 'message sent' : 'message received';
            messageDiv.setAttribute('data-index', index);
            messageDiv.setAttribute('data-message', msg.message);
            messageDiv.setAttribute('data-sender', msg.studentName);

            const msgDate = new Date(msg.timestamp);
            const time = msgDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const firstLetter = msg.studentName.charAt(0).toUpperCase();

            let replyHTML = '';
            if (msg.replyTo && msg.replyTo !== '' && msg.replyTo.includes('|||')) {
                try {
                    const replyParts = msg.replyTo.split('|||');
                    if (replyParts.length >= 2) {
                        const replySender = replyParts[0];
                        const replyText = replyParts[1];
                        const replyTextShort = replyText.length > 30 ? replyText.substring(0, 30) + '...' : replyText;
                        replyHTML = `
                    <div class="reply-preview">
                        <div class="reply-name">${escapeHtml(replySender)}</div>
                        <div class="reply-text">${escapeHtml(replyTextShort)}</div>
                    </div>
                `;
                    }
                } catch (e) {
                    console.error('Error parsing reply:', e);
                }
            }

            let reactionHTML = '';
            if (msg.reaction && msg.reaction !== '' && !msg.reaction.includes('üï∏')) {
                const reactions = parseReactions(msg.reaction);
                if (reactions.length > 0) {
                    reactionHTML = '<div class="message-reactions">';
                    reactions.forEach(r => {
                        reactionHTML += `<div class="reaction-item" onclick="event.stopPropagation(); showReactionDetails(${index}, '${r.emoji}')">
                    ${r.emoji} <span class="reaction-count">${r.count}</span>
                </div>`;
                    });
                    reactionHTML += '</div>';
                }
            }

            let avatarHTML = `<div class="message-avatar">${firstLetter}</div>`;
            const userPhoto = getUserPhoto(msg.studentName);
            if (userPhoto) {
                avatarHTML = `<div class="message-avatar"><img src="${userPhoto}" alt="${msg.studentName}"></div>`;
            }

            let messageTextHTML = '';
            if (isDeleted) {
                messageTextHTML = `<div class="message-text deleted">Deleted</div>`;
            } else {
                // Preserve line breaks and formatting
                const formattedText = msg.message.replace(/\n/g, '<br>');
                const textWithLinks = linkify(formattedText);
                messageTextHTML = `<div class="message-text">${textWithLinks}</div>`;
            }

            messageDiv.innerHTML = `
        <div class="message-content">
            ${avatarHTML}
            <div class="message-bubble" oncontextmenu="showContextMenu(event, ${index}); return false;" 
                 ontouchstart="handleTouchStart(event, ${index})" 
                 ontouchend="handleTouchEnd(event)"
                 ondblclick="replyMessageByIndex(${index})">
                ${!isSent ? `<div class="message-sender">${escapeHtml(msg.studentName)}</div>` : ''}
                ${replyHTML}
                ${messageTextHTML}
                <div class="message-time">${time}</div>
                ${reactionHTML}
            </div>
        </div>
    `;

            return messageDiv;
        }

        function linkify(text) {
            const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
        }

        function parseReactions(reactionString) {
            if (!reactionString || reactionString === '' || reactionString.includes('üï∏')) return [];

            const reactionMap = {};
            const parts = reactionString.split('|');

            parts.forEach(part => {
                if (part.includes(':') && !part.includes('üï∏')) {
                    const [user, emoji] = part.split(':');
                    if (emoji && emoji !== 'üï∏') {
                        reactionMap[emoji] = (reactionMap[emoji] || 0) + 1;
                    }
                }
            });

            return Object.entries(reactionMap).map(([emoji, count]) => ({ emoji, count }));
        }

        function showReactionDetails(messageIndex, emoji = null) {
            const msg = currentMessages[messageIndex];
            if (!msg || !msg.reaction || msg.reaction.includes('üï∏')) return;

            const viewer = document.getElementById('reactionViewer');
            const content = document.getElementById('reactionViewerContent');

            const reactionData = {};
            const parts = msg.reaction.split('|');

            parts.forEach(part => {
                if (part.includes(':') && !part.includes('üï∏')) {
                    const [user, reactionEmoji] = part.split(':');
                    if (reactionEmoji !== 'üï∏') {
                        if (!reactionData[reactionEmoji]) {
                            reactionData[reactionEmoji] = [];
                        }
                        reactionData[reactionEmoji].push(user);
                    }
                }
            });

            content.innerHTML = '';

            Object.entries(reactionData).forEach(([reactionEmoji, users]) => {
                if (emoji && emoji !== reactionEmoji) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'reaction-group';

                let html = `<div class="reaction-group-header">${reactionEmoji} ${users.length}</div>`;

                users.forEach(user => {
                    const firstLetter = user.charAt(0).toUpperCase();
                    const isCurrentUser = user.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
                    html += `
                <div class="reaction-user" ${isCurrentUser ? 'onclick="removeReaction(' + messageIndex + ', \'' + reactionEmoji + '\')"' : ''}>
                    <div class="reaction-user-avatar">${firstLetter}</div>
                    <div>${escapeHtml(user)}${isCurrentUser ? ' (Tap to remove)' : ''}</div>
                </div>
            `;
                });

                groupDiv.innerHTML = html;
                content.appendChild(groupDiv);
            });

            viewer.classList.add('active');
        }

        async function removeReaction(messageIndex, emoji) {
            try {
                const reactionData = {
                    action: 'removeReaction',
                    messageIndex: messageIndex,
                    emoji: emoji,
                    userName: currentUser.name
                };

                await fetch(SMD_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(reactionData)
                });

                hideReactionViewer();
                setTimeout(() => fetchMessages(), 200);

            } catch (error) {
                console.error('Remove reaction error:', error);
            }
        }

        function hideReactionViewer() {
            document.getElementById('reactionViewer').classList.remove('active');
        }

        function getUserPhoto(name) {
            if (name.trim().toLowerCase() === currentUser.name.trim().toLowerCase()) {
                return currentUser.photo;
            }
            return null;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();

            // Convert both to local midnight for comparison
            const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            if (msgDate.getTime() === today.getTime()) return 'Today';
            if (msgDate.getTime() === yesterday.getTime()) return 'Yesterday';
            return msgDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }


        function isScrolledToBottom() {
            const container = document.getElementById('messagesArea');
            return container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesArea');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        }

        // ============ CONTEXT MENU ============
        let touchTimer = null;

        function handleTouchStart(e, index) {
            touchTimer = setTimeout(() => {
                showContextMenu(e, index);
            }, 500);
        }

        function handleTouchEnd(e) {
            clearTimeout(touchTimer);
        }

        function showContextMenu(e, index) {
            e.preventDefault();
            const menu = document.getElementById('contextMenu');
            const deleteOption = document.getElementById('deleteOption');
            selectedMessage = index;

            const msgElement = document.querySelector(`[data-index="${index}"]`);
            if (msgElement) {
                const sender = msgElement.getAttribute('data-sender');
                const message = msgElement.getAttribute('data-message');
                const isOwnMessage = sender.trim().toLowerCase() === currentUser.name.trim().toLowerCase();
                const isDeleted = message === '‚ùå';

                deleteOption.style.display = (isOwnMessage && !isDeleted) ? 'flex' : 'none';
            }

            let x = e.pageX || (e.touches && e.touches[0] ? e.touches[0].pageX : 0);
            let y = e.pageY || (e.touches && e.touches[0] ? e.touches[0].pageY : 0);

            const menuWidth = 150;
            const menuHeight = 220;

            if (x + menuWidth > window.innerWidth) {
                x = window.innerWidth - menuWidth - 10;
            }
            if (x < 10) {
                x = 10;
            }

            if (y + menuHeight > window.innerHeight) {
                y = window.innerHeight - menuHeight - 10;
            }
            if (y < 10) {
                y = 10;
            }

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        // REPLACE WITH:
        function copyMessage() {
            const msgElement = document.querySelector(`[data-index="${selectedMessage}"]`);
            const text = msgElement.getAttribute('data-message');

            if (text === '‚ùå' || text === 'Deleted') {
                alert('Cannot copy deleted messages');
                hideContextMenu();
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                showCopyToast();
            }).catch(err => {
                console.error('Copy failed:', err);
            });
            hideContextMenu();
        }

        function showCopyToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        function replyMessage() {
            replyMessageByIndex(selectedMessage);
            hideContextMenu();
        }

        function replyMessageByIndex(index) {
            const msgElement = document.querySelector(`[data-index="${index}"]`);
            if (!msgElement) return;

            const sender = msgElement.getAttribute('data-sender');
            const text = msgElement.getAttribute('data-message');

            if (text === '‚ùå') return;

            replyToMessage = { sender, text };

            document.getElementById('replyName').textContent = sender;
            const displayText = text.length > 50 ? text.substring(0, 50) + '...' : text;
            document.getElementById('replyText').textContent = displayText;
            document.getElementById('replyBar').classList.add('active');
            document.getElementById('messageInput').focus();
        }

        function cancelReply() {
            replyToMessage = null;
            document.getElementById('replyBar').classList.remove('active');
        }



        async function deleteMessage() {
            if (!selectedMessage) return;

            const msgIndex = selectedMessage.getAttribute('data-index');
            const sender = selectedMessage.getAttribute('data-sender');

            if (!msgIndex) {
                alert("‚ö†Ô∏è Message index not found!");
                return;
            }

            if (sender.trim().toLowerCase() !== currentUser.name.trim().toLowerCase()) {
                alert("‚ùå You can only delete your own messages!");
                return;
            }

            if (!confirm("üóëÔ∏è Delete this message for everyone?")) return;

            try {
                const deleteData = {
                    action: "deleteMessage",
                    studentName: currentUser.name,
                    messageIndex: msgIndex
                };

                const res = await fetch(SMD_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(deleteData)
                });

                const result = await res.json();
                console.log("Delete Response:", result);

                if (result.success) {
                    // ‚úÖ Instantly refresh messages after delete
                    if (result.messages) {
                        currentMessages = result.messages;
                        displayMessages(result.messages);
                    } else {
                        // fallback: re-fetch manually
                        fetchMessagesWithFilter();
                    }
                    alert("‚úÖ Message deleted successfully!");
                } else {
                    alert("‚ùå " + result.message);
                }
            } catch (err) {
                console.error("Delete error:", err);
                alert("‚ö†Ô∏è Error deleting message: " + err.message);
            } finally {
                hideContextMenu();
            }
        }



        // ============ MEMBERS SIDEBAR ============
        async function toggleMembersSidebar() {
            const sidebar = document.getElementById('membersSidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                await loadMembers();
            }
        }

        async function loadMembers() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '<div class="loading">Loading members...</div>';

            try {
                const response = await fetch(`${SAD_URL}?action=getAllStudents&t=${Date.now()}`);
                const data = await response.json();

                if (!data.success || !data.students || data.students.length === 0) {
                    membersList.innerHTML = '<div class="loading">No members found</div>';
                    return;
                }

                document.getElementById('onlineCount').textContent = `${data.students.length} members`;

                membersList.innerHTML = '';

                data.students.forEach(student => {
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'member-item';

                    const firstLetter = student.name.charAt(0).toUpperCase();

                    memberDiv.innerHTML = `
                <div class="member-avatar">${firstLetter}</div>
                <div class="member-info">
                    <div class="member-name">${escapeHtml(student.name)}</div>
                </div>
            `;

                    membersList.appendChild(memberDiv);
                });

            } catch (error) {
                console.error('Error loading members:', error);
                membersList.innerHTML = '<div class="loading">Error loading members</div>';
            }
        }

        // ============ WALLPAPER ============
        function loadWallpapers() {
            const grid = document.getElementById('wallpaperGrid');
            grid.innerHTML = '';

            const noneItem = document.createElement('div');
            noneItem.className = 'wallpaper-item active';
            noneItem.onclick = () => setWallpaper('none', noneItem);
            noneItem.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            noneItem.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:white;font-size:16px;font-weight:bold;">None</div>';
            grid.appendChild(noneItem);

            WALLPAPERS.forEach(wallpaper => {
                const item = document.createElement('div');
                item.className = 'wallpaper-item';
                item.onclick = () => setWallpaper(wallpaper.url, item);
                item.innerHTML = `<img src="${wallpaper.url}" alt="${wallpaper.name}">`;
                grid.appendChild(item);
            });

            // Load custom wallpapers from localStorage
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');
            customWallpapers.forEach(wallpaperUrl => {
                const item = document.createElement('div');
                item.className = 'wallpaper-item';
                item.onclick = () => setWallpaper(wallpaperUrl, item);
                item.innerHTML = `<img src="${wallpaperUrl}" alt="Custom">`;
                grid.appendChild(item);
            });

            const savedWallpaper = localStorage.getItem('chatWallpaper');
            if (savedWallpaper && savedWallpaper !== 'none') {
                document.getElementById('messagesArea').style.backgroundImage = `url(${savedWallpaper})`;
            }
        }

        function loadCustomWallpaperCount() {
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');
            customWallpaperCount = customWallpapers.length;
        }

        function setWallpaper(url, element) {
            const messagesArea = document.getElementById('messagesArea');
            if (url === 'none') {
                messagesArea.style.backgroundImage = 'none';
                localStorage.setItem('chatWallpaper', 'none');
            } else {
                messagesArea.style.backgroundImage = `url(${url})`;
                localStorage.setItem('chatWallpaper', url);
            }

            document.querySelectorAll('.wallpaper-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
        }

        async function uploadCustomWallpaper(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Check if max custom wallpapers limit reached
            const customWallpapers = JSON.parse(localStorage.getItem('customWallpapers') || '[]');

            if (customWallpapers.length >= MAX_CUSTOM_WALLPAPERS) {
                alert(`‚ùå You cannot upload more wallpapers!\n\nMaximum limit: ${MAX_CUSTOM_WALLPAPERS} custom wallpapers`);
                e.target.value = ''; // Reset file input
                return;
            }

            try {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const customUrl = event.target.result;

                    // Save to localStorage
                    customWallpapers.push(customUrl);
                    localStorage.setItem('customWallpapers', JSON.stringify(customWallpapers));
                    customWallpaperCount = customWallpapers.length;

                    // Add to grid
                    const grid = document.getElementById('wallpaperGrid');
                    const customItem = document.createElement('div');
                    customItem.className = 'wallpaper-item';
                    customItem.onclick = () => setWallpaper(customUrl, customItem);
                    customItem.innerHTML = `<img src="${customUrl}" alt="Custom">`;
                    grid.appendChild(customItem);

                    // Set as active wallpaper
                    setWallpaper(customUrl, customItem);

                    alert(`‚úÖ Wallpaper uploaded successfully!\n\nCustom wallpapers: ${customWallpaperCount}/${MAX_CUSTOM_WALLPAPERS}`);
                };
                reader.readAsDataURL(file);
            } catch (error) {
                alert('‚ùå Error uploading wallpaper');
            }

            // Reset file input
            e.target.value = '';
        }

        // ============ FONT SIZE ============
        function changeFontSize(delta) {
            const root = document.documentElement;
            const current = parseInt(getComputedStyle(root).getPropertyValue('--font-size'));
            const newSize = Math.max(12, Math.min(20, current + delta));
            root.style.setProperty('--font-size', newSize + 'px');
            document.getElementById('fontSizeDisplay').textContent = newSize + 'px';
            localStorage.setItem('fontSize', newSize);
        }

        function applySettings() {
            const wallpaper = localStorage.getItem('chatWallpaper');
            if (wallpaper && wallpaper !== 'none') {
                document.getElementById('messagesArea').style.backgroundImage = `url(${wallpaper})`;
            }

            const fontSize = localStorage.getItem('fontSize');
            if (fontSize) {
                document.documentElement.style.setProperty('--font-size', fontSize + 'px');
                document.getElementById('fontSizeDisplay').textContent = fontSize + 'px';
            }

            const theme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', theme);
        }

        // ============ MESSAGE REFRESH ============
        function startMessageRefresh() {
            fetchMessages();
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(async () => {
                // Har refresh pe status check karo
                if (currentUser) {
                    const isActive = await verifyAccountStatus(currentUser);
                    if (!isActive) {
                        alert('‚ùå Your account has been blocked by Admin');
                        localStorage.removeItem('chatUser');
                        clearInterval(refreshInterval);
                        window.location.reload();
                        return;
                    }
                }
                fetchMessages();
                loadOnlineCount();
            }, 1000); // 1 seconds - blink nahi hoga
        }

        // ============ PROFILE FUNCTIONS ============
        function showProfile() {
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            chatContainer.classList.remove('active');
            chatContainer.style.display = 'none';
            profilePage.classList.add('active');
            profilePage.style.display = 'flex';

            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profilePhone').textContent = currentUser.phone;
            document.getElementById('profilePhotoLarge').src = currentUser.photo;
        }

        function hideProfile() {
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            profilePage.classList.remove('active');
            profilePage.style.display = 'none';
            chatContainer.classList.add('active');
            chatContainer.style.display = 'flex';
        }

        async function updateProfilePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const photoBase64 = await fileToBase64(file);
                currentUser.photo = photoBase64;
                localStorage.setItem('chatUser', JSON.stringify(currentUser));

                document.getElementById('profilePhotoLarge').src = photoBase64;
                document.getElementById('headerProfilePhoto').src = photoBase64;
                document.getElementById('inputProfilePhoto').src = photoBase64;

                alert('‚úÖ Profile photo updated!');
            } catch (error) {
                alert('‚ùå Error updating photo');
            }
        }

        // ============ LOGOUT ============
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('chatUser');
                currentUser = null;
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                document.getElementById('profilePage').classList.remove('active');
                document.getElementById('chatContainer').classList.remove('active');
                showSignup();
                fingerprintVerified = false;
                document.getElementById('fingerprintBtn').disabled = false;
                document.getElementById('fingerprintBtn').style.background = 'linear-gradient(135deg, var(--accent) 0%, #00d9a8 100%)';
                document.getElementById('fingerprintStatus').textContent = 'Tap to scan fingerprint';
                document.getElementById('fingerprintStatus').style.color = 'var(--text-secondary)';
                document.getElementById('signupBtn').disabled = true;
                document.getElementById('signupForm').reset();
                document.getElementById('signupPhotoPreview').innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        `;
            }
        }

        // ============ THEME TOGGLE ============
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // ============ PAGE NAVIGATION ============
        function showSignup() {
            const signupPage = document.getElementById('signupPage');
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            signupPage.style.display = 'flex';
            signupPage.classList.remove('hidden');
            chatContainer.classList.remove('active');
            chatContainer.style.display = 'none';
            profilePage.classList.remove('active');
            profilePage.style.display = 'none';
        }

        function showChat() {
            const signupPage = document.getElementById('signupPage');
            const chatContainer = document.getElementById('chatContainer');
            const profilePage = document.getElementById('profilePage');

            signupPage.style.display = 'none';
            signupPage.classList.add('hidden');
            chatContainer.classList.add('active');
            chatContainer.style.display = 'flex';
            profilePage.classList.remove('active');
            profilePage.style.display = 'none';

            if (currentUser && currentUser.photo) {
                document.getElementById('headerProfilePhoto').src = currentUser.photo;
                document.getElementById('inputProfilePhoto').src = currentUser.photo;
            }
        }

        // ============ HELPER FUNCTIONS ============
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 200;

                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById("contextMenuDelete").onclick = deleteMessage;

    </script>
</body>

</html>
